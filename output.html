<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Penjual: Pesanan & Produk & Supplier</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primaryGreen: '#4CAF50',
                        darkGreen: '#388E3C',
                        lightGreen: '#8BC34A',
                        textDark: '#333',
                        textLight: '#777',
                        borderColor: '#ddd',
                        bgLight: '#f4f7f6',
                        cardBg: '#ffffff',
                    }
                }
            }
        }
    </script>
    <!-- Firebase SDK v9 Compatibility -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        /* Custom styles for autocomplete-active as Tailwind doesn't have direct :active for JS-controlled classes */
        .autocomplete-active {
            background-color: #e9e9e9;
        }
    </style>
</head>
<body class="font-sans bg-gray-100 text-gray-800 flex flex-col justify-start min-h-screen items-center">
    <header class="bg-gradient-to-br from-green-600 to-green-400 text-white px-5 py-4 shadow-md rounded-b-3xl flex justify-between items-center mb-5 flex-shrink-0 max-w-4xl w-full box-border">
        <h1 class="text-xl m-0 flex items-center font-semibold">
            <i class="fas fa-leaf mr-2 text-2xl"></i> RUJAK BUAH INDONESIA
        </h1>
        <button onclick="logout()" class="bg-white/20 text-white border border-white/40 px-4 py-2 rounded cursor-pointer text-sm transition-all duration-300 flex items-center gap-1 whitespace-nowrap hover:bg-white/30 hover:border-white/60">
            <i class="fas fa-sign-out-alt"></i> Logout
        </button>
    </header>

    <div class="main-container w-full max-w-4xl flex flex-col gap-5 p-5 box-border flex-grow mx-auto md:flex-row md:items-start">
        <!-- Panel Kiri: Input Pesanan ke Supplier -->
        <div class="panel bg-white p-6 rounded-xl shadow-lg box-border md:flex-1 md:min-w-[450px]">
            <h2 class="text-center text-green-600 mb-6 text-2xl font-semibold">Buat Pesanan ke Supplier</h2>

            <div class="form-group mb-4">
                <label for="supplierNameOrderInput" class="block text-xs text-gray-700 mb-1 font-medium">Nama Supplier:</label>
                <div class="autocomplete relative flex items-center">
                    <input type="text" id="supplierNameOrderInput" placeholder="Cari atau masukkan nama supplier" autocomplete="off" class="w-full p-2 my-1 text-base rounded-md border border-gray-300 box-border flex-grow mr-1">
                    <!-- Autocomplete list will be appended here dynamically -->
                    <div id="supplierNameOrderAutocompleteList" class="autocomplete-items absolute border border-gray-300 bg-white z-50 top-full left-0 right-0 max-h-[150px] overflow-y-auto rounded-md shadow-md"></div>
                    <span class="material-icons dropdown-arrow-icon cursor-pointer text-gray-500 text-2xl transition-colors duration-200 hover:text-green-600" id="supplierDropdownArrow">arrow_drop_down</span>
                </div>
            </div>
            
            <div class="supplier-info text-center mb-5 text-lg text-gray-600 font-bold min-h-[25px]" id="supplierInfo">Pilih supplier untuk memulai pesanan.</div>

            <div class="form-group mb-4">
                <label for="productNameInput" class="block text-xs text-gray-700 mb-1 font-medium">Nama Produk:</label>
                <div class="autocomplete relative flex items-center">
                    <input type="text" id="productNameInput" placeholder="Cari atau masukkan nama produk" autocomplete="off" class="w-full p-2 my-1 text-base rounded-md border border-gray-300 box-border">
                    <!-- Autocomplete list will be appended here dynamically -->
                    <div id="productNameAutocompleteList" class="autocomplete-items absolute border border-gray-300 bg-white z-50 top-full left-0 right-0 max-h-[150px] overflow-y-auto rounded-md shadow-md"></div>
                </div>
            </div>
            <div class="form-group mb-4">
                <label for="quantityInput" class="block text-xs text-gray-700 mb-1 font-medium">Jumlah:</label>
                <input type="text" id="quantityInput" placeholder="Contoh: 5 KG, 10 Buah" class="w-full p-2 my-1 text-base rounded-md border border-gray-300 box-border">
            </div>
            <div class="button-group flex justify-center gap-3 mt-5 flex-wrap">
                <button id="tambahProdukBtn" disabled class="px-5 py-2 rounded-lg text-base font-semibold cursor-pointer transition-all duration-300 shadow-md bg-green-600 text-white hover:bg-green-700 hover:-translate-y-0.5 disabled:bg-gray-400 disabled:cursor-not-allowed disabled:transform-none">Tambah ke Daftar</button>
                <button id="clearAllBtn" disabled class="px-5 py-2 rounded-lg text-base font-semibold cursor-pointer transition-all duration-300 shadow-md bg-red-500 text-white hover:bg-red-600 hover:-translate-y-0.5 disabled:bg-gray-400 disabled:cursor-not-allowed disabled:transform-none">Hapus Semua</button>
                <button id="kirimWhatsAppBtn" disabled class="px-5 py-2 rounded-lg text-base font-semibold cursor-pointer transition-all duration-300 shadow-md bg-green-500 text-white hover:bg-green-600 hover:-translate-y-0.5 disabled:bg-gray-400 disabled:cursor-not-allowed disabled:transform-none">Kirim Pesanan via WhatsApp</button>
            </div>
            
            <table class="w-full border-collapse mt-5 shadow-sm rounded-lg overflow-hidden">
                <thead>
                    <tr>
                        <th class="border border-gray-200 p-3 text-left text-sm bg-gray-100 font-semibold text-gray-700 uppercase">No</th>
                        <th class="border border-gray-200 p-3 text-left text-sm bg-gray-100 font-semibold text-gray-700 uppercase">Nama Produk</th>
                        <th class="border border-gray-200 p-3 text-left text-sm bg-gray-100 font-semibold text-gray-700 uppercase">Jumlah</th>
                        <th class="border border-gray-200 p-3 text-left text-sm bg-gray-100 font-semibold text-gray-700 uppercase">Aksi</th>
                    </tr>
                </thead>
                <tbody id="orderItemsTableBody">
                    <!-- Data pesanan akan dimuat di sini -->
                </tbody>
            </table>
            <p class="empty-state text-center text-gray-600 py-12 px-5 italic text-base" id="emptyOrderItemsMessage">Daftar pesanan masih kosong.</p>
        </div>

        <!-- Panel Kanan: Manajemen Data Master Produk & Supplier -->
        <div class="panel bg-white p-6 rounded-xl shadow-lg box-border md:flex-1 md:min-w-[450px]">
            <h2 class="text-center text-green-600 mb-6 text-2xl font-semibold">Manajemen Data Produk & Supplier</h2>

            <div class="product-supplier-lists-wrapper flex flex-col gap-5 mt-5 md:flex-row">
                <!-- Product Management Section -->
                <div class="product-section bg-white p-4 rounded-lg shadow-sm box-border md:flex-1 md:min-w-[280px]">
                    <h3 class="mt-0 mb-4 border-b-2 border-green-400 pb-1 text-lg">Daftar Produk</h3>
                    <div class="top-actions flex justify-between items-center mb-5 gap-3 flex-wrap">
                        <div class="search-bar-container p-0 bg-transparent shadow-none static flex-grow min-w-[180px]">
                            <div class="search-bar flex items-center bg-gray-100 rounded-full px-4 py-2 border border-gray-300">
                                <span class="material-icons text-gray-500 mr-2">search</span>
                                <input type="text" id="productSearchInput" placeholder="Cari nama produk" class="flex-grow border-none outline-none px-2 py-1 text-sm bg-transparent text-gray-800">
                            </div>
                        </div>
                        <button id="addTopProductBtn" class="bg-green-600 text-white px-4 py-2.5 border-none rounded-lg text-sm font-semibold cursor-pointer transition-all duration-300 shadow-md flex items-center gap-1 whitespace-nowrap hover:bg-green-700 hover:-translate-y-0.5">
                            <span class="material-icons">add</span> Tambah Produk Baru
                        </button>
                    </div>
                    <div class="menu-list-container p-0 overflow-visible">
                        <div class="menu-items" id="productList">
                            <p class="menu-loading-message text-center py-5 text-gray-600 text-lg">Memuat daftar produk...</p>
                        </div>
                    </div>
                </div>

                <!-- Supplier Management Section -->
                <div class="supplier-section bg-white p-4 rounded-lg shadow-sm box-border md:flex-1 md:min-w-[280px]">
                    <h3 class="mt-0 mb-4 border-b-2 border-green-400 pb-1 text-lg">Daftar Supplier</h3>
                    <div class="top-actions flex justify-between items-center mb-5 gap-3 flex-wrap">
                        <div class="search-bar-container p-0 bg-transparent shadow-none static flex-grow min-w-[180px]">
                            <div class="search-bar flex items-center bg-gray-100 rounded-full px-4 py-2 border border-gray-300">
                                <span class="material-icons text-gray-500 mr-2">search</span>
                                <input type="text" id="supplierSearchInput" placeholder="Cari nama supplier" class="flex-grow border-none outline-none px-2 py-1 text-sm bg-transparent text-gray-800">
                            </div>
                        </div>
                        <button id="addTopSupplierBtn" class="bg-green-600 text-white px-4 py-2.5 border-none rounded-lg text-sm font-semibold cursor-pointer transition-all duration-300 shadow-md flex items-center gap-1 whitespace-nowrap hover:bg-green-700 hover:-translate-y-0.5">
                            <span class="material-icons">add</span> Tambah Supplier Baru
                        </button>
                    </div>
                    <div class="menu-list-container p-0 overflow-visible">
                        <div class="menu-items" id="supplierList">
                            <p class="menu-loading-message text-center py-5 text-gray-600 text-lg">Memuat daftar supplier...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Add/Edit Product Form -->
    <div id="productFormModal" class="hidden fixed inset-0 bg-black/50 z-[1000] justify-center items-center">
        <div class="modal-content bg-white p-8 rounded-xl shadow-2xl w-11/12 max-w-xl box-border relative max-h-[90vh] overflow-y-auto">
            <button class="close-modal-btn absolute top-2 right-4 text-3xl bg-none border-none cursor-pointer text-gray-500" id="closeProductFormModalBtn">&times;</button>
            <h3 id="productFormTitle" class="text-center text-green-600 mb-5 text-xl">Tambah Produk Baru</h3>
            <form id="productForm">
                <input type="hidden" id="productId">
                <div class="form-group mb-4">
                    <label for="productName" class="block text-xs text-gray-700 mb-1 font-medium">Nama Produk:</label>
                    <input type="text" id="productName" required class="w-full p-2.5 border border-gray-300 rounded-md text-sm box-border">
                </div>
                <div class="form-group mb-4">
                    <label for="productDescription" class="block text-xs text-gray-700 mb-1 font-medium">Deskripsi:</label>
                    <textarea id="productDescription" required class="w-full p-2.5 border border-gray-300 rounded-md text-sm box-border resize-y min-h-[80px]"></textarea>
                </div>
                <div class="form-group mb-4">
                    <label for="productPrice" class="block text-xs text-gray-700 mb-1 font-medium">Harga (Rp):</label>
                    <input type="number" id="productPrice" required min="0" class="w-full p-2.5 border border-gray-300 rounded-md text-sm box-border">
                </div>
                <div class="form-group mb-4">
                    <label for="productImageUrl" class="block text-xs text-gray-700 mb-1 font-medium">URL Gambar:</label>
                    <input type="text" id="productImageUrl" placeholder="Contoh: https://example.com/gambar.jpg" class="w-full p-2.5 border border-gray-300 rounded-md text-sm box-border">
                </div>
                <div class="form-group mb-4">
                    <label for="productRating" class="block text-xs text-gray-700 mb-1 font-medium">Rating (1-5):</label>
                    <input type="number" id="productRating" min="1" max="5" step="0.1" value="4.5" class="w-full p-2.5 border border-gray-300 rounded-md text-sm box-border">
                </div>
                <div class="form-group mb-4">
                    <label for="productDeliveryTime" class="block text-xs text-gray-700 mb-1 font-medium">Estimasi Waktu Pengiriman:</label>
                    <input type="text" id="productDeliveryTime" placeholder="Contoh: 15-30 menit" value="15-30 menit" class="w-full p-2.5 border border-gray-300 rounded-md text-sm box-border">
                </div>
                <div class="form-group checkbox-group flex items-center mb-2">
                    <input type="checkbox" id="productIsAvailable" checked class="mr-2.5 transform scale-125">
                    <label for="productIsAvailable" class="m-0 text-sm font-normal">Tersedia</label>
                </div>
                <div class="button-group flex justify-end gap-3 mt-5">
                    <button type="submit" class="btn btn-primary px-5 py-2.5 border-none rounded-full text-sm font-semibold cursor-pointer transition-all duration-300 shadow-sm bg-green-600 text-white hover:bg-green-700 hover:-translate-y-0.5" id="saveProductBtn">Simpan Produk</button>
                    <button type="button" class="btn btn-secondary px-5 py-2.5 border-none rounded-full text-sm font-semibold cursor-pointer transition-all duration-300 shadow-sm bg-gray-100 text-gray-800 hover:bg-gray-200 hover:-translate-y-0.5" id="cancelProductFormBtn">Batal</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal for Add/Edit Supplier Form -->
    <div id="supplierFormModal" class="hidden fixed inset-0 bg-black/50 z-[1000] justify-center items-center">
        <div class="modal-content bg-white p-8 rounded-xl shadow-2xl w-11/12 max-w-xl box-border relative max-h-[90vh] overflow-y-auto">
            <button class="close-modal-btn absolute top-2 right-4 text-3xl bg-none border-none cursor-pointer text-gray-500" id="closeSupplierFormModalBtn">&times;</button>
            <h3 id="supplierFormTitle" class="text-center text-green-600 mb-5 text-xl">Tambah Supplier Baru</h3>
            <form id="supplierForm">
                <input type="hidden" id="supplierId">
                <div class="form-group mb-4">
                    <label for="supplierName" class="block text-xs text-gray-700 mb-1 font-medium">Nama Supplier:</label>
                    <input type="text" id="supplierName" required class="w-full p-2.5 border border-gray-300 rounded-md text-sm box-border">
                </div>
                <div class="form-group mb-4">
                    <label for="supplierContact" class="block text-xs text-gray-700 mb-1 font-medium">Kontak (No. HP/WhatsApp):</label>
                    <input type="text" id="supplierContact" placeholder="Contoh: +6281234567890" required class="w-full p-2.5 border border-gray-300 rounded-md text-sm box-border">
                </div>
                <div class="form-group mb-4">
                    <label for="supplierAddress" class="block text-xs text-gray-700 mb-1 font-medium">Alamat:</label>
                    <textarea id="supplierAddress" required class="w-full p-2.5 border border-gray-300 rounded-md text-sm box-border resize-y min-h-[80px]"></textarea>
                </div>
                <div class="button-group flex justify-end gap-3 mt-5">
                    <button type="submit" class="btn btn-primary px-5 py-2.5 border-none rounded-full text-sm font-semibold cursor-pointer transition-all duration-300 shadow-sm bg-green-600 text-white hover:bg-green-700 hover:-translate-y-0.5" id="saveSupplierBtn">Simpan Supplier</button>
                    <button type="button" class="btn btn-secondary px-5 py-2.5 border-none rounded-full text-sm font-semibold cursor-pointer transition-all duration-300 shadow-sm bg-gray-100 text-gray-800 hover:bg-gray-200 hover:-translate-y-0.5" id="cancelSupplierFormBtn">Batal</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Custom Alert Modal -->
    <div id="customAlertDialog" class="hidden fixed inset-0 bg-black/50 z-[9999] justify-center items-center">
        <div class="bg-white p-6 rounded-lg shadow-xl text-center max-w-xs">
            <p id="customAlertMessage" class="mb-5 text-base text-gray-700"></p>
            <button id="customAlertOk" class="bg-green-600 text-white border-none px-5 py-2.5 rounded cursor-pointer font-bold transition-colors duration-200 hover:bg-green-700">OK</button>
        </div>
    </div>

    <!-- Custom Confirmation Modal -->
    <div id="customConfirmModal" class="hidden fixed inset-0 bg-black/50 z-[9999] justify-center items-center">
        <div class="bg-white p-6 rounded-lg shadow-xl text-center max-w-xs">
            <p id="customConfirmMessage" class="mb-5 text-base text-gray-700"></p>
            <button id="customConfirmYes" class="bg-green-600 text-white border-none px-5 py-2.5 rounded cursor-pointer font-bold transition-colors duration-200 hover:bg-green-700">Ya</button>
            <button id="customConfirmNo" class="bg-red-500 text-white border-none px-5 py-2.5 rounded cursor-pointer font-bold transition-colors duration-200 hover:bg-red-600 ml-2.5">Tidak</button>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="fixed inset-0 bg-white/80 flex justify-center items-center z-[1001]" style="display: none;">
        <div class="spinner border-4 border-gray-200 border-l-green-600 rounded-full w-8 h-8 animate-spin"></div>
    </div>

    <script>
        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyCeqHW_m9kru2vmEDVSoelZ3UWFD4k4Xqc",
            authDomain: "tokobuahkasir.firebaseapp.com",
            projectId: "tokobuahkasir",
            storageBucket: "tokobuahkasir.firebasestorage.app",
            messagingSenderId: "731011133713",
            appId: "1:731011133713:web:4247ae627401a01b8c1cb0",
            measurementId: "G-7CPE2DB2BV"
        };

        // Initialize Firebase
        let app;
        try {
            app = firebase.initializeApp(firebaseConfig);
        } catch (error) {
            console.error("Error initializing Firebase App:", error);
        }
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Firestore Collection References
        const produkCollection = db.collection('Produk'); // Master data for products
        const suppliersCollection = db.collection('suppliers'); // Master data for suppliers

        // --- Global Variables ---
        let currentSelectedSupplier = null; // Stores the currently selected supplier object for ordering
        let orderItems = []; // Array to store products added to the current order

        // --- DOM Elements - Supplier Order Panel ---
        const supplierNameOrderInput = document.getElementById('supplierNameOrderInput');
        const supplierNameOrderAutocompleteList = document.getElementById('supplierNameOrderAutocompleteList');
        const supplierDropdownArrow = document.getElementById('supplierDropdownArrow'); // New: Dropdown arrow element
        const supplierInfoDiv = document.getElementById('supplierInfo');
        const productNameInput = document.getElementById('productNameInput');
        const productNameAutocompleteList = document.getElementById('productNameAutocompleteList');
        const quantityInput = document.getElementById('quantityInput');
        const tambahProdukBtn = document.getElementById('tambahProdukBtn');
        const clearAllBtn = document.getElementById('clearAllBtn');
        const kirimWhatsAppBtn = document.getElementById('kirimWhatsAppBtn');
        const orderItemsTableBody = document.getElementById('orderItemsTableBody');
        const emptyOrderItemsMessage = document.getElementById('emptyOrderItemsMessage');

        // --- DOM Elements - Product Management Panel ---
        const productSearchInput = document.getElementById('productSearchInput');
        const productListDiv = document.getElementById('productList');
        const addTopProductBtn = document.getElementById('addTopProductBtn');

        // --- DOM Elements - Supplier Management Section ---
        const supplierSearchInput = document.getElementById('supplierSearchInput');
        const supplierListDiv = document.getElementById('supplierList');
        const addTopSupplierBtn = document.getElementById('addTopSupplierBtn');

        // --- DOM Elements - Product Form Modal ---
        const productFormModal = document.getElementById('productFormModal');
        const closeProductFormModalBtn = document.getElementById('closeProductFormModalBtn');
        const productFormTitle = document.getElementById('productFormTitle');
        const productForm = document.getElementById('productForm');
        const productIdInput = document.getElementById('productId');
        const productNameInputModal = document.getElementById('productName');
        const productDescriptionInput = document.getElementById('productDescription');
        const productPriceInput = document.getElementById('productPrice');
        const productImageUrlInput = document.getElementById('productImageUrl');
        const productRatingInput = document.getElementById('productRating');
        const productDeliveryTimeInput = document.getElementById('productDeliveryTime');
        const productIsAvailableInput = document.getElementById('productIsAvailable');
        const saveProductBtn = document.getElementById('saveProductBtn');
        const cancelProductFormBtn = document.getElementById('cancelProductFormBtn');

        // --- DOM Elements - Supplier Form Modal ---
        const supplierFormModal = document.getElementById('supplierFormModal');
        const closeSupplierFormModalBtn = document.getElementById('closeSupplierFormModalBtn');
        const supplierFormTitle = document.getElementById('supplierFormTitle');
        const supplierForm = document.getElementById('supplierForm');
        const supplierIdInput = document.getElementById('supplierId');
        const supplierNameInputModal = document.getElementById('supplierName');
        const supplierContactInput = document.getElementById('supplierContact');
        const supplierAddressInput = document.getElementById('supplierAddress');
        const saveSupplierBtn = document.getElementById('saveSupplierBtn');
        const cancelSupplierFormBtn = document.getElementById('cancelSupplierFormBtn');

        // --- Custom Modals & Spinner ---
        const customAlertDialog = document.getElementById('customAlertDialog');
        const customAlertMessage = document.getElementById('customAlertMessage');
        const customAlertOk = document.getElementById('customAlertOk');
        const customConfirmModal = document.getElementById('customConfirmModal');
        const customConfirmMessage = document.getElementById('customConfirmMessage');
        const customConfirmYes = document.getElementById('customConfirmYes');
        const customConfirmNo = document.getElementById('customConfirmNo');
        const loadingSpinner = document.getElementById('loadingSpinner');

        // --- Custom Alert/Confirm Functions ---
        function showAlert(message) {
            customAlertMessage.textContent = message;
            customAlertDialog.style.display = 'flex';
        }

        function showConfirm(message) {
            return new Promise((resolve) => {
                customConfirmMessage.textContent = message;
                customConfirmModal.style.display = 'flex';

                const onYes = () => {
                    customConfirmModal.style.display = 'none';
                    customConfirmYes.removeEventListener('click', onYes);
                    customConfirmNo.removeEventListener('click', onNo);
                    resolve(true);
                };

                const onNo = () => {
                    customConfirmModal.style.display = 'none';
                    customConfirmYes.removeEventListener('click', onYes);
                    customConfirmNo.removeEventListener('click', onNo);
                    resolve(false);
                };

                customConfirmYes.addEventListener('click', onYes);
                customConfirmNo.addEventListener('click', onNo);
            });
        }

        customAlertOk.addEventListener('click', () => {
            customAlertDialog.style.display = 'none';
        });

        // --- Loading Spinner Functions ---
        function showLoadingSpinner() {
            loadingSpinner.style.display = 'flex';
        }

        function hideLoadingSpinner() {
            loadingSpinner.style.display = 'none';
        }

        // --- Authentication ---
        let userId = null;
        let isAuthReady = false;

        auth.onAuthStateChanged(async (user) => {
            if (user) {
                userId = user.uid;
                // Fetch initial data after authentication
                await fetchProducts();
                await fetchSuppliers();
                isAuthReady = true;
            } else {
                try {
                    // Use __initial_auth_token if available, otherwise sign in anonymously
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await auth.signInWithCustomToken(__initial_auth_token);
                    } else {
                        await auth.signInAnonymously();
                    }
                } catch (error) {
                    console.error("Error during anonymous sign-in or custom token sign-in:", error);
                    showAlert("Terjadi kesalahan saat otentikasi. Silakan coba lagi.");
                }
            }
        });

        async function logout() {
            const confirmLogout = await showConfirm("Apakah Anda yakin ingin logout?");
            if (confirmLogout) {
                try {
                    await auth.signOut();
                    showAlert("Anda telah berhasil logout.");
                    // Optionally redirect to login page or clear UI
                    window.location.reload(); // Reloads the page to reset state
                } catch (error) {
                    console.error("Error logging out:", error);
                    showAlert("Gagal logout. Silakan coba lagi.");
                }
            }
        }

        // --- Utility Functions ---
        function formatRupiah(number) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(number);
        }

        // --- Product Management Functions ---
        let allProducts = []; // Cache for all products
        let filteredProducts = []; // Products displayed after search

        async function fetchProducts() {
            showLoadingSpinner();
            try {
                const snapshot = await produkCollection.get();
                allProducts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                filteredProducts = allProducts; // Initially, all products are filtered
                displayProducts(filteredProducts);
                setupProductAutocomplete(); // Setup product autocomplete after fetching
            } catch (error) {
                console.error("Error fetching products:", error);
                showAlert("Gagal memuat daftar produk.");
            } finally {
                hideLoadingSpinner();
            }
        }

        function displayProducts(productsToDisplay) {
            productListDiv.innerHTML = '';
            if (productsToDisplay.length === 0) {
                productListDiv.innerHTML = '<p class="menu-loading-message text-center py-5 text-gray-600 text-lg">Tidak ada produk ditemukan.</p>';
                return;
            }
            productsToDisplay.forEach(product => {
                const card = document.createElement('div');
                card.className = 'menu-item-card flex items-center bg-gray-100 border border-gray-300 rounded-lg p-3 mb-2 shadow-sm transition-transform duration-200 cursor-pointer hover:-translate-y-0.5';
                card.innerHTML = `
                    <div class="menu-item-details flex-grow">
                        <h3 class="text-base m-0 mb-1 text-green-600 font-semibold">${product.nama}</h3>
                        <p class="price text-sm font-bold text-gray-800 m-0">${formatRupiah(product.harga)}</p>
                        <p class="text-xs text-gray-600 m-0">${product.deskripsi}</p>
                    </div>
                    <label class="item-toggle-switch relative inline-block w-10 h-6 flex-shrink-0">
                        <input type="checkbox" ${product.tersedia ? 'checked' : ''} data-id="${product.id}" class="opacity-0 w-0 h-0 peer">
                        <span class="item-slider absolute cursor-pointer inset-0 bg-gray-300 transition-all duration-400 rounded-full peer-checked:bg-green-600"></span>
                        <span class="item-slider-handle absolute h-4 w-4 left-1 bottom-1 bg-white transition-all duration-400 rounded-full peer-checked:translate-x-4"></span>
                    </label>
                `;
                card.addEventListener('click', (event) => {
                    // Prevent toggle switch click from opening edit modal
                    if (!event.target.closest('.item-toggle-switch')) {
                        openProductFormModal(product);
                    }
                });
                const toggleSwitch = card.querySelector('.item-toggle-switch input');
                toggleSwitch.addEventListener('change', (event) => {
                    event.stopPropagation(); // Prevent card click event
                    toggleProductAvailability(product.id, event.target.checked);
                });
                productListDiv.appendChild(card);
            });
        }

        async function toggleProductAvailability(productId, isAvailable) {
            try {
                await produkCollection.doc(productId).update({ tersedia: isAvailable });
                showAlert(`Status ketersediaan produk diperbarui.`);
            } catch (error) {
                console.error("Error updating product availability:", error);
                showAlert("Gagal memperbarui ketersediaan produk.");
            }
        }

        function openProductFormModal(product = null) {
            productForm.reset();
            if (product) {
                productFormTitle.textContent = 'Edit Produk';
                productIdInput.value = product.id;
                productNameInputModal.value = product.nama;
                productDescriptionInput.value = product.deskripsi;
                productPriceInput.value = product.harga;
                productImageUrlInput.value = product.imageUrl || '';
                productRatingInput.value = product.rating || 0;
                productDeliveryTimeInput.value = product.estimasiPengiriman || '';
                productIsAvailableInput.checked = product.tersedia;
            } else {
                productFormTitle.textContent = 'Tambah Produk Baru';
                productIdInput.value = '';
                productIsAvailableInput.checked = true; // Default new product to available
            }
            productFormModal.style.display = 'flex';
        }

        closeProductFormModalBtn.addEventListener('click', () => {
            productFormModal.style.display = 'none';
        });

        cancelProductFormBtn.addEventListener('click', () => {
            productFormModal.style.display = 'none';
        });

        productForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoadingSpinner();

            const productId = productIdInput.value;
            const productData = {
                nama: productNameInputModal.value,
                deskripsi: productDescriptionInput.value,
                harga: parseFloat(productPriceInput.value),
                imageUrl: productImageUrlInput.value,
                rating: parseFloat(productRatingInput.value),
                estimasiPengiriman: productDeliveryTimeInput.value,
                tersedia: productIsAvailableInput.checked
            };

            try {
                if (productId) {
                    await produkCollection.doc(productId).update(productData);
                    showAlert("Produk berhasil diperbarui!");
                } else {
                    await produkCollection.add(productData);
                    showAlert("Produk berhasil ditambahkan!");
                }
                productFormModal.style.display = 'none';
                await fetchProducts(); // Re-fetch to update the list
            } catch (error) {
                console.error("Error saving product:", error);
                showAlert("Gagal menyimpan produk. Silakan coba lagi.");
            } finally {
                hideLoadingSpinner();
            }
        });

        addTopProductBtn.addEventListener('click', () => openProductFormModal());

        productSearchInput.addEventListener('input', () => {
            const searchTerm = productSearchInput.value.toLowerCase();
            filteredProducts = allProducts.filter(product =>
                product.nama.toLowerCase().includes(searchTerm) ||
                product.deskripsi.toLowerCase().includes(searchTerm)
            );
            displayProducts(filteredProducts);
        });

        // --- Supplier Management Functions ---
        let allSuppliers = []; // Cache for all suppliers
        let filteredSuppliers = []; // Suppliers displayed after search

        async function fetchSuppliers() {
            showLoadingSpinner();
            try {
                const snapshot = await suppliersCollection.get();
                allSuppliers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                filteredSuppliers = allSuppliers; // Initially, all suppliers are filtered
                displaySuppliers(filteredSuppliers);
                setupSupplierAutocomplete(); // Re-setup autocomplete with fresh data
            } catch (error) {
                console.error("Error fetching suppliers:", error);
                showAlert("Gagal memuat daftar supplier.");
            } finally {
                hideLoadingSpinner();
            }
        }

        function displaySuppliers(suppliersToDisplay) {
            supplierListDiv.innerHTML = '';
            if (suppliersToDisplay.length === 0) {
                supplierListDiv.innerHTML = '<p class="menu-loading-message text-center py-5 text-gray-600 text-lg">Tidak ada supplier ditemukan.</p>';
                return;
            }
            suppliersToDisplay.forEach(supplier => {
                const card = document.createElement('div');
                card.className = 'supplier-item-card flex items-center bg-gray-100 border border-gray-300 rounded-lg p-3 mb-2 shadow-sm transition-transform duration-200 cursor-pointer hover:-translate-y-0.5';
                card.innerHTML = `
                    <div class="supplier-item-details flex-grow">
                        <h3 class="text-base m-0 mb-1 text-green-600 font-semibold">${supplier.nama}</h3>
                        <p class="text-xs text-gray-600 m-0">${supplier.kontak}</p>
                        <p class="text-xs text-gray-600 m-0">${supplier.alamat}</p>
                    </div>
                `;
                card.addEventListener('click', () => openSupplierFormModal(supplier));
                supplierListDiv.appendChild(card);
            });
        }

        function openSupplierFormModal(supplier = null) {
            supplierForm.reset();
            if (supplier) {
                supplierFormTitle.textContent = 'Edit Supplier';
                supplierIdInput.value = supplier.id;
                supplierNameInputModal.value = supplier.nama;
                supplierContactInput.value = supplier.kontak;
                supplierAddressInput.value = supplier.alamat;
            } else {
                supplierFormTitle.textContent = 'Tambah Supplier Baru';
                supplierIdInput.value = '';
            }
            supplierFormModal.style.display = 'flex';
        }

        closeSupplierFormModalBtn.addEventListener('click', () => {
            supplierFormModal.style.display = 'none';
        });

        cancelSupplierFormBtn.addEventListener('click', () => {
            supplierFormModal.style.display = 'none';
        });

        supplierForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoadingSpinner();

            const supplierId = supplierIdInput.value;
            const supplierData = {
                nama: supplierNameInputModal.value,
                kontak: supplierContactInput.value,
                alamat: supplierAddressInput.value
            };

            try {
                if (supplierId) {
                    await suppliersCollection.doc(supplierId).update(supplierData);
                    showAlert("Supplier berhasil diperbarui!");
                } else {
                    await suppliersCollection.add(supplierData);
                    showAlert("Supplier berhasil ditambahkan!");
                }
                supplierFormModal.style.display = 'none';
                await fetchSuppliers(); // Re-fetch to update the list and autocomplete
            } catch (error) {
                console.error("Error saving supplier:", error);
                showAlert("Gagal menyimpan supplier. Silakan coba lagi.");
            } finally {
                hideLoadingSpinner();
            }
        });

        addTopSupplierBtn.addEventListener('click', () => openSupplierFormModal());

        supplierSearchInput.addEventListener('input', () => {
            const searchTerm = supplierSearchInput.value.toLowerCase();
            filteredSuppliers = allSuppliers.filter(supplier =>
                supplier.nama.toLowerCase().includes(searchTerm) ||
                supplier.kontak.toLowerCase().includes(searchTerm) ||
                supplier.alamat.toLowerCase().includes(searchTerm)
            );
            displaySuppliers(filteredSuppliers);
        });

        // --- Global Autocomplete Helper Function to close all lists ---
        function closeAllLists(exceptElement) {
            const x = document.getElementsByClassName("autocomplete-items");
            for (let i = 0; i < x.length; i++) {
                // Clear content of all lists except the one specified
                // This ensures only one autocomplete list is visible at a time
                if (x[i] !== exceptElement) {
                    x[i].innerHTML = '';
                }
            }
        }
        document.addEventListener("click", function (e) {
            // Close all lists if click is outside any autocomplete container
            if (!e.target.closest('.autocomplete')) {
                closeAllLists(null); // Pass null to clear all lists
            }
        });


        // --- Autocomplete Functionality (Generic, for typing) ---
        function autocomplete(inp, arr, listContainer, onSelectCallback) {
            let currentFocus;

            inp.addEventListener("input", function(e) {
                let b, i, val = this.value;
                listContainer.innerHTML = ''; // Clear the existing list container content
                closeAllLists(listContainer); // Close other lists, but keep this one's container

                // If input is empty, don't show suggestions via typing.
                // The dropdown arrow is for showing all.
                if (!val) {
                    return false;
                }
                currentFocus = -1;

                // Filter based on current input value (case-insensitive)
                const itemsToFilter = arr.filter(item => item.nama.toLowerCase().includes(val.toLowerCase()));

                if (itemsToFilter.length === 0) {
                    const noResultsDiv = document.createElement("div");
                    noResultsDiv.classList.add("autocomplete-item");
                    noResultsDiv.textContent = "Tidak ada hasil.";
                    listContainer.appendChild(noResultsDiv); // Append directly to listContainer
                    return;
                }
                // Loop through filtered items and create autocomplete suggestions
                for (i = 0; i < itemsToFilter.length; i++) {
                    b = document.createElement("div");
                    b.classList.add("autocomplete-item"); // Add class for styling
                    // Highlight the matching part
                    const matchIndex = itemsToFilter[i].nama.toLowerCase().indexOf(val.toLowerCase());
                    const beforeMatch = itemsToFilter[i].nama.substr(0, matchIndex);
                    const matchText = itemsToFilter[i].nama.substr(matchIndex, val.length);
                    const afterMatch = itemsToFilter[i].nama.substr(matchIndex + val.length);

                    b.innerHTML = beforeMatch + "<strong>" + matchText + "</strong>" + afterMatch;
                    b.innerHTML += "<input type='hidden' value='" + itemsToFilter[i].nama + "' data-id='" + itemsToFilter[i].id + "'>";
                    b.addEventListener("click", function(e) {
                        const selectedName = this.getElementsByTagName("input")[0].value;
                        const selectedId = this.getElementsByTagName("input")[0].getAttribute('data-id');
                        inp.value = selectedName;
                        const selectedItem = arr.find(item => item.id === selectedId);
                        if (selectedItem) {
                            onSelectCallback(selectedItem);
                        }
                        listContainer.innerHTML = ''; // Clear list after selection
                    });
                    listContainer.appendChild(b); // Append directly to listContainer
                }
            });

            inp.addEventListener("keydown", function(e) {
                let x = listContainer.getElementsByTagName("div"); // Get all child divs (autocomplete items)
                if (e.keyCode == 40) { // DOWN key
                    currentFocus++;
                    addActive(x);
                } else if (e.keyCode == 38) { // UP key
                    currentFocus--;
                    addActive(x);
                } else if (e.keyCode == 13) { // ENTER key
                    e.preventDefault();
                    if (currentFocus > -1) {
                        // If an item is highlighted, click it
                        if (x && x[currentFocus]) x[currentFocus].click(); // Check if x[currentFocus] exists
                    } else {
                        // If ENTER is pressed and no item is highlighted,
                        // check if the typed value exactly matches an existing item
                        const typedValue = this.value.trim().toLowerCase();
                        let matchedItem = null;

                        if (this.id === 'productNameInput') {
                            matchedItem = allProducts.find(p => p.nama.toLowerCase() === typedValue);
                        } else if (this.id === 'supplierNameOrderInput') {
                            matchedItem = allSuppliers.find(s => s.nama.toLowerCase() === typedValue);
                        }

                        if (matchedItem) {
                            // If an exact match is found, select it
                            onSelectCallback(matchedItem);
                            listContainer.innerHTML = ''; // Clear list after selection
                        } else {
                            // If no match, treat as custom entry (for product) or new/unregistered (for supplier)
                            if (this.id === 'productNameInput') {
                                const customProduct = {
                                    id: 'custom-' + Date.now(), // Unique ID for custom product
                                    nama: this.value,
                                    deskripsi: 'Produk custom', // Default description
                                    harga: 0, // Default price
                                    tersedia: true
                                };
                                onSelectCallback(customProduct); // Pass custom product
                            } else if (this.id === 'supplierNameOrderInput') {
                                 // If a supplier is typed but not selected from autocomplete, treat as new/unregistered supplier
                                 const newSupplier = {
                                    id: 'temp-' + Date.now(), // Temporary ID
                                    nama: this.value,
                                    kontak: '', // User can fill this later if needed
                                    alamat: ''
                                 };
                                 onSelectCallback(newSupplier);
                            }
                            listContainer.innerHTML = ''; // Clear list even if no match for the typed value
                        }
                    }
                }
            });

            function addActive(x) {
                if (!x) return false;
                removeActive(x);
                if (currentFocus >= x.length) currentFocus = 0;
                if (currentFocus < 0) currentFocus = (x.length - 1);
                x[currentFocus].classList.add("autocomplete-active");
            }

            function removeActive(x) {
                for (let i = 0; i < x.length; i++) {
                    x[i].classList.remove("autocomplete-active");
                }
            }
        }

        // --- Function to display all items in autocomplete list (for dropdown arrow) ---
        function showAllAutocompleteItems(inp, arr, listContainer, onSelectCallback) {
            listContainer.innerHTML = ''; // Clear the existing list container content
            closeAllLists(listContainer); // Close other lists, but keep this one's container

            // Filter based on current input value if not empty, otherwise show all
            const val = inp.value.toLowerCase();
            const itemsToShow = val ? arr.filter(item => item.nama.toLowerCase().includes(val)) : arr;

            if (itemsToShow.length === 0) {
                const noResultsDiv = document.createElement("div");
                noResultsDiv.classList.add("autocomplete-item");
                noResultsDiv.textContent = "Tidak ada hasil.";
                listContainer.appendChild(noResultsDiv); // Append directly to listContainer
                return;
            }

            for (let i = 0; i < itemsToShow.length; i++) {
                let b = document.createElement("div");
                b.classList.add("autocomplete-item"); // Add class for styling
                // Highlight logic (same as in original autocomplete)
                const matchIndex = itemsToShow[i].nama.toLowerCase().indexOf(val);
                const beforeMatch = itemsToShow[i].nama.substr(0, matchIndex);
                const matchText = itemsToShow[i].nama.substr(matchIndex, val.length);
                const afterMatch = itemsToShow[i].nama.substr(matchIndex + val.length);

                b.innerHTML = beforeMatch + "<strong>" + matchText + "</strong>" + afterMatch;
                b.innerHTML += "<input type='hidden' value='" + itemsToShow[i].nama + "' data-id='" + itemsToShow[i].id + "'>";
                b.addEventListener("click", function(e) {
                    const selectedName = this.getElementsByTagName("input")[0].value;
                    const selectedId = this.getElementsByTagName("input")[0].getAttribute('data-id');
                    inp.value = selectedName;
                    const selectedItem = arr.find(item => item.id === selectedId);
                    if (selectedItem) {
                        onSelectCallback(selectedItem);
                    }
                    listContainer.innerHTML = ''; // Clear list after selection
                });
                listContainer.appendChild(b); // Append directly to listContainer
            }
        }


        // --- Setup Autocomplete for Product and Supplier Order Input ---
        function setupProductAutocomplete() {
            autocomplete(productNameInput, allProducts, productNameAutocompleteList, (selectedProduct) => {
                productNameInput.value = selectedProduct.nama;
            });
        }

        function setupSupplierAutocomplete() {
            autocomplete(supplierNameOrderInput, allSuppliers, supplierNameOrderAutocompleteList, (selectedSupplier) => {
                currentSelectedSupplier = selectedSupplier;
                supplierNameOrderInput.value = selectedSupplier.nama; // Ensure input shows selected name
                updateSupplierInfoDisplay();
                enableOrderButtons(); // This should enable the buttons
                // Clear existing order items if a new supplier is selected
                orderItems = [];
                renderOrderItems();
            });
        }

        function updateSupplierInfoDisplay() {
            if (currentSelectedSupplier) {
                // If it's a "temp-" supplier, indicate it's new/unregistered
                if (currentSelectedSupplier.id && currentSelectedSupplier.id.startsWith('temp-')) {
                    supplierInfoDiv.innerHTML = `
                        <strong class="font-bold">Supplier:</strong> ${currentSelectedSupplier.nama} (Belum terdaftar/Baru)<br>
                        <span class="text-sm italic text-gray-500">_Detail kontak akan kosong jika tidak terdaftar._</span>
                    `;
                } else {
                    // It's a registered supplier
                    supplierInfoDiv.innerHTML = `
                        <strong class="font-bold">Supplier:</strong> ${currentSelectedSupplier.nama}<br>
                        <strong class="font-bold">Kontak:</strong> ${currentSelectedSupplier.kontak || 'N/A'}<br>
                        <strong class="font-bold">Alamat:</strong> ${currentSelectedSupplier.alamat || 'N/A'}
                    `;
                }
            } else if (supplierNameOrderInput.value.trim() !== '') {
                // This case should now be handled by the input event listener setting currentSelectedSupplier to a temp object
                // But as a fallback, display the typed name
                supplierInfoDiv.innerHTML = `
                    <strong class="font-bold">Supplier:</strong> ${supplierNameOrderInput.value.trim()} (Belum terdaftar/Baru)<br>
                    <span class="text-sm italic text-gray-500">_Detail kontak akan kosong jika tidak terdaftar._</span>
                `;
            }
            else {
                supplierInfoDiv.textContent = 'Pilih supplier untuk memulai pesanan.';
            }
        }

        function enableOrderButtons() {
            // Buttons are enabled if currentSelectedSupplier is not null (meaning something is typed or selected)
            const isDisabled = currentSelectedSupplier === null;
            tambahProdukBtn.disabled = isDisabled;
            clearAllBtn.disabled = isDisabled;
            kirimWhatsAppBtn.disabled = isDisabled;
        }

        // --- Supplier Order Panel Functions ---
        function renderOrderItems() {
            orderItemsTableBody.innerHTML = '';
            if (orderItems.length === 0) {
                emptyOrderItemsMessage.style.display = 'block';
                return;
            }
            emptyOrderItemsMessage.style.display = 'none';

            orderItems.forEach((item, index) => {
                const row = orderItemsTableBody.insertRow();
                row.setAttribute('data-index', index); // Store index for editing/deleting
                row.classList.add('even:bg-gray-50', 'hover:bg-gray-100'); // Tailwind classes for table rows

                row.innerHTML = `
                    <td class="border border-gray-200 p-3 text-left text-sm">${index + 1}</td>
                    <td class="editable-product-name border border-gray-200 p-3 text-left text-sm">${item.namaProduk}</td>
                    <td class="editable-quantity border border-gray-200 p-3 text-left text-sm">${item.jumlah}</td>
                    <td class="border border-gray-200 p-3 text-left text-sm">
                        <button class="edit-item-btn px-2 py-1 text-xs rounded cursor-pointer transition-colors duration-200 border-none mr-1 bg-yellow-500 text-gray-800 hover:bg-yellow-600">Edit</button>
                        <button class="delete-item-btn px-2 py-1 text-xs rounded cursor-pointer transition-colors duration-200 border-none mr-1 bg-red-600 text-white hover:bg-red-700">Hapus</button>
                    </td>
                `;

                const editButton = row.querySelector('.edit-item-btn');
                const deleteButton = row.querySelector('.delete-item-btn');

                editButton.addEventListener('click', () => toggleEditMode(row, item));
                deleteButton.addEventListener('click', () => deleteOrderItem(index));
            });
        }

        function toggleEditMode(row, item) {
            const productNameCell = row.querySelector('.editable-product-name');
            const quantityCell = row.querySelector('.editable-quantity');
            const actionsCell = row.querySelector('td:last-child');

            if (row.classList.contains('editing')) {
                // Save mode
                const newProductName = productNameCell.querySelector('input').value;
                const newQuantity = quantityCell.querySelector('input').value;

                if (!newProductName || !newQuantity) {
                    showAlert("Nama Produk dan Jumlah tidak boleh kosong.");
                    return;
                }

                item.namaProduk = newProductName;
                item.jumlah = newQuantity;
                renderOrderItems(); // Re-render the whole table to update
                row.classList.remove('editing');
            } else {
                // Edit mode
                row.classList.add('editing');

                // Store original values for cancel
                row.dataset.originalProductName = item.namaProduk;
                row.dataset.originalQuantity = item.jumlah;

                productNameCell.innerHTML = `<input type="text" value="${item.namaProduk}" class="w-full p-1 text-sm border border-gray-300 rounded-md">`;
                quantityCell.innerHTML = `<input type="text" value="${item.jumlah}" class="w-full p-1 text-sm border border-gray-300 rounded-md">`;
                
                actionsCell.innerHTML = `
                    <button class="save-item-btn px-2 py-1 text-xs rounded cursor-pointer transition-colors duration-200 border-none mr-1 bg-green-600 text-white hover:bg-green-700">Simpan</button>
                    <button class="cancel-edit-btn px-2 py-1 text-xs rounded cursor-pointer transition-colors duration-200 border-none mr-1 bg-gray-500 text-white hover:bg-gray-600">Batal</button>
                `;

                row.querySelector('.save-item-btn').addEventListener('click', () => toggleEditMode(row, item));
                row.querySelector('.cancel-edit-btn').addEventListener('click', () => cancelEditMode(row, item));
            }
        }

        function cancelEditMode(row, item) {
            row.classList.remove('editing');
            // Restore original values
            item.namaProduk = row.dataset.originalProductName;
            item.jumlah = row.dataset.originalQuantity;
            renderOrderItems(); // Re-render to show original values
        }

        function addOrderItem() {
            // This check is now redundant because enableOrderButtons ensures currentSelectedSupplier is set
            // if supplierNameOrderInput has value. But keeping for robustness.
            if (!currentSelectedSupplier) {
                showAlert("Silakan pilih atau masukkan nama supplier terlebih dahulu.");
                return;
            }

            const productName = productNameInput.value.trim();
            const quantity = quantityInput.value.trim();

            if (productName === '' || quantity === '') {
                showAlert("Nama Produk dan Jumlah tidak boleh kosong.");
                return;
            }

            orderItems.push({ namaProduk: productName, jumlah: quantity });
            renderOrderItems();
            productNameInput.value = '';
            quantityInput.value = '';
            productNameInput.focus();
        }

        async function deleteOrderItem(index) {
            const confirmDelete = await showConfirm("Apakah Anda yakin ingin menghapus item ini?");
            if (confirmDelete) {
                orderItems.splice(index, 1);
                renderOrderItems();
                showAlert("Item berhasil dihapus.");
            }
        }

        async function clearAllOrderItems() {
            if (orderItems.length === 0) {
                showAlert("Daftar pesanan sudah kosong.");
                return;
            }
            const confirmClear = await showConfirm("Apakah Anda yakin ingin menghapus semua item pesanan?");
            if (confirmClear) {
                orderItems = [];
                renderOrderItems();
                showAlert("Semua item pesanan berhasil dihapus.");
            }
        }

        function generateWhatsAppMessage() {
            if (!currentSelectedSupplier) {
                showAlert("Silakan pilih atau masukkan nama supplier terlebih dahulu.");
                return '';
            }
            if (orderItems.length === 0) {
                showAlert("Daftar pesanan masih kosong. Tambahkan produk terlebih dahulu.");
                return '';
            }

            // Use the typed supplier name if no registered supplier is selected
            const supplierNameForMessage = currentSelectedSupplier.nama;
            const supplierContactForMessage = currentSelectedSupplier.kontak || 'Tidak ada kontak';

            let message = `*Pesanan untuk Supplier: ${supplierNameForMessage}*\n`;
            message += `_Kontak: ${supplierContactForMessage}_ \n\n`;
            message += `Halo ${supplierNameForMessage},\nSaya ingin memesan beberapa produk:\n\n`;

            orderItems.forEach((item, index) => {
                message += `${index + 1}. ${item.namaProduk} - ${item.jumlah}\n`;
            });

            message += `\nMohon konfirmasi ketersediaan dan total harga. Terima kasih!`;
            return encodeURIComponent(message);
        }

        function sendWhatsAppOrder() {
            const message = generateWhatsAppMessage();
            if (message === '') {
                return; // Message already handled by showAlert
            }

            let whatsappNumber = '';
            if (currentSelectedSupplier && currentSelectedSupplier.kontak) {
                whatsappNumber = currentSelectedSupplier.kontak.replace(/\D/g, ''); // Remove non-digits
            } 
            
            // Ensure the number starts with 62 for Indonesia if it's available
            if (whatsappNumber && whatsappNumber.startsWith('0')) {
                whatsappNumber = '62' + whatsappNumber.substring(1);
            } else if (whatsappNumber && !whatsappNumber.startsWith('62')) {
                whatsappNumber = '62' + whatsappNumber;
            }

            // If no whatsappNumber is available, still try to open WhatsApp but without a specific number
            const whatsappUrl = `https://wa.me/${whatsappNumber}?text=${message}`;
            window.open(whatsappUrl, '_blank');

            if (!whatsappNumber) {
                showAlert("Nomor WhatsApp supplier tidak tersedia di data. Silakan masukkan secara manual di WhatsApp.");
            }
        }

        // --- Event Listeners for Supplier Order Panel ---
        tambahProdukBtn.addEventListener('click', addOrderItem);
        clearAllBtn.addEventListener('click', clearAllOrderItems);
        kirimWhatsAppBtn.addEventListener('click', sendWhatsAppOrder);

        // Crucial: Logic for supplierNameOrderInput 'input' event
        supplierNameOrderInput.addEventListener('input', () => {
            const typedName = supplierNameOrderInput.value.trim();
            if (typedName === '') {
                currentSelectedSupplier = null;
            } else {
                // Try to find an exact match in allSuppliers
                const matchedSupplier = allSuppliers.find(s => s.nama.toLowerCase() === typedName.toLowerCase());
                if (matchedSupplier) {
                    currentSelectedSupplier = matchedSupplier;
                } else {
                    // If no exact match, create a temporary supplier object
                    currentSelectedSupplier = {
                        id: 'temp-' + Date.now(), // Unique ID for temporary supplier
                        nama: typedName,
                        kontak: '', // Placeholder
                        alamat: '' // Placeholder
                    };
                }
            }
            updateSupplierInfoDisplay();
            enableOrderButtons(); // This will now correctly reflect the state of currentSelectedSupplier
        });

        // New: Event listener for the dropdown arrow
        supplierDropdownArrow.addEventListener('click', () => {
            // Show all suppliers when the arrow is clicked, filtered by current input if any
            showAllAutocompleteItems(supplierNameOrderInput, allSuppliers, supplierNameOrderAutocompleteList, (selectedSupplier) => {
                currentSelectedSupplier = selectedSupplier;
                supplierNameOrderInput.value = selectedSupplier.nama;
                updateSupplierInfoDisplay();
                enableOrderButtons();
                orderItems = []; // Clear existing order items if a new supplier is selected via dropdown
                renderOrderItems();
            });
            supplierNameOrderInput.focus(); // Focus the input when dropdown is clicked
        });


        // Initial setup on page load
        document.addEventListener('DOMContentLoaded', () => {
            renderOrderItems();
            updateSupplierInfoDisplay(); // Show initial message
            enableOrderButtons(); // Disable buttons initially
        });
    </script>
</body>
</html>
