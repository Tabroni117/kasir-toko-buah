<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Penjual: Pesanan & Produk</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <!-- Firebase SDK v9 Compatibility -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        /* General Styling */
        :root {
            --primary-green: #4CAF50;
            --dark-green: #388E3C;
            --light-green: #8BC34A;
            --text-dark: #333;
            --text-light: #777;
            --border-color: #ddd;
            --bg-light: #f4f7f6;
            --card-bg: #ffffff;
            --shadow-light: rgba(0, 0, 0, 0.1);
            --shadow-medium: rgba(0, 0, 0, 0.15);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-light);
            margin: 0;
            padding: 0;
            color: var(--text-dark);
            display: flex;
            flex-direction: column; /* Changed to column to stack header above main container */
            justify-content: flex-start; /* Align to top */
            min-height: 100vh;
            align-items: center; /* Center content horizontally */
        }

        .main-container {
            width: 100%;
            max-width: 960px; /* Maximum width for two columns */
            display: flex;
            flex-direction: column; /* Default stack vertically for small screens */
            gap: 20px;
            padding: 20px;
            box-sizing: border-box;
            flex-grow: 1; /* Allow main container to take available space */
            margin: 0 auto; /* Center the main container */
        }

        /* Responsive layout for wider screens */
        @media (min-width: 768px) {
            .main-container {
                flex-direction: row; /* Side-by-side for larger screens */
                align-items: flex-start; /* Align items to the top */
            }
            .panel {
                flex: 1; /* Each panel takes equal width */
                min-width: 450px; /* Minimum width for each panel */
            }
        }

        .panel {
            background-color: var(--card-bg);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
            box-sizing: border-box;
        }

        h2 {
            text-align: center;
            color: var(--primary-green);
            margin-bottom: 25px;
            font-size: 24px;
            font-weight: 600;
        }

        /* Header for the combined page */
        .app-header-combined {
            background: linear-gradient(135deg, var(--primary-green), var(--light-green));
            color: white;
            padding: 15px 20px;
            box-shadow: 0 2px 5px var(--shadow-medium);
            border-bottom-left-radius: 25px;
            border-bottom-right-radius: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-shrink: 0; /* Prevent header from shrinking */
            max-width: 960px; /* Match main-container max-width */
            width: 100%;
            box-sizing: border-box;
            /* align-self: center; */ /* Removed as body's align-items handles centering */
        }
        .app-header-combined h1 {
            font-size: 20px;
            margin: 0;
            display: flex;
            align-items: center;
            font-weight: 600;
        }
        .app-header-combined .leaf-icon {
            margin-right: 10px;
            font-size: 24px;
        }
        .app-header-combined .logout-button {
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.4);
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.3s, border-color 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
            white-space: nowrap;
        }
        .app-header-combined .logout-button:hover {
            background-color: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.6);
        }

        /* Supplier Order Panel Styles */
        #supplierOrderPanel .supplier-info {
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.1em;
            color: #555;
            font-weight: bold;
        }
        #supplierOrderPanel .form-group {
            margin-bottom: 15px;
        }
        #supplierOrderPanel .form-group label {
            display: block;
            font-size: 13px;
            color: #555;
            margin-bottom: 5px;
            font-weight: 500;
        }
        #supplierOrderPanel input[type="text"],
        #supplierOrderPanel input[type="number"] {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            font-size: 16px;
            border-radius: 6px;
            border: 1px solid #ccc;
            box-sizing: border-box;
        }
        #supplierOrderPanel .autocomplete {
            position: relative;
        }
        #supplierOrderPanel .autocomplete-items {
            position: absolute;
            border: 1px solid #d4d4d4;
            background-color: #fff;
            z-index: 99;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 150px;
            overflow-y: auto;
            border-radius: 6px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        #supplierOrderPanel .autocomplete-item {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            font-size: 14px;
            color: #333;
        }
        #supplierOrderPanel .autocomplete-item:last-child {
            border-bottom: none;
        }
        #supplierOrderPanel .autocomplete-item:hover, #supplierOrderPanel .autocomplete-active {
            background-color: #e9e9e9;
        }
        #supplierOrderPanel .button-group {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        #supplierOrderPanel .button-group button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        }
        #supplierOrderPanel #tambahProdukBtn {
            background-color: var(--primary-green);
            color: white;
        }
        #supplierOrderPanel #tambahProdukBtn:hover {
            background-color: var(--dark-green);
            transform: translateY(-2px);
        }
        #supplierOrderPanel #clearAllBtn {
            background-color: #f44336;
            color: white;
        }
        #supplierOrderPanel #clearAllBtn:hover {
            background-color: #d32f2f;
            transform: translateY(-2px);
        }
        #supplierOrderPanel #kirimWhatsAppBtn {
            background-color: #25d366;
            color: white;
        }
        #supplierOrderPanel #kirimWhatsAppBtn:hover {
            background-color: #1DA851;
            transform: translateY(-2px);
        }
        #supplierOrderPanel #backToSupplierListBtn {
            background-color: #007bff;
            color: white;
        }
        #supplierOrderPanel #backToSupplierListBtn:hover {
            background-color: #0056b3;
            transform: translateY(-2px);
        }
        #supplierOrderPanel table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            border-radius: 8px;
            overflow: hidden;
        }
        #supplierOrderPanel th, #supplierOrderPanel td {
            border: 1px solid #e0e0e0;
            padding: 12px 15px;
            text-align: left;
            font-size: 14px;
        }
        #supplierOrderPanel th {
            background-color: #f0f0f0;
            font-weight: 600;
            color: #555;
            text-transform: uppercase;
        }
        #supplierOrderPanel tbody tr:nth-child(even) {
            background-color: #fcfcfc;
        }
        #supplierOrderPanel tbody tr:hover {
            background-color: #f5f5f5;
        }
        #supplierOrderPanel td button {
            padding: 5px 10px;
            font-size: 12px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
            border: none;
        }
        #supplierOrderPanel td button.delete-item-btn {
            background-color: #dc3545;
            color: white;
        }
        #supplierOrderPanel td button.delete-item-btn:hover {
            background-color: #c82333;
        }
        #supplierOrderPanel .empty-state {
            text-align: center;
            color: #777;
            padding: 50px 20px;
            font-style: italic;
            font-size: 16px;
        }

        /* Product Management Panel Styles */
        #productManagementPanel .top-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            gap: 10px; /* Space between search and button */
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
        }

        #productManagementPanel .search-bar-container {
            padding: 0;
            background-color: transparent;
            box-shadow: none;
            position: static;
            flex-grow: 1; /* Allow search bar to grow */
            min-width: 180px; /* Minimum width for search bar */
        }
        #productManagementPanel .search-bar {
            display: flex;
            align-items: center;
            background-color: var(--bg-light);
            border-radius: 25px;
            padding: 8px 15px;
            border: 1px solid var(--border-color);
        }
        #productManagementPanel .search-bar input {
            flex-grow: 1;
            border: none;
            outline: none;
            padding: 5px 10px;
            font-size: 14px;
            background: transparent;
            color: var(--text-dark);
        }
        #productManagementPanel .search-bar .material-icons {
            color: var(--text-light);
            margin-right: 8px;
        }
        
        /* NEW: Add Product Button at the top */
        #productManagementPanel #addTopProductBtn {
            background-color: var(--primary-green);
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            display: flex; /* Use flex to align icon and text */
            align-items: center;
            gap: 5px;
            white-space: nowrap; /* Prevent text wrapping */
        }
        #productManagementPanel #addTopProductBtn:hover {
            background-color: var(--dark-green);
            transform: translateY(-2px);
        }

        #productManagementPanel .menu-list-container {
            padding: 0;
            overflow-y: visible;
        }
        #productManagementPanel .menu-item-card {
            display: flex;
            align-items: center;
            background-color: var(--bg-light);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s;
            cursor: pointer;
        }
        #productManagementPanel .menu-item-card:hover {
            transform: translateY(-2px);
        }
        #productManagementPanel .menu-item-image {
            width: 70px;
            height: 70px;
            border-radius: 8px;
            overflow: hidden;
            margin-right: 15px;
            flex-shrink: 0;
            background-color: #eee;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #productManagementPanel .menu-item-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        #productManagementPanel .menu-item-details {
            flex-grow: 1;
        }
        #productManagementPanel .menu-item-details h3 {
            font-size: 15px;
            margin: 0 0 5px;
            color: var(--primary-green);
            font-weight: 600;
        }
        #productManagementPanel .menu-item-details .price {
            font-size: 14px;
            font-weight: 700;
            color: var(--text-dark);
            margin: 0;
        }
        #productManagementPanel .item-toggle-switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 24px;
            flex-shrink: 0;
        }
        #productManagementPanel .item-toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        #productManagementPanel .item-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        #productManagementPanel .item-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        #productManagementPanel input:checked + .item-slider {
            background-color: var(--primary-green);
        }
        #productManagementPanel input:checked + .item-slider:before {
            transform: translateX(16px);
        }
        #productManagementPanel .add-menu-fab {
            position: fixed; /* Fixed relative to viewport */
            bottom: 20px; /* Adjust to be visible */
            right: 20px;
            background-color: var(--primary-green);
            color: white;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            box-shadow: 0 4px 8px var(--shadow-medium);
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
            z-index: 100;
            text-decoration: none;
        }
        #productManagementPanel .add-menu-fab:hover {
            background-color: var(--light-green);
            transform: translateY(-2px);
        }
        #productManagementPanel .menu-loading-message {
            text-align: center;
            padding: 20px;
            color: #757575;
            font-size: 1.1em;
        }

        /* Modal for Add/Edit Product Form */
        #productFormModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        #productFormModal .modal-content {
            background-color: var(--card-bg);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 500px;
            box-sizing: border-box;
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
        }
        #productFormModal .close-modal-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 24px;
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-light);
        }
        #productFormModal h3 {
            text-align: center;
            color: var(--primary-green);
            margin-bottom: 20px;
            font-size: 20px;
        }
        #productFormModal .form-group {
            margin-bottom: 15px;
        }
        #productFormModal .form-group label {
            display: block;
            font-size: 13px;
            color: var(--text-dark);
            margin-bottom: 5px;
            font-weight: 500;
        }
        #productFormModal input[type="text"],
        #productFormModal input[type="number"],
        #productFormModal textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
            box-sizing: border-box;
        }
        #productFormModal textarea {
            resize: vertical;
            min-height: 80px;
        }
        #productFormModal .checkbox-group {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        #productFormModal .checkbox-group input[type="checkbox"] {
            margin-right: 10px;
            transform: scale(1.2);
        }
        #productFormModal .checkbox-group label {
            margin-bottom: 0;
            font-size: 14px;
            font-weight: normal;
        }
        #productFormModal .button-group {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        #productFormModal .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
            box-shadow: 0 2px 5px var(--shadow-light);
        }
        #productFormModal .btn-primary {
            background-color: var(--primary-green);
            color: white;
        }
        #productFormModal .btn-primary:hover {
            background-color: var(--dark-green);
            transform: translateY(-1px);
        }
        #productFormModal .btn-secondary {
            background-color: var(--bg-light);
            color: var(--text-dark);
        }
        #productFormModal .btn-secondary:hover {
            background-color: #e0e0e0;
            transform: translateY(-1px);
        }

        /* Custom Alert/Confirm Modals (reused) */
        #customAlertDialog, #customConfirmModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 9999; /* Higher z-index for modals */
            justify-content: center;
            align-items: center;
        }
        #customAlertDialog > div, #customConfirmModal > div {
            background-color: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            text-align: center;
            max-width: 300px;
        }
        #customAlertDialog p, #customConfirmModal p {
            margin-bottom: 20px;
            font-size: 16px;
            color: #333;
        }
        #customAlertDialog button, #customConfirmModal button {
            background-color: var(--primary-green);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s;
        }
        #customAlertDialog button:hover {
            background-color: var(--dark-green);
        }
        #customConfirmModal button#customConfirmYes {
            background-color: var(--primary-green);
        }
        #customConfirmModal button#customConfirmYes:hover {
            background-color: var(--dark-green);
        }
        #customConfirmModal button#customConfirmNo {
            background-color: #f44336;
            margin-left: 10px;
        }
        #customConfirmModal button#customConfirmNo:hover {
            background-color: #d32f2f;
        }

        /* Loading Spinner */
        #loadingSpinner {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1001; /* Higher than other modals */
            font-size: 24px;
            color: var(--primary-green);
        }
        #loadingSpinner .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: var(--primary-green);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <header class="app-header-combined">
        <h1><i class="fas fa-leaf leaf-icon"></i> RUJAK BUAH INDONESIA</h1>
        <button onclick="logout()" class="logout-button">
            <i class="fas fa-sign-out-alt"></i> Logout
        </button>
    </header>

    <div class="main-container">
        <!-- Panel Kiri: Input Pesanan ke Supplier -->
        <div class="panel" id="supplierOrderPanel">
            <h2>Buat Pesanan ke Supplier</h2>
            <div class="supplier-info" id="supplierInfo"></div>

            <div class="form-group">
                <label for="productNameInput">Nama Produk:</label>
                <div class="autocomplete">
                    <input type="text" id="productNameInput" placeholder="Cari atau masukkan nama produk" autocomplete="off">
                </div>
            </div>
            <div class="form-group">
                <label for="quantityInput">Jumlah:</label>
                <input type="text" id="quantityInput" placeholder="Contoh: 5 KG, 10 Buah">
            </div>
            <div class="button-group">
                <button id="tambahProdukBtn">Tambah ke Daftar</button>
                <button id="clearAllBtn">Hapus Semua</button>
                <button id="kirimWhatsAppBtn">Kirim Pesanan via WhatsApp</button>
                <!-- Removed backToSupplierListBtn as this is a combined page -->
            </div>
            
            <table>
                <thead>
                    <tr>
                        <th>No</th>
                        <th>Nama Produk</th>
                        <th>Jumlah</th>
                        <th>Aksi</th>
                    </tr>
                </thead>
                <tbody id="orderItemsTableBody">
                    <!-- Data pesanan akan dimuat di sini -->
                </tbody>
            </table>
            <p class="empty-state" id="emptyOrderItemsMessage">Daftar pesanan masih kosong.</p>
        </div>

        <!-- Panel Kanan: Manajemen Data Master Produk -->
        <div class="panel" id="productManagementPanel">
            <h2>Manajemen Data Produk</h2>
            <div class="top-actions">
                <div class="search-bar-container">
                    <div class="search-bar">
                        <span class="material-icons">search</span>
                        <input type="text" id="productSearchInput" placeholder="Cari nama produk">
                    </div>
                </div>
                <!-- NEW: Prominent Add Product Button -->
                <button id="addTopProductBtn">
                    <span class="material-icons">add</span> Tambah Produk Baru
                </button>
            </div>
            <div class="menu-list-container">
                <div class="category-section">
                    <div class="category-header" style="justify-content: center; border-bottom: none; margin-bottom: 0;">
                        <span>Daftar Produk</span>
                    </div>
                    <div class="menu-items" id="productList">
                        <p class="menu-loading-message">Memuat daftar produk...</p>
                    </div>
                </div>
            </div>
            <!-- Floating Add Product Button (can be kept or removed based on preference) -->
            <a href="#" class="add-menu-fab" id="addProductFab">
                <span class="material-icons">add</span>
            </a>
        </div>
    </div>

    <!-- Modal for Add/Edit Product Form -->
    <div id="productFormModal">
        <div class="modal-content">
            <button class="close-modal-btn" id="closeProductFormModalBtn">&times;</button>
            <h3 id="productFormTitle">Tambah Produk Baru</h3>
            <form id="productForm">
                <input type="hidden" id="productId">
                <div class="form-group">
                    <label for="productName">Nama Produk:</label>
                    <input type="text" id="productName" required>
                </div>
                <div class="form-group">
                    <label for="productDescription">Deskripsi:</label>
                    <textarea id="productDescription" required></textarea>
                </div>
                <div class="form-group">
                    <label for="productPrice">Harga (Rp):</label>
                    <input type="number" id="productPrice" required min="0">
                </div>
                <div class="form-group">
                    <label for="productImageUrl">URL Gambar:</label>
                    <input type="text" id="productImageUrl" placeholder="Contoh: https://example.com/gambar.jpg">
                </div>
                <div class="form-group">
                    <label for="productRating">Rating (1-5):</label>
                    <input type="number" id="productRating" min="1" max="5" step="0.1" value="4.5">
                </div>
                <div class="form-group">
                    <label for="productDeliveryTime">Estimasi Waktu Pengiriman:</label>
                    <input type="text" id="productDeliveryTime" placeholder="Contoh: 15-30 menit" value="15-30 menit">
                </div>
                <div class="form-group checkbox-group">
                    <input type="checkbox" id="productIsAvailable" checked>
                    <label for="productIsAvailable">Tersedia</label>
                </div>
                <div class="button-group">
                    <button type="submit" class="btn btn-primary" id="saveProductBtn">Simpan Produk</button>
                    <button type="button" class="btn btn-secondary" id="cancelProductFormBtn">Batal</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Custom Alert Modal -->
    <div id="customAlertDialog">
        <div>
            <p id="customAlertMessage"></p>
            <button id="customAlertOk">OK</button>
        </div>
    </div>

    <!-- Custom Confirmation Modal -->
    <div id="customConfirmModal">
        <div>
            <p id="customConfirmMessage"></p>
            <button id="customConfirmYes">Ya</button>
            <button id="customConfirmNo">Tidak</button>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div id="loadingSpinner" style="display: none;">
        <div class="spinner"></div>
    </div>

    <script>
        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyCeqHW_m9kru2vmEDVSoelZ3UWFD4k4Xqc",
            authDomain: "tokobuahkasir.firebaseapp.com",
            projectId: "tokobuahkasir",
            storageBucket: "tokobuahkasir.firebasestorage.app",
            messagingSenderId: "731011133713",
            appId: "1:731011133713:web:4247ae627401a01b8c1cb0",
            measurementId: "G-7CPE2DB2BV"
        };

        // Initialize Firebase
        let app;
        try {
            app = firebase.initializeApp(firebaseConfig);
            console.log("DEBUG: Firebase App initialized successfully.");
        } catch (error) {
            console.error("DEBUG: Error initializing Firebase App:", error);
        }
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Firestore Collection References
        const produkCollection = db.collection('Produk'); // Master data for products
        const suppliersCollection = db.collection('suppliers'); // For supplier list (not used directly on this page, but good to have reference)

        // --- DOM Elements - Supplier Order Panel ---
        const supplierInfoDiv = document.getElementById('supplierInfo');
        const productNameInput = document.getElementById('productNameInput');
        const quantityInput = document.getElementById('quantityInput');
        const tambahProdukBtn = document.getElementById('tambahProdukBtn');
        const clearAllBtn = document.getElementById('clearAllBtn');
        const kirimWhatsAppBtn = document.getElementById('kirimWhatsAppBtn');
        const orderItemsTableBody = document.getElementById('orderItemsTableBody');
        const emptyOrderItemsMessage = document.getElementById('emptyOrderItemsMessage');

        // --- DOM Elements - Product Management Panel ---
        const productSearchInput = document.getElementById('productSearchInput');
        const productListDiv = document.getElementById('productList');
        const addProductFab = document.getElementById('addProductFab');
        const addTopProductBtn = document.getElementById('addTopProductBtn'); // NEW: Top add product button

        // --- DOM Elements - Product Form Modal ---
        const productFormModal = document.getElementById('productFormModal');
        const closeProductFormModalBtn = document.getElementById('closeProductFormModalBtn');
        const productFormTitle = document.getElementById('productFormTitle');
        const productForm = document.getElementById('productForm');
        const productIdInput = document.getElementById('productId');
        const productNameInputModal = document.getElementById('productName');
        const productDescriptionInput = document.getElementById('productDescription');
        const productPriceInput = document.getElementById('productPrice');
        const productImageUrlInput = document.getElementById('productImageUrl');
        const productRatingInput = document.getElementById('productRating');
        const productDeliveryTimeInput = document.getElementById('productDeliveryTime');
        const productIsAvailableInput = document.getElementById('productIsAvailable');
        const saveProductBtn = document.getElementById('saveProductBtn');
        const cancelProductFormBtn = document.getElementById('cancelProductFormBtn');

        // --- Custom Modals & Spinner ---
        const customAlertDialog = document.getElementById('customAlertDialog');
        const customAlertMessage = document.getElementById('customAlertMessage');
        const customAlertOk = document.getElementById('customAlertOk');
        const customConfirmModal = document.getElementById('customConfirmModal');
        const customConfirmMessage = document.getElementById('customConfirmMessage');
        const customConfirmYes = document.getElementById('customConfirmYes');
        const customConfirmNo = document.getElementById('customConfirmNo');
        const loadingSpinner = document.getElementById('loadingSpinner');

        let currentUserId = null;
        let orderList = []; // Array to hold products for the current order
        let productSuggestions = []; // For autocomplete in supplier order panel
        let allProductsData = []; // Cache for product management panel search/filter

        // --- Helper Functions ---
        function showLoading() { loadingSpinner.style.display = 'flex'; }
        function hideLoading() { loadingSpinner.style.display = 'none'; }

        function showCustomAlert(message) {
            return new Promise((resolve) => {
                customAlertMessage.textContent = message;
                customAlertDialog.style.display = 'flex';
                const handleOk = () => {
                    customAlertDialog.style.display = 'none';
                    customAlertOk.removeEventListener('click', handleOk);
                    resolve();
                };
                customAlertOk.addEventListener('click', handleOk);
            });
        }

        function showCustomConfirm(message) {
            return new Promise((resolve) => {
                customConfirmMessage.textContent = message;
                customConfirmModal.style.display = 'flex';
                const handleYes = () => {
                    customConfirmModal.style.display = 'none';
                    customConfirmYes.removeEventListener('click', handleYes);
                    customConfirmNo.removeEventListener('click', handleNo);
                    resolve(true);
                };
                const handleNo = () => {
                    customConfirmModal.style.display = 'none';
                    customConfirmYes.removeEventListener('click', handleYes);
                    customConfirmNo.removeEventListener('click', handleNo);
                    resolve(false);
                };
                customConfirmYes.addEventListener('click', handleYes);
                customConfirmNo.addEventListener('click', handleNo);
            });
        }

        function formatRupiah(amount) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(amount);
        }

        // --- Authentication ---
        async function logout() {
            try {
                localStorage.setItem('isLoggingOut', 'true');
                await auth.signOut();
                localStorage.removeItem('isLoggedIn');
                localStorage.removeItem('userRole');
                localStorage.removeItem('userEmail');
                localStorage.removeItem('userUid');
                await showCustomAlert('Anda telah berhasil logout.');
                window.location.href = 'index.html';
            } catch (error) {
                console.error("Error during logout:", error);
                await showCustomAlert('Gagal logout. Coba lagi.');
                localStorage.removeItem('isLoggingOut');
            }
        }

        // --- Autocomplete Logic (for Supplier Order Panel) ---
        let currentFocusProductName = -1;

        function autocomplete(inp, arr) {
            inp.addEventListener("input", function () {
                let val = this.value;
                closeAllLists();
                if (!val) return false;

                const listDiv = document.createElement("DIV");
                listDiv.setAttribute("id", this.id + "autocomplete-list");
                listDiv.setAttribute("class", "autocomplete-items");
                this.parentNode.appendChild(listDiv);

                const filteredArr = arr.filter(item => item.toUpperCase().includes(val.toUpperCase()));

                filteredArr.forEach(item => {
                    const itemDiv = document.createElement("DIV");
                    itemDiv.innerHTML = item;
                    itemDiv.classList.add("autocomplete-item");
                    itemDiv.addEventListener("click", function () {
                        inp.value = item;
                        closeAllLists();
                    });
                    listDiv.appendChild(itemDiv);
                });
            });

            inp.addEventListener("keydown", function (e) {
                let list = document.getElementById(this.id + "autocomplete-list");
                if (list) list = list.getElementsByTagName("div");
                let currentFocus = currentFocusProductName;

                if (e.keyCode == 40) { // DOWN arrow
                    currentFocus++;
                    addActive(list, currentFocus);
                } else if (e.keyCode == 38) { // UP arrow
                    currentFocus--;
                    addActive(list, currentFocus);
                } else if (e.keyCode == 13) { // ENTER key
                    e.preventDefault();
                    if (currentFocus > -1 && list && list[currentFocus]) {
                        list[currentFocus].click();
                    } else if (this.value.trim() !== '') {
                        quantityInput.focus(); // Move focus to quantity input
                    }
                }
                currentFocusProductName = currentFocus;
            });

            function addActive(x, currentFcs) {
                if (!x) return false;
                removeActive(x);
                if (currentFcs >= x.length) currentFcs = 0;
                if (currentFcs < 0) currentFcs = (x.length - 1);
                x[currentFcs].classList.add("autocomplete-active");
            }

            function removeActive(x) {
                for (let i = 0; i < x.length; i++) {
                    x[i].classList.remove("autocomplete-active");
                }
            }

            function closeAllLists(elmnt) {
                const items = document.getElementsByClassName("autocomplete-items");
                for (let item of items) {
                    if (elmnt != item && elmnt != inp) item.parentNode.removeChild(item);
                }
            }
            document.addEventListener("click", function (e) { closeAllLists(e.target); });
        }

        // --- Load Product Suggestions for Autocomplete (for Supplier Order Panel) ---
        async function loadProductSuggestions() {
            try {
                const snapshot = await produkCollection.orderBy('nama').get();
                productSuggestions = [];
                snapshot.forEach(doc => {
                    const product = doc.data();
                    if (product.nama) {
                        productSuggestions.push(product.nama);
                    }
                });
                autocomplete(productNameInput, productSuggestions);
            } catch (error) {
                console.error("Error loading product suggestions:", error);
                await showCustomAlert("Gagal memuat daftar produk untuk saran.");
            }
        }

        // --- Order List Management (for Supplier Order Panel) ---
        function renderOrderList() {
            orderItemsTableBody.innerHTML = '';
            if (orderList.length === 0) {
                emptyOrderItemsMessage.style.display = 'block';
            } else {
                emptyOrderItemsMessage.style.display = 'none';
                orderList.forEach((item, index) => {
                    const row = orderItemsTableBody.insertRow();
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${item.name}</td>
                        <td>${item.quantity}</td>
                        <td><button class="delete-item-btn" data-index="${index}">Hapus</button></td>
                    `;
                });
                // Attach event listeners for delete buttons
                document.querySelectorAll('.delete-item-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const indexToDelete = parseInt(this.dataset.index);
                        deleteOrderItem(indexToDelete);
                    });
                });
            }
        }

        async function addOrderItem() {
            const productName = productNameInput.value.trim();
            const quantity = quantityInput.value.trim();

            if (!productName || !quantity) {
                await showCustomAlert("Nama produk dan jumlah tidak boleh kosong.");
                return;
            }

            orderList.push({ name: productName, quantity: quantity });
            productNameInput.value = '';
            quantityInput.value = '';
            renderOrderList();
        }

        async function deleteOrderItem(index) {
            const confirmDelete = await showCustomConfirm(`Yakin ingin menghapus item "${orderList[index].name}"?`);
            if (confirmDelete) {
                orderList.splice(index, 1);
                renderOrderList();
            }
        }

        async function clearAllOrderItems() {
            if (orderList.length === 0) {
                await showCustomAlert("Daftar pesanan sudah kosong.");
                return;
            }
            const confirmClear = await showCustomConfirm("Yakin ingin menghapus semua item dari daftar pesanan?");
            if (confirmClear) {
                orderList = [];
                renderOrderList();
            }
        }

        // --- WhatsApp Integration (for Supplier Order Panel) ---
        async function kirimWhatsAppOrder() {
            if (orderList.length === 0) {
                await showCustomAlert("Daftar pesanan kosong. Tambahkan produk terlebih dahulu.");
                return;
            }

            const now = new Date();
            const tanggal = now.toLocaleDateString("id-ID", { year: 'numeric', month: 'long', day: 'numeric' });
            const jam = now.toLocaleTimeString("id-ID", { hour: '2-digit', minute: '2-digit', second: '2-digit' });

            let pesan = `ðŸ“ *Daftar Pesanan Barang ke Supplier*
ðŸ“… ${tanggal} - ðŸ•’ ${jam}

Kepada Yth. Supplier *${supplierInfoDiv.textContent.replace('Untuk Supplier: ', '').toUpperCase()}*,
Berikut adalah daftar pesanan barang dari kami:

ðŸ›’ *DAFTAR PRODUK:*
`;
            orderList.forEach((item, index) => {
                pesan += `${index + 1}. ${item.name} (${item.quantity})\n`;
            });

            pesan += `\nMohon konfirmasi ketersediaan dan total harga.
Terima kasih atas kerja samanya.

_Pesan ini dikirim otomatis oleh sistem RUJAK BUAH INDONESIA_`;

            // Note: In a real scenario, you'd get the supplier's phone number from a selected supplier.
            // For this combined page, we assume a generic WhatsApp link or manual input/selection.
            // For now, it opens a generic WhatsApp chat.
            const url = `https://wa.me/?text=${encodeURIComponent(pesan)}`;
            window.open(url, "_blank");
        }

        // --- Product Management Logic ---

        // Load menu items from Firestore
        async function loadProducts() {
            productListDiv.innerHTML = '<p class="menu-loading-message">Memuat daftar produk...</p>';
            try {
                const snapshot = await produkCollection.orderBy('nama').get();
                allProductsData = [];
                snapshot.forEach(doc => {
                    allProductsData.push({ id: doc.id, ...doc.data() });
                });
                renderProducts(allProductsData);
            } catch (error) {
                console.error("Error loading products:", error);
                await showCustomAlert("Gagal memuat daftar produk.");
                productListDiv.innerHTML = '<p class="menu-loading-message" style="color: red;">Gagal memuat daftar produk. Coba refresh halaman.</p>';
            }
        }

        // Render products based on filtered list
        function renderProducts(itemsToRender) {
            productListDiv.innerHTML = '';
            if (itemsToRender.length === 0) {
                productListDiv.innerHTML = '<p class="menu-loading-message">Tidak ada produk ditemukan.</p>';
                return;
            }

            itemsToRender.forEach(product => {
                const card = document.createElement('div');
                card.classList.add('menu-item-card');
                card.dataset.id = product.id;
                card.innerHTML = `
                    <div class="menu-item-image">
                        <img src="${product.imageUrl || 'https://placehold.co/70x70/cccccc/333333?text=No+Image'}" alt="${product.nama}">
                    </div>
                    <div class="menu-item-details">
                        <h3>${product.nama}</h3>
                        <p class="price">${formatRupiah(product.harga)}</p>
                    </div>
                    <label class="item-toggle-switch">
                        <input type="checkbox" data-id="${product.id}" ${product.isAvailable ? 'checked' : ''}>
                        <span class="item-slider"></span>
                    </label>
                `;
                productListDiv.appendChild(card);
            });

            // Attach event listeners for toggles
            productListDiv.querySelectorAll('.item-toggle-switch input[type="checkbox"]').forEach(toggle => {
                toggle.addEventListener('change', async (event) => {
                    const id = event.target.dataset.id;
                    const isAvailable = event.target.checked;
                    showLoading();
                    try {
                        await produkCollection.doc(id).update({ isAvailable: isAvailable });
                        await showCustomAlert(`Status produk diperbarui: ${isAvailable ? 'Tersedia' : 'Tidak Tersedia'}`);
                    } catch (error) {
                        console.error("Error updating product availability:", error);
                        await showCustomAlert("Gagal memperbarui ketersediaan produk.");
                        event.target.checked = !isAvailable; // Revert checkbox state on error
                    } finally {
                        hideLoading();
                    }
                });
            });

            // Attach event listeners for card clicks (edit product)
            productListDiv.querySelectorAll('.menu-item-card').forEach(card => {
                card.addEventListener('click', (event) => {
                    // Prevent toggle click from triggering card click
                    if (!event.target.closest('.item-toggle-switch')) {
                        editProduct(card.dataset.id);
                    }
                });
            });
        }

        // Show Add/Edit Product Form Modal (reused for both FAB and new button)
        addProductFab.addEventListener('click', (e) => {
            e.preventDefault();
            showProductFormModal();
        });

        addTopProductBtn.addEventListener('click', () => { // NEW: Event listener for the new button
            showProductFormModal();
        });

        function showProductFormModal(productData = null) {
            productFormModal.style.display = 'flex';
            // Reset form
            productForm.reset();
            productIdInput.value = '';
            productNameInputModal.value = '';
            productDescriptionInput.value = '';
            productPriceInput.value = '';
            productImageUrlInput.value = '';
            productRatingInput.value = '4.5';
            productDeliveryTimeInput.value = '15-30 menit';
            productIsAvailableInput.checked = true;

            productFormTitle.textContent = 'Tambah Produk Baru';
            saveProductBtn.textContent = 'Simpan Produk';

            if (productData) {
                productIdInput.value = productData.id;
                productNameInputModal.value = productData.nama;
                productDescriptionInput.value = productData.deskripsi;
                productPriceInput.value = productData.harga;
                productImageUrlInput.value = productData.imageUrl;
                productRatingInput.value = productData.rating;
                productDeliveryTimeInput.value = productData.deliveryTime;
                productIsAvailableInput.checked = productData.isAvailable;
                productFormTitle.textContent = 'Edit Produk';
                saveProductBtn.textContent = 'Update Produk';
            }
        }

        // Edit Product (called from card click)
        async function editProduct(id) {
            showLoading();
            try {
                const doc = await produkCollection.doc(id).get();
                if (doc.exists) {
                    showProductFormModal({ id: doc.id, ...doc.data() });
                } else {
                    await showCustomAlert("Produk tidak ditemukan.");
                }
            } catch (error) {
                console.error("Error fetching product for edit:", error);
                await showCustomAlert("Gagal memuat data produk untuk diedit.");
            } finally {
                hideLoading();
            }
        }

        // Save Product Item
        productForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = productIdInput.value;

            const productData = {
                nama: productNameInputModal.value,
                deskripsi: productDescriptionInput.value,
                harga: parseFloat(productPriceInput.value),
                imageUrl: productImageUrlInput.value,
                rating: parseFloat(productRatingInput.value),
                deliveryTime: productDeliveryTimeInput.value,
                isAvailable: productIsAvailableInput.checked,
            };

            showLoading();
            try {
                if (id) {
                    await produkCollection.doc(id).update(productData);
                    await showCustomAlert("Produk berhasil diperbarui!");
                } else {
                    await produkCollection.add(productData);
                    await showCustomAlert("Produk berhasil ditambahkan!");
                }
                loadProducts(); // Reload product list
                loadProductSuggestions(); // Reload suggestions for supplier order panel
                productFormModal.style.display = 'none'; // Hide form
            } catch (error) {
                console.error("Error saving product:", error);
                await showCustomAlert("Gagal menyimpan produk.");
            } finally {
                hideLoading();
            }
        });

        // Cancel Product Form
        cancelProductFormBtn.addEventListener('click', () => {
            productFormModal.style.display = 'none';
        });
        closeProductFormModalBtn.addEventListener('click', () => {
            productFormModal.style.display = 'none';
        });

        // Delete Product Item (Optional, can be added if needed)
        // This function is not directly linked to a button in the current UI, but can be called.
        async function deleteProduct(id, productName) {
            const confirmDelete = await showCustomConfirm(`Yakin ingin menghapus produk "${productName}"?`);
            if (!confirmDelete) return;

            showLoading();
            try {
                await produkCollection.doc(id).delete();
                await showCustomAlert("Produk berhasil dihapus!");
                loadProducts(); // Reload product list
                loadProductSuggestions(); // Reload suggestions for supplier order panel
            } catch (error) {
                console.error("Error deleting product:", error);
                await showCustomAlert("Gagal menghapus produk.");
            } finally {
                hideLoading();
            }
        }

        // --- Search Functionality (for Product Management Panel) ---
        productSearchInput.addEventListener('input', applyProductSearchFilter);

        function applyProductSearchFilter() {
            const query = productSearchInput.value.toLowerCase().trim();
            const filteredProducts = allProductsData.filter(product =>
                product.nama.toLowerCase().includes(query) ||
                (product.deskripsi && product.deskripsi.toLowerCase().includes(query))
            );
            renderProducts(filteredProducts);
        }

        // --- Page Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            // Set a dummy supplier name for the combined page for now
            supplierInfoDiv.textContent = `Untuk Supplier: [Pilih Supplier]`;

            // Event listeners for Supplier Order Panel
            tambahProdukBtn.addEventListener('click', addOrderItem);
            clearAllBtn.addEventListener('click', clearAllOrderItems);
            kirimWhatsAppBtn.addEventListener('click', kirimWhatsAppOrder);
            productNameInput.addEventListener("keydown", e => { if (e.key === "Enter") quantityInput.focus(); });
            quantityInput.addEventListener("keydown", e => { if (e.key === "Enter") addOrderItem(); });

            // Authentication Check
            auth.onAuthStateChanged(user => {
                const storedRole = localStorage.getItem('userRole');
                const isLoggingOut = localStorage.getItem('isLoggingOut');

                if (isLoggingOut) {
                    localStorage.removeItem('isLoggingOut');
                }

                if (!user || storedRole !== 'penjual') { // Only 'penjual' (seller) can access this
                    if (!isLoggingOut) {
                        alert('Akses Ditolak: Halaman ini hanya untuk PENJUAL.');
                    }
                    window.location.href = 'index.html'; // Redirect to login page
                } else {
                    currentUserId = user.uid;
                    loadProductSuggestions(); // Load products for autocomplete in supplier order panel
                    renderOrderList(); // Render empty order list initially
                    loadProducts(); // Load products for management panel
                }
            });
        });
    </script>
</body>
</html>
