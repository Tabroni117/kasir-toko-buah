<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Penjual: Pesanan & Produk & Supplier</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        /* General Styling */
        :root {
            --primary-green: #66BB6A; /* Lebih kalem */
            --dark-green: #43A047;
            --light-green: #81C784;
            --accent-color: #FFB300; /* Contoh warna aksen kuning */
            --text-dark: #212121;
            --text-light: #757575;
            --border-color: #E0E0E0;
            --bg-light: #F5F5F5;
            --card-bg: #FFFFFF;
            --shadow-light: rgba(0, 0, 0, 0.08);
            --shadow-medium: rgba(0, 0, 0, 0.12);
            --red-alert: #E57373; /* Merah yang lebih soft */
            --red-dark: #D32F2F;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg-light);
            margin: 0;
            padding: 0;
            color: var(--text-dark);
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            min-height: 100vh; /* Kembali ke 100vh agar layout mengisi layar */
            align-items: center;
        }

        .main-container {
            width: 100%;
            max-width: 960px;
            display: flex;
            flex-direction: column;
            gap: 25px; /* Jarak antar panel lebih besar */
            padding: 25px; /* Padding lebih besar */
            box-sizing: border-box;
            flex-grow: 1;
            margin: 0 auto;
        }

        @media (min-width: 768px) {
            .main-container {
                flex-direction: row;
                align-items: flex-start;
            }
            .panel {
                flex: 1;
                min-width: 450px;
            }
        }

        .panel {
            background-color: var(--card-bg);
            padding: 30px; /* Padding lebih besar */
            border-radius: 15px; /* Sudut lebih membulat */
            box-shadow: 0 4px 12px var(--shadow-light); /* Bayangan lebih halus */
            border: 1px solid var(--border-color); /* Tambahkan border tipis */
            box-sizing: border-box;
        }

        h2 {
            text-align: center;
            color: var(--primary-green);
            margin-bottom: 30px; /* Jarak lebih besar */
            font-size: 26px; /* Ukuran font lebih besar */
            font-weight: 500; /* Sedikit lebih tipis */
        }

        h3 { /* For sub-sections like "Daftar Produk" and "Daftar Supplier" */
            color: var(--dark-green);
            margin-top: 25px;
            margin-bottom: 20px; /* Jarak lebih besar */
            font-size: 1.4em; /* Ukuran font lebih besar */
            border-bottom: 2px solid var(--light-green);
            padding-bottom: 8px; /* Padding bawah lebih besar */
            font-weight: 500;
        }

        /* Header for the combined page */
        .app-header-combined {
            background: linear-gradient(135deg, var(--primary-green), var(--light-green));
            color: white;
            padding: 15px 30px; /* Padding horizontal lebih besar */
            box-shadow: 0 2px 8px var(--shadow-medium); /* Bayangan lebih halus */
            border-bottom-left-radius: 15px; /* Sudut lebih kecil */
            border-bottom-right-radius: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px; /* Jarak ke konten utama lebih besar */
            flex-shrink: 0;
            max-width: 960px;
            width: 100%;
            box-sizing: border-box;
        }
        .app-header-combined h1 {
            font-size: 22px; /* Ukuran font sedikit lebih besar */
            margin: 0;
            display: flex;
            align-items: center;
            font-weight: 600;
        }
        .app-header-combined .leaf-icon {
            margin-right: 12px; /* Jarak ikon lebih besar */
            font-size: 26px; /* Ukuran ikon lebih besar */
        }
        .app-header-combined .logout-button {
            background-color: rgba(255, 255, 255, 0.15);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 8px 18px; /* Padding disesuaikan */
            border-radius: 8px; /* Sudut lebih membulat */
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.3s, border-color 0.3s;
            display: flex;
            align-items: center;
            gap: 8px; /* Jarak ikon-teks lebih besar */
            white-space: nowrap;
        }
        .app-header-combined .logout-button:hover {
            background-color: rgba(255, 255, 255, 0.25);
            border-color: rgba(255, 255, 255, 0.5);
        }

        /* Supplier Order Panel Styles */
        #supplierOrderPanel .supplier-info {
            text-align: center;
            margin-bottom: 25px; /* Jarak lebih besar */
            font-size: 1.15em; /* Ukuran font sedikit lebih besar */
            color: #555;
            font-weight: 600; /* Lebih tebal */
            min-height: 25px;
        }
        #supplierOrderPanel .form-group {
            margin-bottom: 20px; /* Jarak antar grup form lebih besar */
        }
        #supplierOrderPanel .form-group label {
            display: block;
            font-size: 14px; /* Ukuran font label lebih besar */
            color: var(--text-dark);
            margin-bottom: 8px; /* Jarak label-input lebih besar */
            font-weight: 500;
        }
        #supplierOrderPanel input[type="text"],
        #supplierOrderPanel input[type="number"] {
            width: 100%;
            padding: 12px; /* Padding lebih besar */
            font-size: 16px;
            border-radius: 8px; /* Sudut lebih membulat */
            border: 1px solid var(--border-color);
            box-sizing: border-box;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        #supplierOrderPanel input[type="text"]:focus,
        #supplierOrderPanel input[type="number"]:focus {
            border-color: var(--primary-green);
            box-shadow: 0 0 0 3px rgba(102, 187, 106, 0.2); /* Shadow saat fokus */
            outline: none;
        }
        #supplierOrderPanel .autocomplete {
            position: relative;
            display: flex;
            align-items: center;
        }
        #supplierOrderPanel .autocomplete input[type="text"] {
            flex-grow: 1;
            margin-right: 10px; /* Jarak ke panah dropdown */
        }
        #supplierOrderPanel .dropdown-arrow-icon {
            cursor: pointer;
            color: var(--text-light);
            font-size: 28px; /* Ukuran ikon lebih besar */
            transition: color 0.2s;
        }
        #supplierOrderPanel .dropdown-arrow-icon:hover {
            color: var(--primary-green);
        }

        #supplierOrderPanel .autocomplete-items {
            position: absolute;
            border: 1px solid var(--border-color);
            background-color: var(--card-bg);
            z-index: 99;
            top: calc(100% + 5px); /* Sedikit di bawah input */
            left: 0;
            right: 0;
            max-height: 180px; /* Tinggi maksimal lebih besar */
            overflow-y: auto;
            border-radius: 8px; /* Sudut lebih membulat */
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        #supplierOrderPanel .autocomplete-item {
            padding: 12px; /* Padding lebih besar */
            cursor: pointer;
            border-bottom: 1px solid #eee;
            font-size: 15px; /* Ukuran font sedikit lebih besar */
            color: var(--text-dark);
        }
        #supplierOrderPanel .autocomplete-item:last-child {
            border-bottom: none;
        }
        #supplierOrderPanel .autocomplete-item:hover, #supplierOrderPanel .autocomplete-active {
            background-color: #f0f0f0; /* Warna hover lebih terang */
        }
        #supplierOrderPanel .button-group {
            display: flex;
            justify-content: center;
            gap: 15px; /* Jarak antar tombol lebih besar */
            margin-top: 30px; /* Jarak dari form lebih besar */
            flex-wrap: wrap;
        }
        #supplierOrderPanel .button-group button {
            padding: 12px 25px; /* Padding lebih besar */
            border: none;
            border-radius: 10px; /* Sudut lebih membulat */
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 2px 6px var(--shadow-light); /* Bayangan halus */
        }
        #supplierOrderPanel #tambahProdukBtn {
            background-color: var(--primary-green);
            color: white;
        }
        #supplierOrderPanel #tambahProdukBtn:hover {
            background-color: var(--dark-green);
            transform: translateY(-2px);
            box-shadow: 0 4px 10px var(--shadow-light);
        }
        #supplierOrderPanel #tambahProdukBtn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        #supplierOrderPanel #clearAllBtn {
            background-color: var(--red-alert);
            color: white;
        }
        #supplierOrderPanel #clearAllBtn:hover {
            background-color: var(--red-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 10px var(--shadow-light);
        }
        #supplierOrderPanel #clearAllBtn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        #supplierOrderPanel #kirimWhatsAppBtn {
            background-color: #25d366; /* Warna WhatsApp standar */
            color: white;
        }
        #supplierOrderPanel #kirimWhatsAppBtn:hover {
            background-color: #1DA851;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px var(--shadow-light);
        }
        #supplierOrderPanel #kirimWhatsAppBtn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        #supplierOrderPanel table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 30px; /* Jarak dari tombol lebih besar */
            box-shadow: 0 2px 8px var(--shadow-light); /* Bayangan halus */
            border-radius: 10px; /* Sudut membulat */
            overflow: hidden;
            border: 1px solid var(--border-color); /* Border keseluruhan tabel */
        }
        #supplierOrderPanel th, #supplierOrderPanel td {
            border-bottom: 1px solid var(--border-color); /* Hanya border bawah */
            padding: 15px; /* Padding lebih besar */
            text-align: left;
            font-size: 15px; /* Ukuran font lebih besar */
        }
        #supplierOrderPanel th {
            background-color: #F9F9F9; /* Latar belakang lebih terang */
            font-weight: 600;
            color: var(--text-dark);
            text-transform: uppercase;
        }
        #supplierOrderPanel tbody tr:nth-child(even) {
            background-color: #FAFAFA; /* Striping baris lebih halus */
        }
        #supplierOrderPanel tbody tr:hover {
            background-color: #F0F0F0; /* Warna hover lebih terang */
        }
        #supplierOrderPanel td button {
            padding: 8px 15px; /* Padding lebih besar */
            font-size: 13px; /* Ukuran font disesuaikan */
            border-radius: 8px; /* Sudut lebih membulat */
            cursor: pointer;
            transition: background-color 0.2s, transform 0.2s, box-shadow 0.2s;
            border: none;
            margin-right: 8px; /* Jarak antar tombol */
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); /* Bayangan halus */
        }
        #supplierOrderPanel td button:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        #supplierOrderPanel td button.delete-item-btn {
            background-color: var(--red-alert);
            color: white;
        }
        #supplierOrderPanel td button.delete-item-btn:hover {
            background-color: var(--red-dark);
        }
        #supplierOrderPanel td button.edit-item-btn {
            background-color: var(--accent-color); /* Menggunakan warna aksen */
            color: var(--text-dark);
        }
        #supplierOrderPanel td button.edit-item-btn:hover {
            background-color: #E6A400; /* Amber yang lebih gelap */
        }
        #supplierOrderPanel td button.save-item-btn {
            background-color: var(--primary-green);
            color: white;
        }
        #supplierOrderPanel td button.save-item-btn:hover {
            background-color: var(--dark-green);
        }
        #supplierOrderPanel td button.cancel-edit-btn {
            background-color: #9E9E9E; /* Abu-abu yang lebih netral */
            color: white;
        }
        #supplierOrderPanel td button.cancel-edit-btn:hover {
            background-color: #757575;
        }
        #supplierOrderPanel .empty-state {
            text-align: center;
            color: #777;
            padding: 50px 20px;
            font-style: italic;
            font-size: 16px;
            border-top: 1px dashed var(--border-color); /* Tambahkan garis putus-putus */
            margin-top: 20px;
        }

        /* Product & Supplier Management Panel Styles */
        #productManagementPanel .top-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px; /* Jarak lebih besar */
            gap: 15px; /* Jarak antar elemen top-actions */
            flex-wrap: wrap;
        }

        #productManagementPanel .search-bar-container {
            padding: 0;
            background-color: transparent;
            box-shadow: none;
            position: static;
            flex-grow: 1;
            min-width: 180px;
        }
        #productManagementPanel .search-bar {
            display: flex;
            align-items: center;
            background-color: var(--bg-light);
            border-radius: 25px;
            padding: 10px 18px; /* Padding lebih besar */
            border: 1px solid var(--border-color);
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05); /* Sedikit efek inset */
        }
        #productManagementPanel .search-bar input {
            flex-grow: 1;
            border: none;
            outline: none;
            padding: 5px 10px;
            font-size: 15px; /* Ukuran font lebih besar */
            background: transparent;
            color: var(--text-dark);
        }
        #productManagementPanel .search-bar .material-icons {
            color: var(--text-light);
            margin-right: 10px; /* Jarak ikon-input lebih besar */
            font-size: 20px; /* Ukuran ikon lebih besar */
        }
        
        /* Add Product/Supplier Button at the top */
        #productManagementPanel #addTopProductBtn,
        #productManagementPanel #addTopSupplierBtn {
            background-color: var(--primary-green);
            color: white;
            padding: 12px 20px; /* Padding disesuaikan */
            border: none;
            border-radius: 10px; /* Sudut lebih membulat */
            font-size: 15px; /* Ukuran font disesuaikan */
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 2px 6px var(--shadow-light);
            display: flex;
            align-items: center;
            gap: 8px; /* Jarak ikon-teks lebih besar */
            white-space: nowrap;
        }
        #productManagementPanel #addTopProductBtn:hover,
        #productManagementPanel #addTopSupplierBtn:hover {
            background-color: var(--dark-green);
            transform: translateY(-2px);
            box-shadow: 0 4px 10px var(--shadow-light);
        }

        /* Wrapper for Product and Supplier lists to make them side-by-side */
        .product-supplier-lists-wrapper {
            display: flex;
            flex-direction: column;
            gap: 25px; /* Jarak antar bagian lebih besar */
            margin-top: 25px;
        }

        @media (min-width: 768px) {
            .product-supplier-lists-wrapper {
                flex-direction: row;
            }
            .product-section, .supplier-section {
                flex: 1;
                min-width: 280px;
            }
        }

        .product-section, .supplier-section {
            background-color: var(--card-bg);
            padding: 20px; /* Padding lebih besar */
            border-radius: 12px; /* Sudut membulat */
            box-shadow: 0 4px 10px var(--shadow-light);
            box-sizing: border-box;
            border: 1px solid var(--border-color); /* Border tipis */
        }

        .product-section h3, .supplier-section h3 {
            margin-top: 0;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--light-green);
            padding-bottom: 8px;
            font-size: 1.3em;
        }

        .menu-list-container {
            padding: 0;
            overflow-y: visible; /* Biarkan overflow visible, scroll jika konten banyak */
        }
        .menu-item-card,
        .supplier-item-card { /* Combined styling for product and supplier cards */
            display: flex;
            align-items: center;
            background-color: var(--card-bg); /* Menggunakan warna kartu */
            border: 1px solid var(--border-color);
            border-radius: 12px; /* Sudut lebih membulat */
            padding: 15px; /* Padding lebih besar */
            margin-bottom: 15px; /* Jarak antar kartu lebih besar */
            box-shadow: 0 2px 6px var(--shadow-light); /* Bayangan halus */
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }
        .menu-item-card:hover,
        .supplier-item-card:hover {
            transform: translateY(-3px); /* Naik lebih tinggi saat hover */
            box-shadow: 0 4px 10px var(--shadow-light); /* Bayangan lebih jelas saat hover */
        }
        
        .menu-item-details,
        .supplier-item-details { /* Combined styling for details */
            flex-grow: 1;
            margin-right: 15px; /* Jarak ke toggle */
        }
        .menu-item-details h3,
        .supplier-item-details h3 {
            font-size: 16px; /* Ukuran font judul item lebih besar */
            margin: 0 0 8px; /* Jarak bawah lebih besar */
            color: var(--primary-green);
            font-weight: 600;
            white-space: nowrap; /* Pastikan tidak pecah baris */
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .menu-item-details .price {
            font-size: 15px; /* Ukuran font harga lebih besar */
            font-weight: 700;
            color: var(--text-dark);
            margin: 0;
        }
        .supplier-item-details p {
            font-size: 14px; /* Ukuran font info supplier lebih besar */
            color: var(--text-light);
            margin: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .item-toggle-switch {
            position: relative;
            display: inline-block;
            width: 45px; /* Lebar switch lebih besar */
            height: 26px; /* Tinggi switch lebih besar */
            flex-shrink: 0;
        }
        .item-toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .item-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 26px; /* Sudut membulat */
        }
        .item-slider:before {
            position: absolute;
            content: "";
            height: 18px; /* Ukuran lingkaran lebih besar */
            width: 18px; /* Ukuran lingkaran lebih besar */
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .item-slider {
            background-color: var(--primary-green);
        }
        input:checked + .item-slider:before {
            transform: translateX(19px); /* Jarak geser disesuaikan */
        }
        .menu-loading-message {
            text-align: center;
            padding: 30px; /* Padding lebih besar */
            color: var(--text-light);
            font-size: 1.2em;
            font-style: italic;
        }

        /* Modal for Add/Edit Product Form */
        #productFormModal, #supplierFormModal { /* Combined styling for modals */
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6); /* Background lebih gelap */
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        #productFormModal .modal-content, #supplierFormModal .modal-content {
            background-color: var(--card-bg);
            padding: 35px; /* Padding lebih besar */
            border-radius: 18px; /* Sudut lebih membulat */
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25); /* Bayangan lebih jelas */
            width: 90%;
            max-width: 550px; /* Lebar maksimum lebih besar */
            box-sizing: border-box;
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
        }
        #productFormModal .close-modal-btn, #supplierFormModal .close-modal-btn {
            position: absolute;
            top: 15px; /* Posisi lebih masuk */
            right: 20px; /* Posisi lebih masuk */
            font-size: 28px; /* Ukuran ikon lebih besar */
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-light);
            transition: color 0.2s;
        }
        #productFormModal .close-modal-btn:hover, #supplierFormModal .close-modal-btn:hover {
            color: var(--red-alert);
        }
        #productFormModal h3, #supplierFormModal h3 {
            text-align: center;
            color: var(--primary-green);
            margin-bottom: 25px; /* Jarak lebih besar */
            font-size: 22px; /* Ukuran font lebih besar */
            font-weight: 500;
            border-bottom: none; /* Hilangkan border */
            padding-bottom: 0;
        }
        #productFormModal .form-group, #supplierFormModal .form-group {
            margin-bottom: 20px; /* Jarak antar grup form lebih besar */
        }
        #productFormModal .form-group label, #supplierFormModal .form-group label {
            display: block;
            font-size: 14px;
            color: var(--text-dark);
            margin-bottom: 8px; /* Jarak label-input lebih besar */
            font-weight: 500;
        }
        #productFormModal input[type="text"],
        #productFormModal input[type="number"],
        #productFormModal textarea,
        #supplierFormModal input[type="text"],
        #supplierFormModal textarea {
            width: 100%;
            padding: 12px; /* Padding lebih besar */
            border: 1px solid var(--border-color);
            border-radius: 8px; /* Sudut lebih membulat */
            font-size: 15px; /* Ukuran font lebih besar */
            box-sizing: border-box;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        #productFormModal input[type="text"]:focus,
        #productFormModal input[type="number"]:focus,
        #productFormModal textarea:focus,
        #supplierFormModal input[type="text"]:focus,
        #supplierFormModal textarea:focus {
            border-color: var(--primary-green);
            box-shadow: 0 0 0 3px rgba(102, 187, 106, 0.2);
            outline: none;
        }
        #productFormModal textarea, #supplierFormModal textarea {
            resize: vertical;
            min-height: 90px;
        }
        #productFormModal .checkbox-group {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        #productFormModal .checkbox-group input[type="checkbox"] {
            margin-right: 12px;
            transform: scale(1.3); /* Ukuran checkbox lebih besar */
        }
        #productFormModal .checkbox-group label {
            margin-bottom: 0;
            font-size: 15px;
            font-weight: normal;
            color: var(--text-dark);
        }
        #productFormModal .button-group, #supplierFormModal .button-group {
            display: flex;
            justify-content: flex-end;
            gap: 12px; /* Jarak antar tombol */
            margin-top: 25px; /* Jarak dari form */
        }
        #productFormModal .btn, #supplierFormModal .btn {
            padding: 12px 25px; /* Padding lebih besar */
            border: none;
            border-radius: 10px; /* Sudut lebih membulat */
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 2px 6px var(--shadow-light); /* Bayangan halus */
        }
        #productFormModal .btn-primary, #supplierFormModal .btn-primary {
            background-color: var(--primary-green);
            color: white;
        }
        #productFormModal .btn-primary:hover, #supplierFormModal .btn-primary:hover {
            background-color: var(--dark-green);
            transform: translateY(-1px);
            box-shadow: 0 4px 10px var(--shadow-light);
        }
        #productFormModal .btn-secondary, #supplierFormModal .btn-secondary {
            background-color: var(--bg-light);
            color: var(--text-dark);
        }
        #productFormModal .btn-secondary:hover, #supplierFormModal .btn-secondary:hover {
            background-color: #E0E0E0;
            transform: translateY(-1px);
            box-shadow: 0 4px 10px var(--shadow-light);
        }

        /* Custom Alert/Confirm Modals (reused) */
        #customAlertDialog, #customConfirmModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6); /* Background lebih gelap */
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }
        #customAlertDialog > div, #customConfirmModal > div {
            background-color: var(--card-bg);
            padding: 30px; /* Padding lebih besar */
            border-radius: 15px; /* Sudut membulat */
            box-shadow: 0 8px 25px rgba(0,0,0,0.3); /* Bayangan lebih jelas */
            text-align: center;
            max-width: 350px; /* Lebar maksimal lebih besar */
        }
        #customAlertDialog p, #customConfirmModal p {
            margin-bottom: 25px; /* Jarak lebih besar */
            font-size: 17px; /* Ukuran font lebih besar */
            color: var(--text-dark);
            font-weight: 500;
        }
        #customAlertDialog button, #customConfirmModal button {
            background-color: var(--primary-green);
            color: white;
            border: none;
            padding: 12px 25px; /* Padding lebih besar */
            border-radius: 10px; /* Sudut membulat */
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.2s, transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 2px 6px var(--shadow-light);
        }
        #customAlertDialog button:hover {
            background-color: var(--dark-green);
            transform: translateY(-1px);
            box-shadow: 0 4px 10px var(--shadow-light);
        }
        #customConfirmModal button#customConfirmYes {
            background-color: var(--primary-green);
        }
        #customConfirmModal button#customConfirmYes:hover {
            background-color: var(--dark-green);
        }
        #customConfirmModal button#customConfirmNo {
            background-color: var(--red-alert); /* Warna merah yang disesuaikan */
            margin-left: 15px; /* Jarak lebih besar */
        }
        #customConfirmModal button#customConfirmNo:hover {
            background-color: var(--red-dark);
        }

        /* Loading Spinner */
        #loadingSpinner {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.9); /* Sedikit lebih opaque */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1001;
            font-size: 26px; /* Ukuran font lebih besar */
            color: var(--primary-green);
            flex-direction: column; /* Untuk teks di bawah spinner */
            gap: 10px;
        }
        #loadingSpinner .spinner {
            border: 5px solid rgba(0, 0, 0, 0.1); /* Border spinner lebih tebal */
            border-left-color: var(--primary-green);
            border-radius: 50%;
            width: 40px; /* Ukuran spinner lebih besar */
            height: 40px; /* Ukuran spinner lebih besar */
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        #loadingSpinner p {
            margin: 0;
            font-size: 1.1em;
            color: var(--text-dark);
        }
    </style>
</head>
<body>
    <header class="app-header-combined">
        <h1><i class="fas fa-leaf leaf-icon"></i> RUJAK BUAH INDONESIA</h1>
        <button onclick="logout()" class="logout-button">
            <i class="fas fa-sign-out-alt"></i> Logout
        </button>
    </header>

    <div class="main-container">
        <div class="panel" id="supplierOrderPanel">
            <h2>Buat Pesanan ke Supplier</h2>

            <div class="form-group">
                <label for="supplierNameOrderInput">Nama Supplier:</label>
                <div class="autocomplete">
                    <input type="text" id="supplierNameOrderInput" placeholder="Cari atau masukkan nama supplier" autocomplete="off">
                    <div id="supplierNameOrderAutocompleteList" class="autocomplete-items"></div>
                    <span class="material-icons dropdown-arrow-icon" id="supplierDropdownArrow">arrow_drop_down</span>
                </div>
            </div>
            
            <div class="supplier-info" id="supplierInfo">Pilih supplier untuk memulai pesanan.</div>

            <div class="form-group">
                <label for="productNameInput">Nama Produk:</label>
                <div class="autocomplete">
                    <input type="text" id="productNameInput" placeholder="Cari atau masukkan nama produk" autocomplete="off">
                    <div id="productNameAutocompleteList" class="autocomplete-items"></div>
                </div>
            </div>
            <div class="form-group">
                <label for="quantityInput">Jumlah:</label>
                <input type="text" id="quantityInput" placeholder="Contoh: 5 KG, 10 Buah">
            </div>
            <div class="button-group">
                <button id="tambahProdukBtn" disabled>Tambah ke Daftar</button>
                <button id="clearAllBtn" disabled>Hapus Semua</button>
                <button id="kirimWhatsAppBtn" disabled>Kirim Pesanan via WhatsApp</button>
            </div>
            
            <table>
                <thead>
                    <tr>
                        <th>No</th>
                        <th>Nama Produk</th>
                        <th>Jumlah</th>
                        <th>Aksi</th>
                    </tr>
                </thead>
                <tbody id="orderItemsTableBody">
                    </tbody>
            </table>
            <p class="empty-state" id="emptyOrderItemsMessage">Daftar pesanan masih kosong.</p>
        </div>

        <div class="panel" id="productManagementPanel">
            <h2>Manajemen Data Produk & Supplier</h2>

            <div class="product-supplier-lists-wrapper">
                <div class="product-section">
                    <h3>Daftar Produk</h3>
                    <div class="top-actions">
                        <div class="search-bar-container">
                            <div class="search-bar">
                                <span class="material-icons">search</span>
                                <input type="text" id="productSearchInput" placeholder="Cari nama produk">
                            </div>
                        </div>
                        <button id="addTopProductBtn">
                            <span class="material-icons">add</span> Tambah Produk Baru
                        </button>
                    </div>
                    <div class="menu-list-container">
                        <div class="menu-items" id="productList">
                            <p class="menu-loading-message">Memuat daftar produk...</p>
                        </div>
                    </div>
                </div>

                <div class="supplier-section">
                    <h3>Daftar Supplier</h3>
                    <div class="top-actions">
                        <div class="search-bar-container">
                            <div class="search-bar">
                                <span class="material-icons">search</span>
                                <input type="text" id="supplierSearchInput" placeholder="Cari nama supplier">
                            </div>
                        </div>
                        <button id="addTopSupplierBtn">
                            <span class="material-icons">add</span> Tambah Supplier Baru
                        </button>
                    </div>
                    <div class="menu-list-container">
                        <div class="menu-items" id="supplierList">
                            <p class="menu-loading-message">Memuat daftar supplier...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="productFormModal" style="display: none;">
        <div class="modal-content">
            <button class="close-modal-btn">&times;</button>
            <h3 id="productModalTitle">Tambah Produk Baru</h3>
            <form id="productForm">
                <div class="form-group">
                    <label for="productIdInput">ID Produk:</label>
                    <input type="text" id="productIdInput" placeholder="Otomatis terisi" disabled>
                </div>
                <div class="form-group">
                    <label for="productNameModalInput">Nama Produk:</label>
                    <input type="text" id="productNameModalInput" required>
                </div>
                <div class="form-group">
                    <label for="productPriceInput">Harga per unit (Rp):</label>
                    <input type="number" id="productPriceInput" min="0" required>
                </div>
                <div class="form-group">
                    <label for="productDescriptionInput">Deskripsi:</label>
                    <textarea id="productDescriptionInput" placeholder="Deskripsi produk"></textarea>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="productStatusToggle">
                    <label for="productStatusToggle">Aktif (Tersedia untuk penjualan)</label>
                </div>
                <div class="button-group">
                    <button type="button" class="btn btn-secondary close-modal-btn">Batal</button>
                    <button type="submit" class="btn btn-primary" id="saveProductBtn">Simpan</button>
                </div>
            </form>
        </div>
    </div>

    <div id="supplierFormModal" style="display: none;">
        <div class="modal-content">
            <button class="close-modal-btn">&times;</button>
            <h3 id="supplierModalTitle">Tambah Supplier Baru</h3>
            <form id="supplierForm">
                <div class="form-group">
                    <label for="supplierNameModalInput">Nama Supplier:</label>
                    <input type="text" id="supplierNameModalInput" required>
                </div>
                <div class="form-group">
                    <label for="supplierContactInput">Kontak (No. HP/Telepon):</label>
                    <input type="text" id="supplierContactInput" required>
                </div>
                <div class="form-group">
                    <label for="supplierAddressInput">Alamat:</label>
                    <textarea id="supplierAddressInput" placeholder="Alamat lengkap supplier"></textarea>
                </div>
                <div class="button-group">
                    <button type="button" class="btn btn-secondary close-modal-btn">Batal</button>
                    <button type="submit" class="btn btn-primary" id="saveSupplierBtn">Simpan</button>
                </div>
            </form>
        </div>
    </div>

    <div id="customAlertDialog" style="display: none;">
        <div>
            <p id="alertDialogMessage"></p>
            <button id="alertDialogOk">OK</button>
        </div>
    </div>

    <div id="customConfirmModal" style="display: none;">
        <div>
            <p id="confirmDialogMessage"></p>
            <button id="customConfirmYes">Ya</button>
            <button id="customConfirmNo">Tidak</button>
        </div>
    </div>

    <div id="loadingSpinner" style="display: none;">
        <div class="spinner"></div>
        <p id="loadingMessage">Memuat...</p>
    </div>

    <script>
        // --- Firebase Configuration ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyCeqHW_m9kru2vmEDVSoelZ3UWFD4k4Xqc",
            authDomain: "tokobuahkasir.firebaseapp.com",
            projectId: "tokobuahkasir",
            storageBucket: "tokobuahkasir.firebasestorage.app",
            messagingSenderId: "731011133713",
            appId: "1:731011133713:web:4247ae627401a01b8c1cb0",
            measurementId: "G-7CPE2DB2BV"
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? initialAuthToken : null;

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- Firestore Collections ---
        const productsCollection = db.collection('products');
        const suppliersCollection = db.collection('suppliers');

        // --- DOM Elements ---
        // Supplier Order Panel
        const supplierNameOrderInput = document.getElementById('supplierNameOrderInput');
        const supplierNameOrderAutocompleteList = document.getElementById('supplierNameOrderAutocompleteList');
        const supplierDropdownArrow = document.getElementById('supplierDropdownArrow');
        const supplierInfo = document.getElementById('supplierInfo');
        const productNameInput = document.getElementById('productNameInput');
        const productNameAutocompleteList = document.getElementById('productNameAutocompleteList');
        const quantityInput = document.getElementById('quantityInput');
        const tambahProdukBtn = document.getElementById('tambahProdukBtn');
        const clearAllBtn = document.getElementById('clearAllBtn');
        const kirimWhatsAppBtn = document.getElementById('kirimWhatsAppBtn');
        const orderItemsTableBody = document.getElementById('orderItemsTableBody');
        const emptyOrderItemsMessage = document.getElementById('emptyOrderItemsMessage');

        // Product Management Panel
        const productSearchInput = document.getElementById('productSearchInput');
        const addTopProductBtn = document.getElementById('addTopProductBtn');
        const productList = document.getElementById('productList');

        // Supplier Management Panel
        const supplierSearchInput = document.getElementById('supplierSearchInput');
        const addTopSupplierBtn = document.getElementById('addTopSupplierBtn');
        const supplierList = document.getElementById('supplierList');

        // Product Form Modal
        const productFormModal = document.getElementById('productFormModal');
        const productModalTitle = document.getElementById('productModalTitle');
        const productForm = document.getElementById('productForm');
        const productIdInput = document.getElementById('productIdInput');
        const productNameModalInput = document.getElementById('productNameModalInput');
        const productPriceInput = document.getElementById('productPriceInput');
        const productDescriptionInput = document.getElementById('productDescriptionInput');
        const productStatusToggle = document.getElementById('productStatusToggle');
        const saveProductBtn = document.getElementById('saveProductBtn');

        // Supplier Form Modal
        const supplierFormModal = document.getElementById('supplierFormModal');
        const supplierModalTitle = document.getElementById('supplierModalTitle');
        const supplierForm = document.getElementById('supplierForm');
        const supplierNameModalInput = document.getElementById('supplierNameModalInput');
        const supplierContactInput = document.getElementById('supplierContactInput');
        const supplierAddressInput = document.getElementById('supplierAddressInput');
        const saveSupplierBtn = document.getElementById('saveSupplierBtn');

        // Custom Dialogs
        const customAlertDialog = document.getElementById('customAlertDialog');
        const alertDialogMessage = document.getElementById('alertDialogMessage');
        const alertDialogOk = document.getElementById('alertDialogOk');
        const customConfirmModal = document.getElementById('customConfirmModal');
        const confirmDialogMessage = document.getElementById('confirmDialogMessage');
        const customConfirmYes = document.getElementById('customConfirmYes');
        const customConfirmNo = document.getElementById('customConfirmNo');

        // Loading Spinner
        const loadingSpinner = document.getElementById('loadingSpinner');
        const loadingMessage = document.getElementById('loadingMessage');

        // --- Global Variables ---
        let currentSelectedSupplier = null;
        let currentOrderItems = []; // { productId, productName, quantity, productPrice }
        let products = []; // Cache for products
        let suppliers = []; // Cache for suppliers
        let editProductId = null; // Used for product form
        let editSupplierId = null; // Used for supplier form

        // --- Utility Functions ---
        function showLoading(message = 'Memuat...') {
            loadingMessage.textContent = message;
            loadingSpinner.style.display = 'flex';
        }

        function hideLoading() {
            loadingSpinner.style.display = 'none';
        }

        function showAlertDialog(message) {
            alertDialogMessage.textContent = message;
            customAlertDialog.style.display = 'flex';
        }

        function showConfirmDialog(message) {
            return new Promise(resolve => {
                confirmDialogMessage.textContent = message;
                customConfirmModal.style.display = 'flex';

                const onConfirm = () => {
                    customConfirmYes.removeEventListener('click', onConfirm);
                    customConfirmNo.removeEventListener('click', onCancel);
                    customConfirmModal.style.display = 'none';
                    resolve(true);
                };

                const onCancel = () => {
                    customConfirmYes.removeEventListener('click', onConfirm);
                    customConfirmNo.removeEventListener('click', onCancel);
                    customConfirmModal.style.display = 'none';
                    resolve(false);
                };

                customConfirmYes.addEventListener('click', onConfirm);
                customConfirmNo.addEventListener('click', onCancel);
            });
        }

        function formatRupiah(number) {
            return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(number);
        }

        // --- Authentication ---
        function logout() {
            auth.signOut().then(() => {
                window.location.href = 'index.html'; // Redirect to login/home page
            }).catch((error) => {
                console.error("Error signing out: ", error);
                showAlertDialog("Gagal logout. Silakan coba lagi.");
            });
        }

        // Check auth state on load
        auth.onAuthStateChanged(user => {
            if (!user) {
                // If no user is logged in, attempt anonymous login
                auth.signInAnonymously().catch(error => {
                    console.error("Error signing in anonymously:", error);
                    showAlertDialog("Gagal masuk secara anonim. Silakan coba refresh halaman.");
                });
            }
            // If user exists (either logged in or anonymous), proceed with dashboard functions
        });


        // --- Supplier Order Panel Functions ---

        // Autocomplete for Supplier Name
        let currentFocusSupplier = -1;
        let supplierSuggestions = [];

        function populateSupplierSuggestions(inputVal) {
            supplierNameOrderAutocompleteList.innerHTML = '';
            currentFocusSupplier = -1;

            const filteredSuggestions = suppliers.filter(s =>
                s.name.toLowerCase().includes(inputVal.toLowerCase())
            );

            if (filteredSuggestions.length === 0 && inputVal.length > 0) {
                const noResultItem = document.createElement('div');
                noResultItem.classList.add('autocomplete-item');
                noResultItem.textContent = 'Tidak ada supplier ditemukan. Anda bisa input nama baru.';
                supplierNameOrderAutocompleteList.appendChild(noResultItem);
                supplierSuggestions = []; // Clear suggestions
                return;
            }

            filteredSuggestions.forEach(supplier => {
                const div = document.createElement('div');
                div.classList.add('autocomplete-item');
                div.innerHTML = `<strong>${supplier.name.substr(0, inputVal.length)}</strong>${supplier.name.substr(inputVal.length)}`;
                div.addEventListener('click', () => {
                    supplierNameOrderInput.value = supplier.name;
                    currentSelectedSupplier = supplier;
                    supplierInfo.textContent = `Supplier terpilih: ${supplier.name} (${supplier.contact})`;
                    supplierNameOrderAutocompleteList.innerHTML = ''; // Clear suggestions
                    updateOrderPanelButtons();
                });
                supplierNameOrderAutocompleteList.appendChild(div);
            });
            supplierSuggestions = filteredSuggestions;
        }

        supplierNameOrderInput.addEventListener('input', function() {
            populateSupplierSuggestions(this.value);
            // Clear selected supplier if input changes
            if (currentSelectedSupplier && currentSelectedSupplier.name !== this.value) {
                currentSelectedSupplier = null;
                supplierInfo.textContent = 'Pilih supplier untuk memulai pesanan.';
                updateOrderPanelButtons();
            }
        });

        supplierNameOrderInput.addEventListener('keydown', function(e) {
            const items = supplierNameOrderAutocompleteList.getElementsByTagName('div');
            if (e.keyCode == 40) { // Down arrow
                currentFocusSupplier++;
                addActive(items, currentFocusSupplier);
            } else if (e.keyCode == 38) { // Up arrow
                currentFocusSupplier--;
                addActive(items, currentFocusSupplier);
            } else if (e.keyCode == 13) { // Enter key
                e.preventDefault();
                if (currentFocusSupplier > -1 && items[currentFocusSupplier]) {
                    items[currentFocusSupplier].click();
                } else if (this.value.trim() !== '') {
                    // If enter is pressed and no item selected, treat as new supplier
                    currentSelectedSupplier = { id: 'new_' + this.value.replace(/\s/g, '_'), name: this.value.trim(), contact: 'Tidak ada kontak', address: '' };
                    supplierInfo.textContent = `Supplier baru: ${currentSelectedSupplier.name}`;
                    supplierNameOrderAutocompleteList.innerHTML = '';
                    updateOrderPanelButtons();
                }
            }
        });

        supplierDropdownArrow.addEventListener('click', () => {
            if (supplierNameOrderAutocompleteList.innerHTML === '') {
                populateSupplierSuggestions(''); // Show all on arrow click
            } else {
                supplierNameOrderAutocompleteList.innerHTML = ''; // Hide if already open
            }
        });

        // Autocomplete for Product Name (Order Panel)
        let currentFocusProduct = -1;
        let productOrderSuggestions = [];

        function populateProductSuggestions(inputVal) {
            productNameAutocompleteList.innerHTML = '';
            currentFocusProduct = -1;

            const filteredSuggestions = products.filter(p =>
                p.name.toLowerCase().includes(inputVal.toLowerCase()) && p.status === true
            );

            if (filteredSuggestions.length === 0 && inputVal.length > 0) {
                const noResultItem = document.createElement('div');
                noResultItem.classList.add('autocomplete-item');
                noResultItem.textContent = 'Tidak ada produk aktif ditemukan.';
                productNameAutocompleteList.appendChild(noResultItem);
                productOrderSuggestions = []; // Clear suggestions
                return;
            }

            filteredSuggestions.forEach(product => {
                const div = document.createElement('div');
                div.classList.add('autocomplete-item');
                div.innerHTML = `<strong>${product.name.substr(0, inputVal.length)}</strong>${product.name.substr(inputVal.length)} <span style="float:right; color:${var_text_light}; font-size:0.9em;">${formatRupiah(product.price)}</span>`;
                div.addEventListener('click', () => {
                    productNameInput.value = product.name;
                    productNameInput.dataset.productId = product.id; // Store product ID
                    productNameInput.dataset.productPrice = product.price; // Store product price
                    productNameAutocompleteList.innerHTML = '';
                    updateOrderPanelButtons();
                });
                productNameAutocompleteList.appendChild(div);
            });
            productOrderSuggestions = filteredSuggestions;
        }

        productNameInput.addEventListener('input', function() {
            populateProductSuggestions(this.value);
            // Clear product ID and price if input changes
            if (this.dataset.productId && products.find(p => p.id === this.dataset.productId)?.name !== this.value) {
                delete this.dataset.productId;
                delete this.dataset.productPrice;
            }
            updateOrderPanelButtons();
        });

        productNameInput.addEventListener('keydown', function(e) {
            const items = productNameAutocompleteList.getElementsByTagName('div');
            if (e.keyCode == 40) { // Down arrow
                currentFocusProduct++;
                addActive(items, currentFocusProduct);
            } else if (e.keyCode == 38) { // Up arrow
                currentFocusProduct--;
                addActive(items, currentFocusProduct);
            } else if (e.keyCode == 13) { // Enter key
                e.preventDefault();
                if (currentFocusProduct > -1 && items[currentFocusProduct]) {
                    items[currentFocusProduct].click();
                }
            }
        });

        // Helper for autocomplete active state
        function addActive(x, currentFocus) {
            if (!x) return false;
            removeActive(x);
            if (currentFocus >= x.length) currentFocus = 0;
            if (currentFocus < 0) currentFocus = (x.length - 1);
            x[currentFocus].classList.add("autocomplete-active");
        }

        function removeActive(x) {
            for (let i = 0; i < x.length; i++) {
                x[i].classList.remove("autocomplete-active");
            }
        }

        document.addEventListener('click', function (e) {
            if (e.target !== supplierNameOrderInput && e.target !== supplierDropdownArrow) {
                supplierNameOrderAutocompleteList.innerHTML = '';
            }
            if (e.target !== productNameInput) {
                productNameAutocompleteList.innerHTML = '';
            }
        });

        // Add Product to Order List
        tambahProdukBtn.addEventListener('click', () => {
            const pName = productNameInput.value.trim();
            const pId = productNameInput.dataset.productId;
            const pPrice = parseFloat(productNameInput.dataset.productPrice);
            const qty = quantityInput.value.trim();

            if (!currentSelectedSupplier) {
                showAlertDialog("Pilih atau masukkan nama supplier terlebih dahulu.");
                return;
            }
            if (!pName || !qty) {
                showAlertDialog("Nama produk dan jumlah tidak boleh kosong.");
                return;
            }
            if (!pId || isNaN(pPrice)) {
                // If product doesn't have an ID or price, it's likely a new, non-master product
                // Or a typo, or not selected from autocomplete
                // For simplicity, we can let it pass as a "custom" item, but warn if it's supposed to be from master
                const existingProduct = products.find(p => p.name.toLowerCase() === pName.toLowerCase());
                if (existingProduct) {
                    showAlertDialog("Produk tidak dipilih dari daftar. Silakan pilih dari saran atau cek kembali nama produk.");
                    return;
                }
                // If it's truly a new product not in master, handle it as a free text item
                // For this scenario, we assume all products should be from master for pricing.
                // If custom pricing/products are allowed, adjust logic here.
                showAlertDialog("Produk tidak valid atau tidak memiliki harga master. Pastikan Anda memilih produk dari daftar.");
                return;
            }

            const existingItemIndex = currentOrderItems.findIndex(item => item.productId === pId && item.quantity === qty);

            if (existingItemIndex > -1) {
                showAlertDialog("Produk dengan jumlah yang sama sudah ada di daftar.");
                return;
            }

            currentOrderItems.push({
                productId: pId,
                productName: pName,
                quantity: qty,
                productPrice: pPrice // Store price for reference
            });

            renderOrderItemsTable();
            productNameInput.value = '';
            quantityInput.value = '';
            delete productNameInput.dataset.productId;
            delete productNameInput.dataset.productPrice;
            updateOrderPanelButtons();
        });

        function renderOrderItemsTable() {
            orderItemsTableBody.innerHTML = '';
            if (currentOrderItems.length === 0) {
                emptyOrderItemsMessage.style.display = 'block';
                return;
            } else {
                emptyOrderItemsMessage.style.display = 'none';
            }

            currentOrderItems.forEach((item, index) => {
                const row = orderItemsTableBody.insertRow();
                row.insertCell(0).textContent = index + 1;
                row.insertCell(1).textContent = item.productName;
                row.insertCell(2).textContent = item.quantity;
                const actionCell = row.insertCell(3);

                const editButton = document.createElement('button');
                editButton.classList.add('edit-item-btn');
                editButton.textContent = 'Edit';
                editButton.addEventListener('click', () => editOrderItem(index));
                actionCell.appendChild(editButton);

                const deleteButton = document.createElement('button');
                deleteButton.classList.add('delete-item-btn');
                deleteButton.textContent = 'Hapus';
                deleteButton.addEventListener('click', () => deleteOrderItem(index));
                actionCell.appendChild(deleteButton);
            });
        }

        function editOrderItem(index) {
            const item = currentOrderItems[index];
            if (item._isEditing) return; // Prevent multiple edits on same row

            item._isEditing = true; // Mark as editing

            const row = orderItemsTableBody.rows[index];
            const cells = row.cells;

            const oldProductName = cells[1].textContent;
            const oldQuantity = cells[2].textContent;

            cells[1].innerHTML = `<input type="text" value="${oldProductName}" class="edit-product-name" style="width:120px;">`;
            cells[2].innerHTML = `<input type="text" value="${oldQuantity}" class="edit-quantity" style="width:80px;">`;

            actionCell = cells[3];
            actionCell.innerHTML = ''; // Clear existing buttons

            const saveButton = document.createElement('button');
            saveButton.classList.add('save-item-btn');
            saveButton.textContent = 'Simpan';
            saveButton.addEventListener('click', () => saveOrderItem(index, oldProductName, oldQuantity));
            actionCell.appendChild(saveButton);

            const cancelButton = document.createElement('button');
            cancelButton.classList.add('cancel-edit-btn');
            cancelButton.textContent = 'Batal';
            cancelButton.addEventListener('click', () => cancelEditOrderItem(index));
            actionCell.appendChild(cancelButton);

            // Focus on the product name input
            const editProductNameInput = cells[1].querySelector('.edit-product-name');
            if (editProductNameInput) {
                editProductNameInput.focus();
                // Add autocomplete for edited product name
                let currentEditProductFocus = -1;
                let editProductSuggestions = [];

                editProductNameInput.addEventListener('input', function() {
                    const editProductAutocompleteList = document.createElement('div');
                    editProductAutocompleteList.classList.add('autocomplete-items');
                    editProductNameInput.parentNode.appendChild(editProductAutocompleteList);
                    editProductAutocompleteList.style.position = 'absolute';
                    editProductAutocompleteList.style.top = '100%';
                    editProductAutocompleteList.style.left = '0';
                    editProductAutocompleteList.style.right = '0';
                    editProductAutocompleteList.style.maxHeight = '150px';
                    editProductAutocompleteList.style.overflowY = 'auto';
                    editProductAutocompleteList.style.zIndex = '100';


                    editProductAutocompleteList.innerHTML = '';
                    currentEditProductFocus = -1;

                    const inputVal = this.value.trim().toLowerCase();
                    const filteredSuggestions = products.filter(p =>
                        p.name.toLowerCase().includes(inputVal) && p.status === true
                    );

                    if (filteredSuggestions.length === 0 && inputVal.length > 0) {
                        const noResultItem = document.createElement('div');
                        noResultItem.classList.add('autocomplete-item');
                        noResultItem.textContent = 'Tidak ada produk aktif ditemukan.';
                        editProductAutocompleteList.appendChild(noResultItem);
                        editProductSuggestions = [];
                        return;
                    }

                    filteredSuggestions.forEach(p => {
                        const div = document.createElement('div');
                        div.classList.add('autocomplete-item');
                        div.innerHTML = `<strong>${p.name.substr(0, inputVal.length)}</strong>${p.name.substr(inputVal.length)} <span style="float:right; color:${var_text_light}; font-size:0.9em;">${formatRupiah(p.price)}</span>`;
                        div.addEventListener('click', () => {
                            editProductNameInput.value = p.name;
                            editProductNameInput.dataset.productId = p.id;
                            editProductNameInput.dataset.productPrice = p.price;
                            editProductAutocompleteList.remove();
                        });
                        editProductAutocompleteList.appendChild(div);
                    });
                    editProductSuggestions = filteredSuggestions;
                });

                editProductNameInput.addEventListener('keydown', function(e) {
                    const editProductAutocompleteList = editProductNameInput.parentNode.querySelector('.autocomplete-items');
                    if (!editProductAutocompleteList) return;

                    const items = editProductAutocompleteList.getElementsByTagName('div');
                    if (e.keyCode == 40) { // Down arrow
                        currentEditProductFocus++;
                        addActive(items, currentEditProductFocus);
                    } else if (e.keyCode == 38) { // Up arrow
                        currentEditProductFocus--;
                        addActive(items, currentEditProductFocus);
                    } else if (e.keyCode == 13) { // Enter key
                        e.preventDefault();
                        if (currentEditProductFocus > -1 && items[currentEditProductFocus]) {
                            items[currentEditProductFocus].click();
                        }
                    }
                });

                document.addEventListener('click', function(e) {
                    if (e.target !== editProductNameInput && !e.target.closest('.autocomplete-items')) {
                        const existingList = editProductNameInput.parentNode.querySelector('.autocomplete-items');
                        if (existingList) existingList.remove();
                    }
                });
            }
        }

        function saveOrderItem(index, originalProductName, originalQuantity) {
            const row = orderItemsTableBody.rows[index];
            const newProductNameInput = row.querySelector('.edit-product-name');
            const newQuantityInput = row.querySelector('.edit-quantity');

            const newProductName = newProductNameInput.value.trim();
            const newProductId = newProductNameInput.dataset.productId;
            const newProductPrice = parseFloat(newProductNameInput.dataset.productPrice);
            const newQuantity = newQuantityInput.value.trim();

            if (!newProductName || !newQuantity) {
                showAlertDialog("Nama produk dan jumlah tidak boleh kosong.");
                return;
            }

            // Optional: Validate if new product name corresponds to an existing master product if an ID was provided
            if (newProductId && isNaN(newProductPrice)) {
                 showAlertDialog("Produk tidak valid atau tidak memiliki harga master. Pastikan Anda memilih produk dari daftar.");
                 return;
            }

            // Check for duplicates (excluding current item being edited)
            const isDuplicate = currentOrderItems.some((item, i) =>
                i !== index && item.productName === newProductName && item.quantity === newQuantity
            );

            if (isDuplicate) {
                showAlertDialog("Produk dengan nama dan jumlah yang sama sudah ada di daftar.");
                // Revert to original display if duplicate
                cancelEditOrderItem(index);
                return;
            }


            currentOrderItems[index] = {
                productId: newProductId || currentOrderItems[index].productId, // Keep old ID if new is not selected
                productName: newProductName,
                quantity: newQuantity,
                productPrice: newProductPrice || currentOrderItems[index].productPrice // Keep old price if new is not selected
            };
            delete currentOrderItems[index]._isEditing; // Remove editing flag

            renderOrderItemsTable(); // Re-render to update the display
            showAlertDialog("Item pesanan berhasil diperbarui.");
        }

        function cancelEditOrderItem(index) {
            delete currentOrderItems[index]._isEditing; // Remove editing flag
            renderOrderItemsTable(); // Re-render to revert to original display
            showAlertDialog("Pengeditan item dibatalkan.");
        }

        function deleteOrderItem(index) {
            showConfirmDialog("Yakin ingin menghapus item ini dari daftar pesanan?")
                .then(confirmed => {
                    if (confirmed) {
                        currentOrderItems.splice(index, 1);
                        renderOrderItemsTable();
                        updateOrderPanelButtons();
                        showAlertDialog("Item pesanan berhasil dihapus.");
                    }
                });
        }

        clearAllBtn.addEventListener('click', () => {
            showConfirmDialog("Yakin ingin menghapus semua item dari daftar pesanan?")
                .then(confirmed => {
                    if (confirmed) {
                        currentOrderItems = [];
                        renderOrderItemsTable();
                        updateOrderPanelButtons();
                        showAlertDialog("Semua item pesanan berhasil dihapus.");
                    }
                });
        });

        kirimWhatsAppBtn.addEventListener('click', () => {
            if (!currentSelectedSupplier || !currentSelectedSupplier.contact || currentOrderItems.length === 0) {
                showAlertDialog("Pilih supplier dengan kontak dan tambahkan produk ke daftar terlebih dahulu.");
                return;
            }

            let message = `*Pesanan Baru dari RUJAK BUAH INDONESIA*\n\n`;
            message += `Kepada Yth. Supplier: *${currentSelectedSupplier.name}*\n`;
            message += `Kontak: ${currentSelectedSupplier.contact}\n\n`;
            message += `Detail Pesanan:\n`;

            currentOrderItems.forEach((item, index) => {
                message += `${index + 1}. ${item.productName} - ${item.quantity}\n`;
            });

            message += `\nTerima kasih atas kerjasamanya!`;

            const whatsappUrl = `https://wa.me/${currentSelectedSupplier.contact.replace(/\D/g, '')}?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');

            // Clear the order after sending
            currentOrderItems = [];
            currentSelectedSupplier = null;
            supplierNameOrderInput.value = '';
            supplierInfo.textContent = 'Pilih supplier untuk memulai pesanan.';
            productNameInput.value = '';
            quantityInput.value = '';
            renderOrderItemsTable();
            updateOrderPanelButtons();
            showAlertDialog("Pesanan berhasil dikirim ke WhatsApp.");
        });

        function updateOrderPanelButtons() {
            const hasSupplier = !!currentSelectedSupplier;
            const hasProductName = productNameInput.value.trim() !== '' && (productNameInput.dataset.productId || !products.some(p => p.name.toLowerCase() === productNameInput.value.trim().toLowerCase() && p.status === true)); // Enable if product ID is selected or if it's a new "free text" product
            const hasQuantity = quantityInput.value.trim() !== '';
            const hasOrderItems = currentOrderItems.length > 0;

            tambahProdukBtn.disabled = !(hasProductName && hasQuantity);
            clearAllBtn.disabled = !hasOrderItems;
            kirimWhatsAppBtn.disabled = !hasOrderItems || !hasSupplier || !currentSelectedSupplier.contact;
        }


        // --- Product Management Functions ---

        async function loadProducts() {
            showLoading('Memuat daftar produk...');
            try {
                const snapshot = await productsCollection.orderBy('name').get();
                products = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderProducts();
            } catch (error) {
                console.error("Error loading products: ", error);
                showAlertDialog("Gagal memuat daftar produk.");
            } finally {
                hideLoading();
            }
        }

        function renderProducts() {
            const searchTerm = productSearchInput.value.toLowerCase();
            productList.innerHTML = '';
            let hasResults = false;

            products.forEach(product => {
                if (product.name.toLowerCase().includes(searchTerm)) {
                    hasResults = true;
                    const card = document.createElement('div');
                    card.classList.add('menu-item-card');
                    card.dataset.id = product.id; // Store Firestore ID

                    card.innerHTML = `
                        <div class="menu-item-details">
                            <h3>${product.name}</h3>
                            <p class="price">${formatRupiah(product.price)}</p>
                        </div>
                        <label class="item-toggle-switch">
                            <input type="checkbox" data-product-id="${product.id}" ${product.status ? 'checked' : ''}>
                            <span class="item-slider"></span>
                        </label>
                    `;
                    productList.appendChild(card);

                    // Add event listener for toggle switch
                    const toggleInput = card.querySelector('.item-toggle-switch input');
                    toggleInput.addEventListener('change', async (e) => {
                        const productId = e.target.dataset.productId;
                        const newStatus = e.target.checked;
                        try {
                            await productsCollection.doc(productId).update({ status: newStatus });
                            showAlertDialog(`Status produk "${product.name}" diubah menjadi ${newStatus ? 'Aktif' : 'Tidak Aktif'}.`);
                            // Re-cache products and re-render to reflect changes if needed
                            loadProducts();
                        } catch (error) {
                            console.error("Error updating product status:", error);
                            showAlertDialog("Gagal mengubah status produk.");
                            // Revert toggle if update fails
                            e.target.checked = !newStatus;
                        }
                    });

                    // Add event listener for card click to edit
                    card.addEventListener('click', (e) => {
                        // Prevent opening form when clicking on toggle switch itself
                        if (!e.target.closest('.item-toggle-switch')) {
                            openProductFormForEdit(product.id);
                        }
                    });
                }
            });

            if (!hasResults) {
                productList.innerHTML = '<p class="menu-loading-message">Tidak ada produk ditemukan.</p>';
            }
        }

        productSearchInput.addEventListener('input', renderProducts);

        addTopProductBtn.addEventListener('click', () => {
            openProductFormForAdd();
        });

        // --- Product Form Modal Functions ---
        function openProductFormForAdd() {
            productModalTitle.textContent = 'Tambah Produk Baru';
            productForm.reset();
            productIdInput.value = ''; // Ensure ID is empty for new product
            productStatusToggle.checked = true; // Default new product to active
            editProductId = null; // Clear edit ID
            productFormModal.style.display = 'flex';
        }

        async function openProductFormForEdit(id) {
            showLoading('Memuat data produk...');
            try {
                const doc = await productsCollection.doc(id).get();
                if (doc.exists) {
                    const productData = doc.data();
                    productModalTitle.textContent = 'Edit Produk';
                    productIdInput.value = id;
                    productNameModalInput.value = productData.name;
                    productPriceInput.value = productData.price;
                    productDescriptionInput.value = productData.description || '';
                    productStatusToggle.checked = productData.status;
                    editProductId = id;
                    productFormModal.style.display = 'flex';
                } else {
                    showAlertDialog('Produk tidak ditemukan.');
                }
            } catch (error) {
                console.error("Error loading product for edit:", error);
                showAlertDialog("Gagal memuat data produk untuk edit.");
            } finally {
                hideLoading();
            }
        }

        productForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = productIdInput.value;
            const name = productNameModalInput.value.trim();
            const price = parseFloat(productPriceInput.value);
            const description = productDescriptionInput.value.trim();
            const status = productStatusToggle.checked;

            if (!name || isNaN(price) || price < 0) {
                showAlertDialog("Nama produk dan harga harus diisi dengan benar.");
                return;
            }

            showLoading('Menyimpan produk...');
            try {
                if (editProductId) {
                    // Update existing product
                    await productsCollection.doc(editProductId).update({
                        name,
                        price,
                        description,
                        status
                    });
                    showAlertDialog('Produk berhasil diperbarui!');
                } else {
                    // Add new product
                    await productsCollection.add({
                        name,
                        price,
                        description,
                        status,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    showAlertDialog('Produk berhasil ditambahkan!');
                }
                productFormModal.style.display = 'none';
                loadProducts(); // Reload products to update the list
            } catch (error) {
                console.error("Error saving product:", error);
                showAlertDialog("Gagal menyimpan produk.");
            } finally {
                hideLoading();
            }
        });

        // Close modal buttons
        document.querySelectorAll('.close-modal-btn').forEach(button => {
            button.addEventListener('click', () => {
                productFormModal.style.display = 'none';
                supplierFormModal.style.display = 'none';
                // Also remove any temporary autocomplete list if present
                const tempAutocomplete = document.querySelector('.autocomplete-items');
                if (tempAutocomplete) tempAutocomplete.remove();
            });
        });

        alertDialogOk.addEventListener('click', () => {
            customAlertDialog.style.display = 'none';
        });


        // --- Supplier Management Functions ---

        async function loadSuppliers() {
            showLoading('Memuat daftar supplier...');
            try {
                const snapshot = await suppliersCollection.orderBy('name').get();
                suppliers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderSuppliers();
            } catch (error) {
                console.error("Error loading suppliers: ", error);
                showAlertDialog("Gagal memuat daftar supplier.");
            } finally {
                hideLoading();
            }
        }

        function renderSuppliers() {
            const searchTerm = supplierSearchInput.value.toLowerCase();
            supplierList.innerHTML = '';
            let hasResults = false;

            suppliers.forEach(supplier => {
                if (supplier.name.toLowerCase().includes(searchTerm)) {
                    hasResults = true;
                    const card = document.createElement('div');
                    card.classList.add('supplier-item-card');
                    card.dataset.id = supplier.id;

                    card.innerHTML = `
                        <div class="supplier-item-details">
                            <h3>${supplier.name}</h3>
                            <p>${supplier.contact || 'No Kontak'}</p>
                            <p>${supplier.address || 'No Alamat'}</p>
                        </div>
                    `;
                    supplierList.appendChild(card);

                    // Add event listener for card click to edit
                    card.addEventListener('click', () => {
                        openSupplierFormForEdit(supplier.id);
                    });
                }
            });

            if (!hasResults) {
                supplierList.innerHTML = '<p class="menu-loading-message">Tidak ada supplier ditemukan.</p>';
            }
        }

        supplierSearchInput.addEventListener('input', renderSuppliers);

        addTopSupplierBtn.addEventListener('click', () => {
            openSupplierFormForAdd();
        });


        // --- Supplier Form Modal Functions ---
        function openSupplierFormForAdd() {
            supplierModalTitle.textContent = 'Tambah Supplier Baru';
            supplierForm.reset();
            editSupplierId = null; // Clear edit ID
            supplierFormModal.style.display = 'flex';
        }

        async function openSupplierFormForEdit(id) {
            showLoading('Memuat data supplier...');
            try {
                const doc = await suppliersCollection.doc(id).get();
                if (doc.exists) {
                    const supplierData = doc.data();
                    supplierModalTitle.textContent = 'Edit Supplier';
                    supplierNameModalInput.value = supplierData.name;
                    supplierContactInput.value = supplierData.contact || '';
                    supplierAddressInput.value = supplierData.address || '';
                    editSupplierId = id;
                    supplierFormModal.style.display = 'flex';
                } else {
                    showAlertDialog('Supplier tidak ditemukan.');
                }
            } catch (error) {
                console.error("Error loading supplier for edit:", error);
                showAlertDialog("Gagal memuat data supplier untuk edit.");
            } finally {
                hideLoading();
            }
        }

        supplierForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = supplierNameModalInput.value.trim();
            const contact = supplierContactInput.value.trim();
            const address = supplierAddressInput.value.trim();

            if (!name || !contact) {
                showAlertDialog("Nama supplier dan kontak harus diisi.");
                return;
            }

            showLoading('Menyimpan supplier...');
            try {
                if (editSupplierId) {
                    // Update existing supplier
                    await suppliersCollection.doc(editSupplierId).update({
                        name,
                        contact,
                        address
                    });
                    showAlertDialog('Supplier berhasil diperbarui!');
                } else {
                    // Add new supplier
                    await suppliersCollection.add({
                        name,
                        contact,
                        address,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    showAlertDialog('Supplier berhasil ditambahkan!');
                }
                supplierFormModal.style.display = 'none';
                loadSuppliers(); // Reload suppliers to update the list
            } catch (error) {
                console.error("Error saving supplier:", error);
                showAlertDialog("Gagal menyimpan supplier.");
            } finally {
                hideLoading();
            }
        });


        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            loadProducts();
            loadSuppliers();
            renderOrderItemsTable(); // Initial render of empty table
            updateOrderPanelButtons(); // Set initial button states
        });
    </script>
</body>
</html>
