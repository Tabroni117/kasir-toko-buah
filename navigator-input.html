<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard Pesanan ‚Äì Toko Buah Indonesia</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

  <!-- Icon -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

  <!-- Style -->
  <style>
    :root {
      --primary: #16a34a;
      --primary-dark: #15803d;
      --secondary: #64748b;
      --light: #f0fdf4;
      --white: #ffffff;
      --dark: #1e293b;
      font-size: 12px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Inter', sans-serif;
    }

    body {
      background: #f8fafc;
      color: var(--dark);
      min-height: 100vh;
      padding-bottom: 80px; /* untuk space navigasi bawah */
    }

    .main-container {
      max-width: 1100px;
      margin: auto;
      padding: 20px;
    }

    .back-btn, .refresh-btn {
      padding: 6px 10px;
      font-size: 10px;
      border-radius: 5px;
      display: inline-flex;
      align-items: center;
      gap: 5px;
      cursor: pointer;
      text-decoration: none;
    }

    .back-btn {
      background: var(--primary);
      color: white;
      border: none;
    }

    .refresh-btn {
      background: white;
      color: var(--primary);
      border: 1px solid var(--primary);
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 20px 0;
    }

    .logo h1 {
      font-size: 16px;
      color: var(--primary-dark);
    }

    .logo p {
      font-size: 10px;
      color: var(--secondary);
    }

    .notification-bell {
      position: relative;
      font-size: 14px;
      color: var(--secondary);
      cursor: pointer;
    }

    .notification-bell.animate-bounce {
      animation: bounce 1s infinite;
      color: red;
    }

    .notification-badge {
      position: absolute;
      top: -2px;
      right: -2px;
      background: var(--primary);
      color: white;
      font-size: 8px;
      border-radius: 50%;
      padding: 2px 4px;
    }

    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-5px); }
    }

    .order-item {
      background: white;
      padding: 15px;
      margin-bottom: 10px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }

    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      border-top: 1px solid #e2e8f0;
      display: flex;
      justify-content: space-around;
      padding: 10px 0;
      z-index: 999;
      box-shadow: 0 -1px 5px rgba(0,0,0,0.05);
    }

    .bottom-nav button {
      background: none;
      border: none;
      font-size: 18px;
      color: #64748b;
      display: flex;
      flex-direction: column;
      align-items: center;
      font-weight: 500;
      cursor: pointer;
    }

    .bottom-nav button span {
      font-size: 10px;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 10px;
      margin-bottom: 20px;
    }

    .stat {
      background: white;
      border-left: 4px solid var(--primary);
      border-radius: 8px;
      padding: 10px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }

    .stat-title {
      font-size: 10px;
      color: var(--secondary);
    }

    .stat-value {
      font-size: 16px;
      font-weight: bold;
      color: var(--dark);
    }

  </style>
</head>
<body>

  <div class="main-container">
    <div>
      <a href="dashboard.html" class="back-btn"><i class="fas fa-arrow-left"></i> Kembali</a>
      <button class="refresh-btn" id="refreshBtn"><i class="fas fa-sync-alt"></i> Refresh</button>
    </div>

    <header>
      <div class="logo">
        <h1>RUJAK BUAH INDONESIA</h1>
        <p>Dashboard Pesanan</p>
      </div>
      <div class="notification-bell" id="notifBell">
        <i class="fas fa-bell"></i>
        <span class="notification-badge" id="notifCount">0</span>
      </div>
    </header>

    <div class="stats">
      <div class="stat">
        <div class="stat-title">Total Pesanan</div>
        <div class="stat-value" id="totalOrders">0</div>
      </div>
      <div class="stat">
        <div class="stat-title">Pendapatan Hari Ini</div>
        <div class="stat-value" id="todayIncome">Rp0</div>
      </div>
      <div class="stat">
        <div class="stat-title">Rata-rata Pesanan</div>
        <div class="stat-value" id="avgOrder">Rp0</div>
      </div>
      <div class="stat">
        <div class="stat-title">Pesanan Terakhir</div>
        <div class="stat-value" id="lastOrder">-</div>
      </div>
    </div>

    <div id="daftarPesanan">
      <p>Memuat pesanan...</p>
    </div>
  </div>

  <!-- Navigasi bawah -->
  <div class="bottom-nav">
    <button onclick="window.location.reload()"><i>üîÉ</i><span>Refresh</span></button>
    <button onclick="window.scrollTo({top: 0, behavior: 'smooth'})"><i>üçì</i><span>Atas</span></button>
    <button onclick="alert('QRIS modal')"><i>üí≥</i><span>QRIS</span></button>
    <button onclick="location.href='dashboard.html'"><i>üìä</i><span>Pembeli</span></button>
    <button onclick="location.href='home.html'"><i>üìä</i><span>Penjual</span></button>
  </div>

  <!-- Firebase Script -->
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCeqHW_m9kru2vmEDVSoelZ3UWFD4k4Xqc",
      authDomain: "tokobuahkasir.firebaseapp.com",
      projectId: "tokobuahkasir"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const daftar = document.getElementById("daftarPesanan");
    const totalOrdersEl = document.getElementById("totalOrders");
    const todayIncomeEl = document.getElementById("todayIncome");
    const avgOrderEl = document.getElementById("avgOrder");
    const lastOrderEl = document.getElementById("lastOrder");
    const notifBell = document.getElementById("notifBell");
    const notifCount = document.getElementById("notifCount");

    function formatCurrency(value) {
      return new Intl.NumberFormat('id-ID', {
        style: 'currency', currency: 'IDR', minimumFractionDigits: 0
      }).format(value);
    }

    function formatDate(date) {
      if (!date) return '-';
      return new Date(date).toLocaleString("id-ID", {
        day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit'
      });
    }

    function loadData() {
      db.collection("pesanan").orderBy("waktu", "desc").onSnapshot(snapshot => {
        let html = "";
        let total = 0, count = 0, todayTotal = 0;
        const today = new Date(); today.setHours(0,0,0,0);

        snapshot.forEach(doc => {
          const data = doc.data();
          const waktu = data.waktu?.toDate?.() || new Date();
          const totalHarga = data.total || 0;
          const nama = data.nama || "Pelanggan";

          if (waktu >= today) todayTotal += totalHarga;
          total += totalHarga;
          count++;

          html += `
            <div class="order-item">
              <b>${nama}</b> - ${formatCurrency(totalHarga)}<br>
              <small>${formatDate(waktu)}</small>
            </div>`;
        });

        daftar.innerHTML = html || "<p>Belum ada pesanan masuk.</p>";
        totalOrdersEl.textContent = count;
        todayIncomeEl.textContent = formatCurrency(todayTotal);
        avgOrderEl.textContent = count > 0 ? formatCurrency(total / count) : "Rp0";
        lastOrderEl.textContent = snapshot.docs[0]?.data()?.waktu?.toDate?.().toLocaleTimeString("id-ID") || "-";
        notifCount.textContent = count;
      });
    }

    function cekPesananBaru() {
      db.collection("pesanan").orderBy("waktu", "desc").limit(1).get().then(snapshot => {
        const data = snapshot.docs[0]?.data();
        const waktu = data?.waktu?.toDate?.();
        const terakhir = new Date(localStorage.getItem("pesananSudahDibuka") || 0);
        if (waktu > terakhir) {
          notifBell.classList.add("animate-bounce");
        } else {
          notifBell.classList.remove("animate-bounce");
        }
      });
    }

    document.addEventListener("DOMContentLoaded", () => {
      localStorage.setItem("pesananSudahDibuka", new Date().toISOString());
      loadData();
      cekPesananBaru();
      setInterval(cekPesananBaru, 30000);
    });

    document.getElementById("refreshBtn").onclick = loadData;
  </script>
</body>
</html>
