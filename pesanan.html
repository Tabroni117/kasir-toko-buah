<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard Pesanan Penjual</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f8fafc;
            color: #1e293b;
            padding: 20px;
        }
        .container {
            max-width: 600px;
            margin: 20px auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .order-item {
            border: 1px solid #e2e8f0;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 6px;
            background-color: #fefefe;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .order-id {
            font-weight: bold;
            color: #16a34a;
            font-size: 1.1em;
        }
        .customer-info {
            font-size: 0.9em;
            color: #64748b;
        }
        .status {
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: 600;
        }
        .status.Pending { background-color: #fffbeb; color: #d97706; }
        .status.Diproses { background-color: #eff6ff; color: #2563eb; }
        .status.Selesai { background-color: #d1fae5; color: #059669; }
        .status.Dibatalkan { background-color: #fee2e2; color: #dc2626; }
        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100px;
        }
        .spinner {
            border: 4px solid rgba(16, 185, 129, 0.2);
            border-top: 4px solid #16a34a;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-2xl font-bold text-center mb-6 text-green-600">Daftar Pesanan Penjual</h1>
        <div id="orderList" class="order-list">
            <div class="loading-spinner">
                <div class="spinner"></div>
            </div>
            <p class="text-center text-gray-500 mt-4">Memuat pesanan...</p>
        </div>
        <button id="logoutBtn" class="mt-8 w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded">
            Logout
        </button>
    </div>

    <script>
        // Konfigurasi Firebase Anda
        const firebaseConfig = {
            apiKey: "AIzaSyCeqHW_m9kru2vmEDVSoelZ3UWFD4k4Xqc",
            authDomain: "tokobuahkasir.firebaseapp.com",
            projectId: "tokobuahkasir",
            storageBucket: "tokobuahkasir.firebasestorage.app",
            messagingSenderId: "731011133713",
            appId: "1:731011133713:web:4247ae627401a01b8c1cb0",
            measurementId: "G-7CPE2DB2BV"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        const orderListDiv = document.getElementById('orderList');
        const logoutBtn = document.getElementById('logoutBtn');

        // Fungsi untuk mendapatkan kelas status CSS
        function getStatusClass(status) {
            switch (status) {
                case 'Pending': return 'Pending';
                case 'Diproses': return 'Diproses';
                case 'Selesai': return 'Selesai';
                case 'Dibatalkan': return 'Dibatalkan';
                default: return '';
            }
        }

        // Fungsi untuk memformat mata uang
        function formatCurrency(amount) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(amount);
        }

        // Fungsi untuk memuat data pesanan
        function loadData() {
            orderListDiv.innerHTML = `
                <div class="loading-spinner">
                    <div class="spinner"></div>
                </div>
                <p class="text-center text-gray-500 mt-4">Memuat pesanan...</p>
            `;

            db.collection("pesanan").orderBy("waktu", "desc").get()
                .then((querySnapshot) => {
                    orderListDiv.innerHTML = ''; // Bersihkan konten loading
                    if (querySnapshot.empty) {
                        orderListDiv.innerHTML = '<p class="text-center text-gray-500">Tidak ada pesanan.</p>';
                        return;
                    }

                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        const orderFirebaseId = doc.id;
                        // Ambil displayOrderId dari Firestore, atau buat dari doc.id
                        const displayId = data.displayOrderId || '#' + orderFirebaseId.substring(0, 6).toUpperCase();

                        const orderItem = `
                            <div class="order-item">
                                <div>
                                    <div class="order-id">Nomor Pesanan: ${displayId}</div>
                                    <div class="customer-info">
                                        ${data.customer?.fullName || 'Pelanggan'} - ${data.customer?.phoneNumber || '-'}
                                    </div>
                                    <div class="customer-info">
                                        Total: ${formatCurrency(data.totalAmount || 0)}
                                    </div>
                                </div>
                                <div class="status ${getStatusClass(data.status)}">
                                    ${data.status || 'Tidak Diketahui'}
                                </div>
                            </div>
                        `;
                        orderListDiv.innerHTML += orderItem;
                    });
                })
                .catch((error) => {
                    console.error("Error getting documents: ", error);
                    orderListDiv.innerHTML = '<p class="text-center text-red-500">Gagal memuat data pesanan.</p>';
                });
        }

        // Proteksi Halaman
        auth.onAuthStateChanged(user => {
            if (user) {
                // User is signed in, check their role
                db.collection("users").doc(user.uid).get().then((doc) => {
                    if (doc.exists && doc.data().role === 'penjual') {
                        // User is a seller, load data
                        loadData();
                    } else {
                        // User is not a seller or role not found, redirect to login
                        alert("Anda tidak memiliki akses sebagai penjual. Silakan login dengan akun penjual.");
                        window.location.href = 'login.html'; // Redirect ke halaman login
                    }
                }).catch(error => {
                    console.error("Error getting user role:", error);
                    alert("Terjadi kesalahan saat memeriksa peran pengguna. Silakan coba lagi.");
                    window.location.href = 'login.html'; // Redirect jika ada error
                });
            } else {
                // No user is signed in, redirect to login
                window.location.href = 'login.html';
            }
        });

        // Logout functionality
        logoutBtn.addEventListener('click', () => {
            auth.signOut().then(() => {
                alert("Anda telah logout.");
                window.location.href = 'login.html'; // Redirect to login page after logout
            }).catch((error) => {
                console.error("Error signing out: ", error);
                alert("Gagal logout. Silakan coba lagi.");
            });
        });

    </script>
</body>
</html>
