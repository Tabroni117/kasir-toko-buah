<!DOCTYPE html><html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pesanan Real-Time</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    body { font-family: sans-serif; margin: 0; padding: 10px; background: #f5f5f5; }
    h2 { text-align: center; }
    .order-item {
      background: #fff;
      padding: 15px;
      margin-bottom: 10px;
      border-radius: 8px;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .order-item:hover { background: #f0f0f0; }#popupDetail {
  display: none;
  position: fixed; top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.5);
  z-index: 9999;
  justify-content: center;
  align-items: center;
  padding: 20px;
}
#popupDetail > div {
  background: white;
  padding: 20px;
  border-radius: 12px;
  max-width: 400px;
  width: 90%;
  animation: fadeIn 0.3s ease;
  position: relative;
}
.close-button {
  position: absolute;
  top: 10px; right: 15px;
  background: transparent;
  border: none;
  font-size: 22px;
  cursor: pointer;
}
@keyframes fadeIn {
  from { opacity: 0; transform: scale(0.9); }
  to { opacity: 1; transform: scale(1); }
}
.status-dropdown {
  margin-top: 5px;
  padding: 6px;
  font-size: 14px;
}
#popupItems {
  background: #f9f9f9;
  padding: 10px;
  margin-top: 10px;
  border-radius: 6px;
  font-size: 13px;
  max-height: 150px;
  overflow-y: auto;
}

  </style>
</head>
<body><h2>Daftar Pesanan (Realtime)</h2>
<div id="daftarPesanan">Memuat...</div>
<audio id="notifSound" src="https://www.myinstants.com/media/sounds/bell-notification.mp3" preload="auto"></audio><div id="popupDetail">
  <div>
    <button class="close-button" onclick="tutupDetail()">&times;</button>
    <h3 id="popupNama">Nama Pelanggan</h3>
    <p><strong>HP:</strong> <span id="popupNomor"></span></p>
    <p><strong>Alamat:</strong> <span id="popupAlamat"></span></p>
    <p><strong>Total:</strong> <span id="popupTotal"></span></p>
    <p><strong>Bayar:</strong> <span id="popupMetodeBayar"></span></p>
    <p><strong>Status:</strong> <span id="popupStatus"></span></p>
    <select id="statusUpdater" class="status-dropdown">
      <option value="Pending">Pending</option>
      <option value="Diproses">Diproses</option>
      <option value="Selesai">Selesai</option>
      <option value="Dibatalkan">Dibatalkan</option>
    </select>
    <div id="popupItems"></div>
  </div>
</div><script>
  const firebaseConfig = {
    apiKey: "AIzaSyCeqHW_m9kru2vmEDVSoelZ3UWFD4k4Xqc",
    authDomain: "tokobuahkasir.firebaseapp.com",
    projectId: "tokobuahkasir",
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const daftar = document.getElementById("daftarPesanan");
  const popup = document.getElementById("popupDetail");
  let currentOrderId = null;
  let lastDocCount = 0;

  function formatCurrency(val) {
    return new Intl.NumberFormat("id-ID", { style: "currency", currency: "IDR" }).format(val);
  }

  function tampilkanDetail(orderId) {
    currentOrderId = orderId;
    db.collection("pesanan").doc(orderId).get().then(doc => {
      if (!doc.exists) return alert("Data tidak ditemukan.");
      const data = doc.data();
      const cust = data.customer || {};
      document.getElementById("popupNama").textContent = cust.fullName || "Pelanggan";
      document.getElementById("popupNomor").textContent = cust.phoneNumber || "-";
      document.getElementById("popupAlamat").textContent = cust.address || "-";
      document.getElementById("popupTotal").textContent = formatCurrency(data.totalAmount || 0);
      document.getElementById("popupMetodeBayar").textContent = data.paymentMethod || "-";
      document.getElementById("popupStatus").textContent = data.status || "Pending";
      document.getElementById("statusUpdater").value = data.status || "Pending";

      const itemHTML = (data.items || []).map(i => `â€¢ ${i.name} (${i.quantity} x Rp${(i.price).toLocaleString("id-ID")})`).join("<br>");
      document.getElementById("popupItems").innerHTML = itemHTML;

      popup.style.display = "flex";

      if ((data.status || "").toLowerCase() === "pending") {
        db.collection("pesanan").doc(orderId).update({
          status: "Dilihat",
          waktuDilihat: new Date()
        });
        document.getElementById("popupStatus").textContent = "Dilihat";
        document.getElementById("statusUpdater").value = "Dilihat";
      }
    });
  }

  function tutupDetail() {
    popup.style.display = "none";
    currentOrderId = null;
  }

  document.getElementById("statusUpdater").addEventListener("change", function() {
    if (!currentOrderId) return;
    const statusBaru = this.value;
    db.collection("pesanan").doc(currentOrderId).update({ status: statusBaru }).then(() => {
      alert("Status diperbarui!");
      tutupDetail();
    });
  });

  document.addEventListener("DOMContentLoaded", () => {
    popup.style.display = "none";
    db.collection("pesanan").orderBy("waktu", "desc").onSnapshot(snapshot => {
      daftar.innerHTML = "";

      if (snapshot.empty) {
        daftar.innerHTML = "<p>Tidak ada pesanan.</p>";
        return;
      }

      if (snapshot.docs.length > lastDocCount) {
        const baru = snapshot.docs[0].data();
        const nama = baru.customer?.fullName || "Pelanggan Baru";
        document.getElementById("notifSound").play();
        alert("ðŸ”” Pesanan baru dari " + nama);
      }
      lastDocCount = snapshot.docs.length;

      snapshot.forEach(doc => {
        const d = doc.data();
        const nama = d.customer?.fullName || "Pelanggan";
        const total = formatCurrency(d.totalAmount || 0);
        const status = d.status || "Pending";
        const waktu = d.waktu?.toDate?.().toLocaleString("id-ID") || "-";
        daftar.innerHTML += `
          <div class="order-item" onclick="tampilkanDetail('${doc.id}')">
            <strong>${nama}</strong><br>
            ${total} - <em>${status}</em><br>
            <small>${waktu}</small>
          </div>
        `;
      });
    });
  });
</script></body>
</html>
