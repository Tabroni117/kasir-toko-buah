<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard Pesanan - Rujak Buah Indonesia</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

    <style>
        /* ... (CSS Anda yang sudah ada, tidak ada perubahan di sini) ... */
        /* Tambahan untuk popup notifikasi */
        #notificationModal {
            display: none; /* Sembunyikan default */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7); /* Overlay gelap */
            z-index: 10000; /* Lebih tinggi dari popupDetail */
            justify-content: center;
            align-items: center;
            opacity: 0; /* Awalnya transparan untuk animasi */
            transition: opacity 0.3s ease-out;
        }

        #notificationModal.show-notification {
            display: flex;
            opacity: 1;
        }

        #notificationModalContent {
            background: linear-gradient(135deg, #16a34a, #22c55e); /* Background gradien hijau */
            color: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 450px;
            width: 90%;
            text-align: center;
            position: relative;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            transform: scale(0.9); /* Mulai dari skala kecil */
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
        }

        #notificationModal.show-notification #notificationModalContent {
            transform: scale(1); /* Membesar ke skala normal */
        }

        #notificationModalContent .close-btn-notif {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 28px;
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
            background: none;
            border: none;
            transition: color 0.2s;
        }

        #notificationModalContent .close-btn-notif:hover {
            color: white;
        }

        #notificationModalContent h3 {
            font-size: 24px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-weight: 700;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }

        #notificationModalContent h3 i {
            font-size: 30px;
            color: #ffeb3b; /* Kuning untuk icon bell */
            animation: bellShake 0.5s infinite alternate; /* Animasi goyang lonceng */
        }

        @keyframes bellShake {
            0% { transform: rotate(0deg); }
            25% { transform: rotate(10deg); }
            50% { transform: rotate(-10deg); }
            75% { transform: rotate(5deg); }
            100% { transform: rotate(0deg); }
        }

        #notificationModalContent p {
            font-size: 16px;
            margin-bottom: 25px;
            line-height: 1.5;
        }

        #notificationModalContent .btn-action-notif {
            background: white;
            color: var(--primary-dark);
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: background 0.3s ease, transform 0.1s ease;
        }

        #notificationModalContent .btn-action-notif:hover {
            background: #e0e0e0;
            transform: translateY(-2px);
        }
    </style>
</head>
<body>
    <div id="notificationModal">
        <div id="notificationModalContent">
            <button class="close-btn-notif">&times;</button>
            <h3><i class="fas fa-bell"></i> Pesanan Baru!</h3>
            <p id="notificationMessage">Ada pesanan baru dari **[Nama Pelanggan]** dengan total **[Jumlah]**!</p>
            <button class="btn-action-notif">Lihat Detail Pesanan</button>
        </div>
    </div>

    <div id="popupDetail">
        <div>
            <button onclick="tutupDetail()" class="close-button">&times;</button>
            <h3>Detail Pesanan <span id="popupOrderIdDisplay" style="font-size: 0.8em; color: #666;"></span></h3> 
            </div>
    </div>


    <script>
        // --- Konfigurasi Firebase (PASTIKAN MENGGUNAKAN KREDENSIAL ASLI ANDA) ---
        const firebaseConfig = {
            apiKey: "AIzaSyCeqHW_m9kru2vmEDVSoelZ3UWFD4k4Xqc",
            authDomain: "tokobuahkasir.firebaseapp.com",
            projectId: "tokobuahkasir",
            storageBucket: "tokobuahkasir.firebasestorage.app",
            messagingSenderId: "731011133713",
            appId: "1:731011133713:web:4247ae627401a01b8c1cb0",
            measurementId: "G-7CPE2DB2BV"
        };

        // Inisialisasi Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.firestore();
        const pesananCollection = db.collection('pesanan');
        const usersCollection = db.collection('users');

        // Elemen-elemen yang dibutuhkan
        const daftar = document.getElementById("daftarPesanan");
        const totalOrdersEl = document.getElementById("totalOrders");
        const todayIncomeEl = document.getElementById("todayIncome");
        const avgOrderEl = document.getElementById("avgOrder");
        const lastOrderEl = document.getElementById("lastOrder");
        const loadingSpinner = document.getElementById("loadingSpinner");
        const filterButtons = document.querySelectorAll('.filter-btn');

        let currentOrderIdForDetail = null;
        let activeFilterStatus = 'All';

        // Elemen untuk notifikasi
        const sound = document.getElementById("notifSound");
        const notificationModal = document.getElementById('notificationModal');
        const notificationModalContent = document.getElementById('notificationModalContent');
        const closeBtnNotif = document.querySelector('.close-btn-notif');
        const btnActionNotif = document.querySelector('.btn-action-notif');
        const notificationMessage = document.getElementById('notificationMessage');
        const notifLonceng = document.getElementById('notifLonceng'); // Icon lonceng di header
        const navPesanan = document.getElementById('navPesanan'); // Tombol Pesanan di nav bawah

        let terakhirDitampilkan = localStorage.getItem("terakhirNotifOrderId") || ""; 
        let sedangBerbunyi = false; 
        let audioSudahDiizinkan = false;
        let currentNewOrderId = null; 

        // Fungsi untuk mengizinkan audio setelah interaksi pengguna pertama
        document.addEventListener("click", () => {
            if (!audioSudahDiizinkan) {
                sound.play().catch(() => {});
                sound.pause();
                sound.currentTime = 0;
                audioSudahDiizinkan = true;
                console.log("Audio diizinkan setelah interaksi pengguna.");
            }
        }, { once: true });

        // Fungsi tampilkan popup notifikasi baru
        function showNotificationModal(orderData) {
            notificationMessage.innerHTML = `Ada pesanan baru dari <strong>${orderData.customer?.fullName || 'Pelanggan'}</strong> dengan total <strong>${formatRupiah(orderData.totalAmount || 0)}</strong>!`;
            
            notificationModal.style.display = 'flex'; 
            setTimeout(() => {
                notificationModal.classList.add('show-notification'); 
            }, 50); 

            currentNewOrderId = orderData.id; 
        }

        // Fungsi tutup popup notifikasi baru
        function hideNotificationModal() {
            notificationModal.classList.remove('show-notification'); 
            setTimeout(() => {
                notificationModal.style.display = 'none'; 
            }, 300); 

            sound.pause();
            sound.currentTime = 0;
            sedangBerbunyi = false; 

            localStorage.setItem("pesananSudahDibuka", new Date().toISOString());
            localStorage.setItem("terakhirNotifOrderId", terakhirDitampilkan); 
            localStorage.setItem("idPesananTerakhirDibunyikan", terakhirDitampilkan); 

            notifLonceng.classList.remove("berkedip-kuat");
            navPesanan.classList.remove("berkedip-kuat"); 
        }

        closeBtnNotif.addEventListener('click', hideNotificationModal);

        notificationModal.addEventListener('click', function(event) {
            if (event.target === notificationModal) { 
                hideNotificationModal();
            }
        });

        btnActionNotif.addEventListener('click', function() {
            hideNotificationModal(); 
            if (currentNewOrderId) {
                tampilkanDetail(currentNewOrderId); 
            }
        });

        function cekPesananBaru() {
            pesananCollection.orderBy("waktu", "desc").limit(1).get().then(snapshot => {
                if (!snapshot.empty) {
                    const doc = snapshot.docs[0];
                    const data = doc.data();
                    data.id = doc.id; 
                    
                    const waktuPesanan = data.waktu?.toDate?.() || new Date();
                    const waktuBukaTerakhir = new Date(localStorage.getItem("pesananSudahDibuka") || 0); 
                    const idPesananTerakhirDibunyikan = localStorage.getItem("idPesananTerakhirDibunyikan") || ""; 

                    if (doc.id !== terakhirDitampilkan && waktuPesanan > waktuBukaTerakhir) {
                        terakhirDitampilkan = doc.id; 
                        localStorage.setItem("terakhirNotifOrderId", terakhirDitampilkan); 

                        if (doc.id !== idPesananTerakhirDibunyikan && !sedangBerbunyi) {
                            sound.play().catch(error => {
                                console.warn("Gagal memutar suara notifikasi:", error);
                            });
                            sedangBerbunyi = true; 
                            localStorage.setItem("idPesananTerakhirDibunyikan", doc.id); 
                        }

                        showNotificationModal(data); 

                        notifLonceng.classList.add("berkedip-kuat");
                        navPesanan.classList.add("berkedip-kuat");

                    } else {
                        if (notificationModal.classList.contains("hidden") || notificationModal.style.display === 'none') {
                            sound.pause();
                            sound.currentTime = 0;
                            sedangBerbunyi = false;
                            notifLonceng.classList.remove("berkedip-kuat");
                            navPesanan.classList.remove("berkedip-kuat");
                        }
                    }
                } else {
                    sound.pause();
                    sound.currentTime = 0;
                    sedangBerbunyi = false;
                    notifLonceng.classList.remove("berkedip-kuat");
                    navPesanan.classList.remove("berkedip-kuat");
                }
            }).catch(error => {
                console.error("Error fetching latest order:", error);
                sound.pause();
                sound.currentTime = 0;
                sedangBerbunyi = false;
                notifLonceng.classList.remove("berkedip-kuat");
                navPesanan.classList.remove("berkedip-kuat");
            });
        }
    </script>
</body>
</html>
