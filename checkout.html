<!DOCTYPE html>
<html lang="id" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Checkout - Rujak Buah Indonesia</title>

  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: '#00C853',
            secondary: '#64DD17'
          }
        }
      }
    }
  </script>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body class="bg-white dark:bg-gray-900 text-gray-800 dark:text-gray-100 transition-colors duration-300">

  <!-- Container -->
  <div class="max-w-md mx-auto min-h-screen p-4 relative bg-white dark:bg-gray-900">

    <!-- Header -->
    <header class="flex items-center gap-3 sticky top-0 z-50 p-4 bg-gradient-to-r from-green-500 to-green-300 dark:from-green-600 dark:to-green-400 shadow-md rounded-b-md">
      <i class="fas fa-arrow-left text-white text-xl cursor-pointer" onclick="history.back()"></i>
      <h1 class="text-white text-lg font-bold">Checkout Pesanan</h1>
    </header>

    <!-- Informasi Pengiriman -->
    <section class="bg-gray-50 dark:bg-gray-800 mt-5 p-4 rounded-lg shadow-md">
      <h2 class="text-green-600 dark:text-green-300 font-semibold text-sm mb-3 uppercase">Informasi Pengiriman</h2>

      <div class="space-y-3">
        <div>
          <label class="text-sm font-medium">Nama Lengkap</label>
          <input type="text" id="fullName" class="mt-1 w-full px-3 py-2 rounded-md border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900" placeholder="Nama lengkap">
        </div>
        <div>
          <label class="text-sm font-medium">Nomor Telepon</label>
          <input type="tel" id="phoneNumber" class="mt-1 w-full px-3 py-2 rounded-md border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900" placeholder="08xxxxxxxxxx">
        </div>
        <div>
          <label class="text-sm font-medium">Alamat Pengiriman</label>
          <div class="relative">
            <textarea id="deliveryAddress" rows="2" class="w-full px-3 py-2 pr-10 rounded-md border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900" placeholder="Contoh: Jl. Merdeka No.123, Jakarta"></textarea>
            <i id="gpsIconCheckout" class="fas fa-map-marker-alt absolute right-3 top-3 text-green-500 cursor-pointer hover:scale-110 transition"></i>
          </div>
        </div>
        <div>
          <label class="text-sm font-medium">Catatan (Opsional)</label>
          <textarea id="notes" rows="2" class="w-full px-3 py-2 rounded-md border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900" placeholder="Contoh: Tanpa kacang, pedas sedang"></textarea>
        </div>
      </div>
    </section>

    <!-- Metode Pembayaran -->
    <section class="bg-gray-50 dark:bg-gray-800 mt-5 p-4 rounded-lg shadow-md">
      <h2 class="text-green-600 dark:text-green-300 font-semibold text-sm mb-3 uppercase">Metode Pembayaran</h2>

      <div class="space-y-2">
        <label class="flex items-center gap-3 p-2 rounded-md border border-gray-300 dark:border-gray-700 cursor-pointer">
          <input type="radio" name="paymentMethod" value="COD" checked>
          <span>Bayar di Tempat (COD)</span>
          <i class="fas fa-money-bill-wave ml-auto text-green-500"></i>
        </label>
        <label class="flex items-center gap-3 p-2 rounded-md border border-gray-300 dark:border-gray-700 cursor-pointer">
          <input type="radio" name="paymentMethod" value="Transfer Bank">
          <span>Transfer Bank</span>
          <i class="fas fa-university ml-auto text-green-500"></i>
        </label>
        <label class="flex items-center gap-3 p-2 rounded-md border border-gray-300 dark:border-gray-700 cursor-pointer">
          <input type="radio" name="paymentMethod" value="E-Wallet">
          <span>E-Wallet (OVO, GoPay, DANA)</span>
          <i class="fas fa-wallet ml-auto text-green-500"></i>
        </label>
      </div>

      <div id="eWalletTypeWrapper" class="mt-3 hidden">
        <label class="text-sm">Jenis E-Wallet</label>
        <select id="eWalletType" class="w-full mt-1 px-3 py-2 rounded-md border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900">
          <option value="QRIS" selected>QRIS (Semua E-Wallet)</option>
          <option value="OVO">OVO</option>
          <option value="DANA">DANA</option>
          <option value="GoPay">GoPay</option>
        </select>
      </div>
    </section>

    <!-- Ringkasan Pesanan -->
    <section class="bg-gray-50 dark:bg-gray-800 mt-5 p-4 rounded-lg shadow-md">
      <h2 class="text-green-600 dark:text-green-300 font-semibold text-sm mb-3 uppercase">Ringkasan</h2>
      <div class="flex justify-between mb-2 text-sm">
        <span>Total Belanja (<span id="itemCount">0</span> item)</span>
        <span id="subtotalCheckout">Rp 0</span>
      </div>
      <div class="flex justify-between mb-2 text-sm">
        <span>Biaya Pengiriman</span>
        <span id="deliveryFeeCheckout">Rp 0</span>
      </div>
      <div class="flex justify-between font-bold text-lg border-t pt-3 border-gray-300 dark:border-gray-600">
        <span>Total Pembayaran</span>
        <span id="totalAmountCheckout">Rp 0</span>
      </div>
    </section>

    <!-- QRIS Box -->
    <div id="qrisBox" class="text-center my-5"></div>

    <!-- Tombol Buat Pesanan -->
    <button id="placeOrderButton" class="fixed bottom-5 left-1/2 -translate-x-1/2 w-[90%] max-w-md px-4 py-3 bg-gradient-to-r from-green-500 to-green-300 text-white font-semibold text-lg rounded-xl shadow-lg hover:from-green-600 hover:to-green-400 transition duration-300">
      Buat Pesanan
    </button>
  </div>



<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<script>
  // Konfigurasi Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyCeqHW_m9kru2vmEDVSoelZ3UWFD4k4Xqc",
    authDomain: "tokobuahkasir.firebaseapp.com",
    projectId: "tokobuahkasir",
    storageBucket: "tokobuahkasir.appspot.com",
    messagingSenderId: "731011133713",
    appId: "1:731011133713:web:4247ae627401a01b8c1cb0",
    measurementId: "G-7CPE2DB2BV"
  };
  if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);

  const auth = firebase.auth();
  const db = firebase.firestore();
  const usersCollection = db.collection('users');
  const pesananCollection = db.collection('pesanan');

  const fullNameInput = document.getElementById('fullName');
  const phoneNumberInput = document.getElementById('phoneNumber');
  const deliveryAddressInput = document.getElementById('deliveryAddress');
  const notesInput = document.getElementById('notes');
  const placeOrderButton = document.getElementById('placeOrderButton');
  const gpsIcon = document.getElementById('gpsIconCheckout');

  const itemCount = document.getElementById('itemCount');
  const subtotalEl = document.getElementById('subtotalCheckout');
  const deliveryFeeEl = document.getElementById('deliveryFeeCheckout');
  const totalAmountEl = document.getElementById('totalAmountCheckout');
  const qrisBox = document.getElementById('qrisBox');

  const cart = JSON.parse(localStorage.getItem('cart')) || [];
  const DELIVERY_FEE = 10000;
  let currentUserId = null;

  function formatRupiah(number) {
    return new Intl.NumberFormat('id-ID', {
      style: 'currency',
      currency: 'IDR',
      minimumFractionDigits: 0
    }).format(number);
  }

  function renderRingkasan() {
    const subtotal = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
    const total = subtotal + (subtotal > 0 ? DELIVERY_FEE : 0);
    itemCount.textContent = cart.length;
    subtotalEl.textContent = formatRupiah(subtotal);
    deliveryFeeEl.textContent = formatRupiah(subtotal > 0 ? DELIVERY_FEE : 0);
    totalAmountEl.textContent = formatRupiah(total);

    if (cart.length === 0) {
      alert("Keranjang kosong!");
      window.location.href = "cart.html";
    }
  }

  gpsIcon.addEventListener('click', () => {
    deliveryAddressInput.placeholder = "Mendeteksi lokasi...";
    navigator.geolocation?.getCurrentPosition(async pos => {
      const { latitude, longitude } = pos.coords;
      try {
        const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}`);
        const data = await res.json();
        const alamat = [
          data.address.road,
          data.address.village || data.address.town,
          data.address.city,
          data.address.state
        ].filter(Boolean).join(', ');
        deliveryAddressInput.value = alamat;
      } catch {
        deliveryAddressInput.placeholder = "Gagal mengambil alamat.";
      }
    }, () => {
      alert("Gagal akses lokasi.");
    });
  });

  auth.onAuthStateChanged(async user => {
    if (!user || localStorage.getItem("userRole") !== "pembeli") {
      alert("Akses ditolak.");
      window.location.href = "index.html";
    } else {
      currentUserId = user.uid;
      try {
        const userData = (await usersCollection.doc(user.uid).get()).data();
        fullNameInput.value = userData.fullName || "";
        phoneNumberInput.value = userData.phoneNumber || "";
        deliveryAddressInput.value = userData.address || "";
      } catch {}
      renderRingkasan();
    }
  });

  document.querySelectorAll('input[name="paymentMethod"]').forEach(radio => {
    radio.addEventListener('change', () => {
      document.getElementById("eWalletTypeWrapper").classList.toggle('hidden', radio.value !== "E-Wallet");
    });
  });

  placeOrderButton.addEventListener('click', async () => {
    const fullName = fullNameInput.value.trim();
    const phone = phoneNumberInput.value.trim();
    const address = deliveryAddressInput.value.trim();
    const notes = notesInput.value.trim();
    const method = document.querySelector('input[name="paymentMethod"]:checked')?.value;
    const eWalletType = method === "E-Wallet" ? document.getElementById("eWalletType").value : null;

    if (!fullName || !phone || !address || !method || (method === "E-Wallet" && !eWalletType)) {
      alert("Lengkapi semua data.");
      return;
    }

    const subtotal = cart.reduce((s, i) => s + i.price * i.quantity, 0);
    const total = subtotal + (subtotal > 0 ? DELIVERY_FEE : 0);

    const orderData = {
      userId: currentUserId,
      customer: { fullName, phoneNumber: phone, address, notes },
      items: cart,
      subtotal,
      deliveryFee: DELIVERY_FEE,
      totalAmount: total,
      paymentMethod: method,
      ...(eWalletType && { eWalletType }),
      status: "Pending",
      waktu: firebase.firestore.FieldValue.serverTimestamp()
    };

    placeOrderButton.disabled = true;
    placeOrderButton.innerHTML = "⏳ Memproses...";

    try {
      const docRef = await pesananCollection.add(orderData);
      const orderId = docRef.id;
      const shortId = "#" + orderId.substring(0, 6).toUpperCase();
      await pesananCollection.doc(orderId).update({ displayOrderId: shortId });
      await db.collection('riwayat_customer').doc(currentUserId).collection('pesanan').doc(orderId).set({ ...orderData, displayOrderId: shortId });
      sessionStorage.setItem("lastOrderId", shortId);
      localStorage.removeItem("cart");

      if (method === "E-Wallet" && eWalletType === "QRIS") {
        await buatQRIS(total, fullName);
        alert("✅ QRIS berhasil dibuat\n" + shortId);
      } else {
        alert("✅ Pesanan berhasil dibuat\n" + shortId);
        window.location.href = "payment-confirmation.html";
      }

    } catch (e) {
      alert("❌ Gagal menyimpan pesanan");
    }

    placeOrderButton.disabled = false;
    placeOrderButton.innerHTML = "Buat Pesanan";
  });

  async function buatQRIS(amount, name) {
    qrisBox.innerHTML = "⏳ Memuat QR...";
    try {
      const res = await fetch("https://tokobuahkasir.cloudfunctions.net/buatQRIS", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          method: "QRIS",
          merchant_ref: "INV-" + Date.now(),
          amount,
          customer_name: name
        })
      });
      const data = await res.json();
      if (data.success) {
        qrisBox.innerHTML = `
          <p class="text-green-600 dark:text-green-300 font-semibold">✅ QRIS:</p>
          <img src="${data.data.qr_url}" class="mx-auto my-3 w-44 rounded-md border border-gray-300">
          <p class="text-sm text-gray-700 dark:text-gray-200">Kode: <strong>${data.data.reference}</strong></p>
        `;
      } else {
        qrisBox.innerHTML = `<p class="text-red-500">❌ Gagal QRIS: ${data.message}</p>`;
      }
    } catch (e) {
      qrisBox.innerHTML = `<p class="text-red-500">⚠️ Gagal membuat QRIS.</p>`;
    }
  }
</script>




  
</body>
</html>
