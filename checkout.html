<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - Rujak Buah Indonesia</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <style>
        /* General Styling */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }

        body {
            background-color: #f9f9f9;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 480px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            position: relative;
            padding-bottom: 100px; /* Space for payment button */
            box-shadow: 0 0 10px rgba(0,0,0,0.05);
        }

        /* Header Styling */
        .header-detail {
            background: linear-gradient(135deg, #00C853, #64DD17);
            color: white;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between; /* Added for User ID display */
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .back-button {
            color: white;
            font-size: 24px;
            margin-right: 15px;
            cursor: pointer;
        }

        .header-title {
            font-size: 18px;
            font-weight: bold;
            flex-grow: 1; /* Make title take available space */
            text-align: center; /* Center the title */
        }

        /* Checkout Section */
        .checkout-section {
            padding: 16px;
            margin-top: 10px;
            background-color: #fff;
            margin-bottom: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .section-title-checkout {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #00C853;
        }

        /* Form Groups */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 13px;
            color: #555;
            font-weight: 500;
        }

        /* GPS Input Group */
        .input-with-icon {
            position: relative;
            display: flex;
            align-items: center;
        }
        .input-with-icon textarea {
            width: 100%;
            padding-right: 40px; /* Space for icon */
        }
        .input-with-icon .gps-icon-small {
            position: absolute;
            right: 10px;
            color: #00C853;
            font-size: 20px;
            cursor: pointer;
            transition: transform 0.3s;
        }
        .input-with-icon .gps-icon-small.loading {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            100% { transform: rotate(360deg); }
        }

        .form-group input[type="text"],
        .form-group input[type="tel"],
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            color: #333;
            transition: border-color 0.2s;
        }

        .form-group input[type="text"]:focus,
        .form-group input[type="tel"]:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #00C853;
        }

        /* Payment Methods */
        .payment-method {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .payment-method:hover {
            background-color: #f5f5f5;
        }

        .payment-method input[type="radio"] {
            margin-right: 10px;
            accent-color: #00C853;
        }

        .payment-method label {
            font-size: 15px;
            font-weight: 500;
            flex-grow: 1;
        }

        .payment-method i {
            font-size: 20px;
            color: #00C853;
        }

        /* Order Summary */
        .order-summary-checkout {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px dashed #eee;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 15px;
        }

        .summary-total {
            font-weight: bold;
            font-size: 18px;
            color: #00C853;
            border-top: 1px solid #eee;
            padding-top: 10px;
            margin-top: 10px;
        }

        /* Place Order Button */
        .place-order-button {
            background: linear-gradient(135deg, #00C853, #64DD17);
            color: white;
            padding: 15px 20px;
            text-align: center;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            width: calc(100% - 32px); /* Full width minus padding */
            position: fixed;
            bottom: 10px;
            max-width: 448px; /* Max width 480px - 16px padding on each side */
            left: 50%;
            transform: translateX(-50%);
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            transition: background 0.3s ease;
        }

        .place-order-button:hover {
            background: linear-gradient(135deg, #00B04C, #5BB914);
        }
        .place-order-button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }

        /* User ID Display for Debugging */
        #userIdDisplay {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(0,0,0,0.6);
            color: white;
            font-size: 10px;
            padding: 3px 6px;
            border-radius: 5px;
            z-index: 101;
        }

        /* QRIS Box Styling */
        #qrisBox {
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            background-color: #f0fff4;
            border: 2px dashed #00C853;
            border-radius: 10px;
        }
        #qrisBox img {
            max-width: 100%;
            height: auto;
            border-radius: 5px;
            margin-top: 10px;
        }

        /* Loading Message */
        #loadingMessage {
            text-align: center;
            padding: 50px 20px;
            color: #777;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header-detail">
            <i class="fas fa-arrow-left back-button" id="backToCart"></i>
            <div class="header-title">Checkout Pesanan</div>
            <div id="userIdDisplay">Loading User ID...</div> <!-- User ID Display -->
        </header>

        <div class="checkout-section">
            <h2 class="section-title-checkout">Informasi Pengiriman</h2>
            <div class="form-group">
                <label for="fullName">Nama Lengkap</label>
                <input type="text" id="fullName" placeholder="Masukkan nama lengkap Anda" required>
            </div>
            <div class="form-group">
                <label for="phoneNumber">Nomor Telepon</label>
                <input type="tel" id="phoneNumber" placeholder="Masukkan nomor telepon" required>
            </div>
            <div class="form-group">
                <label for="deliveryAddress">Alamat Pengiriman</label>
                <div class="input-with-icon">
                    <textarea id="deliveryAddress" rows="3" placeholder="Contoh: Jl. Merdeka No. 123" required></textarea>
                    <i class="fas fa-map-marker-alt gps-icon-small" id="gpsIconCheckout"></i>
                </div>
            </div>
            <div class="form-group">
                <label for="notes">Catatan (Opsional)</label>
                <textarea id="notes" rows="2" placeholder="Contoh: Tanpa kacang, pedas sedang"></textarea>
            </div>
        </div>

        <div class="checkout-section">
            <h2 class="section-title-checkout">Metode Pembayaran</h2>
            <div class="payment-method">
                <input type="radio" id="cashOnDelivery" name="paymentMethod" value="COD" checked>
                <label for="cashOnDelivery">Bayar di Tempat (COD)</label>
                <i class="fas fa-money-bill-wave"></i>
            </div>
            <div class="payment-method">
                <input type="radio" id="bankTransfer" name="paymentMethod" value="Transfer Bank">
                <label for="bankTransfer">Transfer Bank</label>
                <i class="fas fa-university"></i>
            </div>
            <div id="bankTransferInfo" style="display: none; margin-top: 10px; padding: 12px; background: #fffbe6; border: 2px solid #ffc107; border-radius: 8px; font-size: 14px;">
                <strong>Transfer ke:</strong><br>
                BCA - 1234567890 a.n. Rujak Buah Indonesia<br>
                BRI - 0987654321 a.n. Rujak Buah Indonesia<br><br>
                Setelah transfer, konfirmasi pembayaran Anda di halaman "Riwayat".
            </div>
            <div class="payment-method">
                <input type="radio" id="ewallet" name="paymentMethod" value="E-Wallet">
                <label for="ewallet">E-Wallet (OVO, GoPay, DANA)</label>
                <i class="fas fa-wallet"></i>
            </div>
            <div id="eWalletTypeWrapper" style="display: none; margin-top: 10px;">
                <label for="eWalletType" style="display: block; margin-bottom: 6px; font-weight: 600; color: #00C853;">
                    Pilih Jenis E-Wallet:
                </label>
                <div style="position: relative; max-width: 260px;">
                    <select id="eWalletType" style="
                        width: 100%;
                        padding: 10px 16px;
                        padding-left: 44px;
                        border-radius: 8px;
                        background-color: #f0fff4;
                        border: 2px solid #00C853;
                        font-size: 14px;
                        color: #222;
                        font-weight: 600;
                        appearance: none;
                        background-image: url('data:image/svg+xml;charset=UTF-8,<svg fill=\'%2300C853\' height=\'20\' viewBox=\'0 0 24 24\' width=\'20\' xmlns=\'http://www.w3.org/2000/svg\'><path d=\'M7 10l5 5 5-5z\'/></svg>');
                        background-repeat: no-repeat;
                        background-position: right 14px center;
                        background-size: 14px;
                        box-shadow: 0 0 0 2px rgba(0, 200, 83, 0.1);
                        transition: all 0.2s ease;
                    ">
                        <option value="QRIS" selected>QRIS (Scan Semua E-Wallet)</option>
                        <option value="OVO">OVO</option>
                        <option value="DANA">DANA</option>
                        <option value="GoPay">GoPay</option>
                    </select>
                    <div style="
                        position: absolute;
                        top: 50%;
                        left: 12px;
                        transform: translateY(-50%);
                        font-size: 18px;
                        color: #00C853;
                        pointer-events: none;
                    " id="eWalletIcon">
                        <i class="fas fa-qrcode"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="checkout-section">
            <h2 class="section-title-checkout">Ringkasan Pesanan</h2>
            <div id="loadingMessage">Memuat keranjang...</div> <!-- Loading message -->
            <div id="checkoutContent" style="display: none;">
                <div class="order-items-list" id="orderItemsList">
                    <!-- Order items will be dynamically loaded here -->
                </div>
                <div class="order-summary-checkout">
                    <div class="summary-row">
                        <span>Total Belanja (<span id="itemCount">0</span> item)</span>
                        <span id="subtotalCheckout">Rp 0</span>
                    </div>
                    <div class="summary-row">
                        <span>Biaya Pengiriman</span>
                        <span id="deliveryFeeCheckout">Rp 0</span>
                    </div>
                    <div class="summary-total">
                        <span>Total Pembayaran</span>
                        <span id="totalAmountCheckout">Rp 0</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="qrisBox" style="display: none;"></div> <!-- QRIS box, initially hidden -->
        <button class="place-order-button" id="placeOrderButton">Buat Pesanan</button>
    </div>

    <!-- Script Checkout -->
    <script>
        // Konfigurasi Firebase Anda
        const firebaseConfig = {
            apiKey: "AIzaSyCeqHW_m9kru2vmEDVSoelZ3UWFD4k4Xqc",
            authDomain: "tokobuahkasir.firebaseapp.com",
            projectId: "tokobuahkasir",
            storageBucket: "tokobuahkasir.firebasestorage.app",
            messagingSenderId: "731011133713",
            appId: "1:731011133713:web:4247ae627401a01b8c1cb0",
            measurementId: "G-7CPE2DB2BV"
        };
        
        // Inisialisasi Firebase (gunakan ini saja, jangan ada inisialisasi ganda)
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Referensi koleksi Firestore
        const usersCollection = db.collection('users');
        const ordersCollection = db.collection('orders'); // Ganti 'pesanan' menjadi 'orders' agar konsisten dengan aturan
        const customerHistoryCollection = db.collection('riwayat_customer'); // Koleksi riwayat pesanan customer

        // Elemen DOM
        const userIdDisplay = document.getElementById('userIdDisplay');
        const fullNameInput = document.getElementById('fullName');
        const phoneNumberInput = document.getElementById('phoneNumber');
        const deliveryAddressInput = document.getElementById('deliveryAddress');
        const notesInput = document.getElementById('notes');
        const placeOrderButton = document.getElementById('placeOrderButton');
        const backToCartButton = document.getElementById('backToCart');

        const loadingMessage = document.getElementById('loadingMessage'); // New: Loading message
        const checkoutContent = document.getElementById('checkoutContent'); // New: Container for actual content
        const orderItemsList = document.getElementById('orderItemsList'); // Daftar item pesanan
        const itemCountSpan = document.getElementById('itemCount');
        const subtotalCheckoutSpan = document.getElementById('subtotalCheckout');
        const deliveryFeeCheckoutSpan = document.getElementById('deliveryFeeCheckout');
        const totalAmountCheckoutSpan = document.getElementById('totalAmountCheckout');
        const gpsIconCheckout = document.getElementById('gpsIconCheckout');

        const bankTransferInfo = document.getElementById('bankTransferInfo');
        const eWalletTypeWrapper = document.getElementById('eWalletTypeWrapper');
        const eWalletType = document.getElementById("eWalletType");
        const eWalletIcon = document.getElementById("eWalletIcon");
        const qrisBox = document.getElementById("qrisBox");

        // Variabel global
        const DELIVERY_FEE = 10000;
        let currentUserId = null;
        let currentCartItems = []; // Akan diisi dari Firestore

        // Fungsi format Rupiah
        function formatRupiah(amount) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(amount);
        }

        // Fungsi untuk mengambil dan menampilkan detail keranjang di halaman checkout
        async function fetchAndRenderCheckoutSummary() {
            loadingMessage.style.display = 'block'; // Tampilkan loading
            checkoutContent.style.display = 'none'; // Sembunyikan konten utama
            placeOrderButton.disabled = true; // Nonaktifkan tombol

            if (!currentUserId) {
                loadingMessage.textContent = 'Anda belum login atau User ID tidak tersedia.';
                return;
            }

            const cartItemsRef = db.collection('carts').doc(currentUserId).collection('items');
            try {
                const snapshot = await cartItemsRef.get();
                currentCartItems = []; // Reset item keranjang
                let subtotal = 0;

                orderItemsList.innerHTML = ''; // Bersihkan daftar item

                if (snapshot.empty) {
                    loadingMessage.textContent = 'Keranjang Anda kosong. Silakan kembali ke keranjang.';
                    loadingMessage.style.display = 'block';
                    checkoutContent.style.display = 'none';
                    placeOrderButton.disabled = true;
                } else {
                    snapshot.forEach(doc => {
                        const item = doc.data();
                        currentCartItems.push(item);
                        subtotal += item.price * item.quantity;

                        const itemElement = document.createElement('div');
                        itemElement.classList.add('order-item');
                        itemElement.innerHTML = `
                            <img src="${item.image}" alt="${item.name}" class="order-item-image">
                            <div class="order-item-details">
                                <div class="order-item-name">${item.name}</div>
                                <div class="order-item-variants">
                                    ${item.custom.bumbu}, ${item.custom.kacang}
                                </div>
                            </div>
                            <div class="order-item-qty-price">
                                ${item.quantity} x ${formatRupiah(item.price)} = ${formatRupiah(item.quantity * item.price)}
                            </div>
                        `;
                        orderItemsList.appendChild(itemElement);
                    });
                    loadingMessage.style.display = 'none'; // Sembunyikan loading
                    checkoutContent.style.display = 'block'; // Tampilkan konten utama
                    placeOrderButton.disabled = false;
                }

                const totalItems = currentCartItems.reduce((sum, item) => sum + item.quantity, 0);
                const deliveryFee = subtotal > 0 ? DELIVERY_FEE : 0;
                const totalAmount = subtotal + deliveryFee;

                itemCountSpan.textContent = totalItems;
                subtotalCheckoutSpan.textContent = formatRupiah(subtotal);
                deliveryFeeCheckoutSpan.textContent = formatRupiah(deliveryFee);
                totalAmountCheckoutSpan.textContent = formatRupiah(totalAmount);

            } catch (error) {
                console.error("❌ Gagal memuat ringkasan pesanan dari Firestore:", error);
                loadingMessage.textContent = 'Terjadi kesalahan saat memuat detail pesanan. Silakan coba lagi.';
                loadingMessage.style.display = 'block';
                checkoutContent.style.display = 'none';
                placeOrderButton.disabled = true;
            }
        }

        // Event listener untuk GPS
        gpsIconCheckout.addEventListener('click', () => {
            deliveryAddressInput.placeholder = "Mendeteksi lokasi...";
            gpsIconCheckout.classList.add('loading'); // Tambahkan kelas loading untuk animasi
            navigator.geolocation?.getCurrentPosition(async position => {
                const { latitude, longitude } = position.coords;
                try {
                    const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}`);
                    const data = await response.json();
                    const address = [
                        data.address.road,
                        data.address.village || data.address.town,
                        data.address.city,
                        data.address.state
                    ].filter(Boolean).join(', ');
                    deliveryAddressInput.value = address;
                } catch (e) {
                    deliveryAddressInput.placeholder = "Gagal mengambil alamat.";
                } finally {
                    gpsIconCheckout.classList.remove('loading'); // Hapus kelas loading
                }
            }, err => {
                alert("Tidak dapat mengakses lokasi. Pastikan GPS aktif dan izin diberikan.");
                gpsIconCheckout.classList.remove('loading'); // Hapus kelas loading
            });
        });

        // Event listener untuk radio button metode pembayaran
        document.querySelectorAll('input[name="paymentMethod"]').forEach(radio => {
            radio.addEventListener('change', () => {
                const method = radio.value;
                eWalletTypeWrapper.style.display = method === "E-Wallet" ? 'block' : 'none';
                bankTransferInfo.style.display = method === "Transfer Bank" ? 'block' : 'none';

                if (method === "E-Wallet" && eWalletIcon && eWalletType) {
                    const selected = eWalletType.value;
                    eWalletIcon.innerHTML = walletIcons[selected] || '<i class="fas fa-wallet"></i>';
                }
                qrisBox.style.display = 'none'; // Sembunyikan QRIS box saat metode pembayaran berubah
            });
        });

        // Event listener untuk dropdown jenis E-Wallet
        eWalletType.addEventListener("change", () => {
            const selected = eWalletType.value;
            eWalletIcon.innerHTML = walletIcons[selected] || '<i class="fas fa-wallet"></i>';
            qrisBox.style.display = 'none'; // Sembunyikan QRIS box saat jenis E-Wallet berubah
        });

        // Icon untuk E-Wallet (didefinisikan di sini agar bisa diakses)
        const walletIcons = {
            QRIS: '<i class="fas fa-qrcode"></i>',
            OVO: '<i class="fas fa-gem"></i>',
            DANA: '<i class="fas fa-wallet"></i>',
            GoPay: '<i class="fas fa-mobile-alt"></i>'
        };

        // Fungsi untuk membuat pesanan
        placeOrderButton.addEventListener('click', async () => {
            const fullName = fullNameInput.value.trim();
            const phoneNumber = phoneNumberInput.value.trim();
            const deliveryAddress = deliveryAddressInput.value.trim();
            const notes = notesInput.value.trim();
            const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked')?.value;
            const selectedEWalletType = paymentMethod === "E-Wallet" ? eWalletType.value : null;

            if (!fullName || !phoneNumber || !deliveryAddress || !paymentMethod || (paymentMethod === "E-Wallet" && !selectedEWalletType)) {
                alert("Mohon lengkapi semua informasi pengiriman dan metode pembayaran.");
                return;
            }

            if (currentCartItems.length === 0) {
                alert("Keranjang Anda kosong. Tidak dapat membuat pesanan.");
                return;
            }

            // Ganti alert dengan modal kustom jika tidak ingin menggunakan alert()
            if (!confirm("Apakah Anda yakin ingin membuat pesanan ini?")) {
                return;
            }

            const subtotal = currentCartItems.reduce((s, i) => s + i.price * i.quantity, 0);
            const deliveryFee = subtotal > 0 ? DELIVERY_FEE : 0;
            const totalAmount = subtotal + deliveryFee;

            const orderData = {
                userId: currentUserId,
                customer: { fullName, phoneNumber, address: deliveryAddress, notes },
                items: currentCartItems,
                subtotal,
                deliveryFee,
                totalAmount,
                paymentMethod: paymentMethod,
                ...(selectedEWalletType && { eWalletType: selectedEWalletType }), // Hanya tambahkan jika E-Wallet dipilih
                status: "Pending",
                orderDate: firebase.firestore.FieldValue.serverTimestamp()
            };

            placeOrderButton.disabled = true;
            placeOrderButton.innerHTML = "⏳ Memproses Pesanan...";

            try {
                // 1. Simpan pesanan ke koleksi 'orders'
                const docRef = await ordersCollection.add(orderData);
                const orderId = docRef.id;
                const displayOrderId = "#" + orderId.substring(0, 6).toUpperCase();
                
                // Update dokumen pesanan dengan displayOrderId
                await ordersCollection.doc(orderId).update({ displayOrderId: displayOrderId });

                // 2. Simpan salinan pesanan ke riwayat_customer
                await customerHistoryCollection.doc(currentUserId).collection('pesanan').doc(orderId).set({ ...orderData, displayOrderId: displayOrderId });
                
                sessionStorage.setItem("lastOrderId", displayOrderId); // Simpan ID pesanan terakhir

                // 3. Proses QRIS jika E-Wallet dan QRIS dipilih
                if (paymentMethod === "E-Wallet" && selectedEWalletType === "QRIS") {
                    await buatQRIS(totalAmount, fullName, displayOrderId); // Kirim displayOrderId juga
                } else {
                    alert(`✅ Pesanan berhasil dibuat!\nNomor Pesanan: ${displayOrderId}\nSilakan konfirmasi pembayaran Anda di halaman Riwayat.`);
                    window.location.href = "order-history.html"; // Arahkan ke halaman riwayat
                }

                // 4. Kosongkan keranjang di Firestore setelah pesanan berhasil (penting!)
                const cartItemsRef = db.collection('carts').doc(currentUserId).collection('items');
                const snapshot = await cartItemsRef.get();
                const batch = db.batch();
                snapshot.forEach(doc => {
                    batch.delete(doc.ref);
                });
                await batch.commit();
                console.log("Keranjang berhasil dikosongkan setelah pesanan dibuat.");

            } catch (err) {
                console.error("❌ Gagal membuat pesanan:", err);
                alert("❌ Gagal membuat pesanan. Silakan coba lagi.");
            } finally {
                placeOrderButton.disabled = false;
                placeOrderButton.innerHTML = "Buat Pesanan";
            }
        });

        // Fungsi untuk membuat QRIS (memanggil Cloud Function)
        async function buatQRIS(amount, name, orderIdForQRIS) {
            qrisBox.style.display = 'block'; // Tampilkan QRIS box
            qrisBox.innerHTML = "⏳ Memuat QRIS...";
            try {
                const res = await fetch("https://tokobuahkasir.cloudfunctions.net/buatQRIS", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        method: "QRIS",
                        merchant_ref: orderIdForQRIS, // Gunakan displayOrderId sebagai merchant_ref
                        amount,
                        customer_name: name
                    })
                });
                const data = await res.json();
                if (data.success) {
                    qrisBox.innerHTML = `
                        <p>✅ Silakan scan QRIS di bawah ini:</p>
                        <img src="${data.data.qr_url}" width="220" alt="QRIS Code">
                        <p><strong>Ref: ${data.data.reference}</strong></p>
                        <p style="font-size:12px; margin-top: 10px;">Setelah pembayaran, Anda akan diarahkan ke halaman Riwayat Pesanan.</p>
                    `;
                    // Arahkan ke halaman riwayat setelah beberapa detik (simulasi pembayaran selesai)
                    setTimeout(() => {
                        window.location.href = "order-history.html";
                    }, 5000); // Contoh 5 detik
                } else {
                    qrisBox.innerHTML = `<p style="color:red;">❌ Gagal membuat QRIS: ${data.message}</p>`;
                }
            } catch (e) {
                qrisBox.innerHTML = `<p style="color:red;">⚠️ Gagal membuat QRIS. Error koneksi.</p>`;
            }
        }

        // Event listener saat DOM sudah siap
        document.addEventListener('DOMContentLoaded', () => {
            // Inisialisasi tampilan User ID dan panggil fetch data setelah user login
            auth.onAuthStateChanged(user => {
                if (user) {
                    currentUserId = user.uid;
                    userIdDisplay.textContent = `User ID: ${user.uid.substring(0, 8)}...`;
                    fetchAndRenderCheckoutSummary(); // Panggil untuk memuat data keranjang
                } else {
                    userIdDisplay.textContent = `User ID: N/A`;
                    // Jika tidak login, tampilkan pesan loading dan kemudian arahkan kembali
                    loadingMessage.textContent = 'Anda harus login untuk melihat halaman checkout. Mengarahkan kembali...';
                    loadingMessage.style.display = 'block';
                    checkoutContent.style.display = 'none';
                    placeOrderButton.disabled = true;
                    setTimeout(() => {
                        window.location.href = "apl05.html"; // Arahkan kembali jika tidak login
                    }, 2000); // Tunggu 2 detik sebelum redirect
                }
            });

            // Setel status awal radio button
            document.querySelector('input[name="paymentMethod"]:checked').dispatchEvent(new Event('change'));

            // Event untuk tombol kembali ke keranjang
            backToCartButton.addEventListener('click', () => {
                window.location.href = 'cart.html';
            });
        });
    </script>
</body>
</html>
