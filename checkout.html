<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Checkout - Rujak Buah Indonesia</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
</head>
<body class="bg-gray-100 text-gray-800 font-sans">
  <div class="max-w-md mx-auto bg-white shadow-lg rounded-b-lg overflow-hidden min-h-screen relative pb-24">
    <!-- Header -->
    <header class="bg-gradient-to-r from-green-500 to-lime-500 text-white p-4 flex items-center">
      <i class="fas fa-arrow-left mr-3 text-xl cursor-pointer" onclick="history.back()"></i>
      <h1 class="text-lg font-bold">Checkout Pesanan</h1>
    </header>

    <!-- Form Pengiriman -->
    <div class="p-4 space-y-4">
      <h2 class="text-green-600 font-semibold text-md">Informasi Pengiriman</h2>
      <div>
        <label class="block text-sm font-medium">Nama Lengkap</label>
        <input id="fullName" type="text" class="mt-1 w-full p-2 border rounded focus:ring-2 focus:ring-green-400" placeholder="Nama lengkap Anda" required>
      </div>
      <div>
        <label class="block text-sm font-medium">Nomor Telepon</label>
        <input id="phoneNumber" type="tel" class="mt-1 w-full p-2 border rounded focus:ring-2 focus:ring-green-400" placeholder="08xxxx" required>
      </div>
      <div>
        <label class="block text-sm font-medium">Alamat Pengiriman</label>
        <div class="relative">
          <textarea id="deliveryAddress" rows="3" class="mt-1 w-full p-2 pr-10 border rounded focus:ring-2 focus:ring-green-400" placeholder="Alamat lengkap" required></textarea>
          <i id="gpsIconCheckout" class="fas fa-map-marker-alt absolute right-3 top-3 text-green-500 text-xl cursor-pointer"></i>
        </div>
      </div>
      <div>
        <label class="block text-sm font-medium">Catatan (Opsional)</label>
        <textarea id="notes" rows="2" class="mt-1 w-full p-2 border rounded" placeholder="Contoh: Tanpa kacang, pedas sedang"></textarea>
      </div>

      <!-- Metode Pembayaran -->
      <h2 class="text-green-600 font-semibold mt-6 text-md">Metode Pembayaran</h2>
      <div class="space-y-2">
        <label class="flex items-center p-2 border rounded cursor-pointer">
          <input type="radio" name="paymentMethod" value="COD" checked class="mr-2 accent-green-500" />
          <span class="flex-1">Bayar di Tempat (COD)</span>
          <i class="fas fa-money-bill-wave text-green-500"></i>
        </label>
        <label class="flex items-center p-2 border rounded cursor-pointer">
          <input type="radio" name="paymentMethod" value="Transfer Bank" class="mr-2 accent-green-500" />
          <span class="flex-1">Transfer Bank</span>
          <i class="fas fa-university text-green-500"></i>
        </label>
        <label class="flex items-center p-2 border rounded cursor-pointer">
          <input type="radio" name="paymentMethod" value="E-Wallet" class="mr-2 accent-green-500" />
          <span class="flex-1">E-Wallet (OVO, DANA, GoPay)</span>
          <i class="fas fa-wallet text-green-500"></i>
        </label>
      </div>

      <div id="eWalletTypeWrapper" class="hidden mt-2">
        <label for="eWalletType" class="block text-sm mb-1">Pilih Jenis E-Wallet:</label>
        <select id="eWalletType" class="w-full p-2 border rounded">
          <option value="QRIS" selected>QRIS (Scan Semua)</option>
          <option value="OVO">OVO</option>
          <option value="DANA">DANA</option>
          <option value="GoPay">GoPay</option>
        </select>
      </div>

      <!-- Ringkasan Pesanan -->
      <h2 class="text-green-600 font-semibold mt-6 text-md">Ringkasan Pesanan</h2>
      <div class="text-sm">
        <div class="flex justify-between py-1">
          <span>Total Belanja (<span id="itemCount">0</span> item)</span>
          <span id="subtotalCheckout">Rp 0</span>
        </div>
        <div class="flex justify-between py-1">
          <span>Biaya Pengiriman</span>
          <span id="deliveryFeeCheckout">Rp 0</span>
        </div>
        <div class="flex justify-between font-bold border-t pt-2 mt-2 text-green-600 text-base">
          <span>Total Pembayaran</span>
          <span id="totalAmountCheckout">Rp 0</span>
        </div>
      </div>

      <!-- QRIS -->
      <div id="qrisBox" class="text-center text-sm text-gray-600 mt-4"></div>
    </div>

    <!-- Tombol Buat Pesanan -->
    <button id="placeOrderButton" class="fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-gradient-to-r from-green-500 to-lime-500 text-white font-bold py-3 px-6 rounded-xl shadow-md w-[90%] max-w-md text-lg transition hover:brightness-110 z-10">
      Buat Pesanan
    </button>
  </div>

  <!-- Firebase Script Checkout -->
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCeqHW_m9kru2vmEDVSoelZ3UWFD4k4Xqc",
      authDomain: "tokobuahkasir.firebaseapp.com",
      projectId: "tokobuahkasir",
      storageBucket: "tokobuahkasir.firebasestorage.app",
      messagingSenderId: "731011133713",
      appId: "1:731011133713:web:4247ae627401a01b8c1cb0",
      measurementId: "G-7CPE2DB2BV"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const usersCollection = db.collection('users');
    const pesananCollection = db.collection('pesanan');

    const fullNameInput = document.getElementById('fullName');
    const phoneNumberInput = document.getElementById('phoneNumber');
    const deliveryAddressInput = document.getElementById('deliveryAddress');
    const notesInput = document.getElementById('notes');
    const placeOrderButton = document.getElementById('placeOrderButton');

    const itemCountSpan = document.getElementById('itemCount');
    const subtotalCheckoutSpan = document.getElementById('subtotalCheckout');
    const deliveryFeeCheckoutSpan = document.getElementById('deliveryFeeCheckout');
    const totalAmountCheckoutSpan = document.getElementById('totalAmountCheckout');
    const gpsIconCheckout = document.getElementById('gpsIconCheckout');
    const eWalletTypeWrapper = document.getElementById('eWalletTypeWrapper');

    const cart = JSON.parse(localStorage.getItem('cart')) || [];
    const DELIVERY_FEE = 10000;
    let currentUserId = null;

    function formatRupiah(amount) {
      return new Intl.NumberFormat('id-ID', {
        style: 'currency',
        currency: 'IDR',
        minimumFractionDigits: 0
      }).format(amount);
    }

    function renderOrderSummary() {
      const subtotal = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
      const total = subtotal + (subtotal > 0 ? DELIVERY_FEE : 0);
      itemCountSpan.textContent = cart.length;
      subtotalCheckoutSpan.textContent = formatRupiah(subtotal);
      deliveryFeeCheckoutSpan.textContent = formatRupiah(subtotal > 0 ? DELIVERY_FEE : 0);
      totalAmountCheckoutSpan.textContent = formatRupiah(total);
      if (cart.length === 0) {
        alert("Keranjang kosong.");
        window.location.href = "cart.html";
      }
    }

    gpsIconCheckout.addEventListener('click', () => {
      deliveryAddressInput.placeholder = "Mendeteksi lokasi...";
      navigator.geolocation?.getCurrentPosition(async position => {
        const { latitude, longitude } = position.coords;
        try {
          const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}`);
          const data = await response.json();
          const address = [data.address.road, data.address.village || data.address.town, data.address.city, data.address.state].filter(Boolean).join(', ');
          deliveryAddressInput.value = address;
        } catch {
          deliveryAddressInput.placeholder = "Gagal mengambil lokasi.";
        }
      }, () => alert("Tidak bisa mengakses lokasi."));
    });

    auth.onAuthStateChanged(user => {
      if (!user || localStorage.getItem("userRole") !== "pembeli") {
        alert("Akses ditolak.");
        window.location.href = "index.html";
      } else {
        currentUserId = user.uid;
        usersCollection.doc(currentUserId).get().then(doc => {
          const data = doc.data();
          fullNameInput.value = data.fullName || "";
          phoneNumberInput.value = data.phoneNumber || "";
          deliveryAddressInput.value = data.address || "";
          renderOrderSummary();
        }).catch(() => renderOrderSummary());
      }
    });

    document.querySelectorAll('input[name="paymentMethod"]').forEach(radio => {
      radio.addEventListener('change', () => {
        eWalletTypeWrapper.classList.toggle('hidden', radio.value !== "E-Wallet");
      });
    });

    placeOrderButton.addEventListener('click', async () => {
      const fullName = fullNameInput.value.trim();
      const phoneNumber = phoneNumberInput.value.trim();
      const deliveryAddress = deliveryAddressInput.value.trim();
      const notes = notesInput.value.trim();
      const method = document.querySelector('input[name="paymentMethod"]:checked')?.value;
      const eWalletType = method === "E-Wallet" ? document.getElementById("eWalletType").value : null;

      if (!fullName || !phoneNumber || !deliveryAddress) {
        alert("Harap isi semua informasi pengiriman.");
        return;
      }

      const subtotal = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
      const total = subtotal + (subtotal > 0 ? DELIVERY_FEE : 0);
      const orderData = {
        userId: currentUserId,
        customer: { fullName, phoneNumber, address: deliveryAddress, notes },
        items: cart,
        subtotal,
        deliveryFee: DELIVERY_FEE,
        totalAmount: total,
        paymentMethod: method,
        ...(eWalletType && { eWalletType }),
        status: "Pending",
        waktu: firebase.firestore.FieldValue.serverTimestamp()
      };

      placeOrderButton.disabled = true;
      placeOrderButton.innerText = "Menyimpan...";

      try {
        const docRef = await pesananCollection.add(orderData);
        const orderId = docRef.id;
        const shortId = "#" + orderId.substring(0, 6).toUpperCase();
        await pesananCollection.doc(orderId).update({ displayOrderId: shortId });
        await db.collection('riwayat_customer').doc(currentUserId).collection('pesanan').doc(orderId).set({ ...orderData, displayOrderId: shortId });
        sessionStorage.setItem("lastOrderId", shortId);
        localStorage.removeItem("cart");

        if (method === "E-Wallet" && eWalletType === "QRIS") {
          await buatQRIS(total, fullName);
          alert(`✅ QRIS berhasil dibuat.\nNomor Pesanan: ${shortId}`);
        } else {
          alert(`✅ Pesanan berhasil dibuat.\nNomor Pesanan: ${shortId}`);
          window.location.href = "payment-confirmation.html";
        }
      } catch {
        alert("❌ Gagal membuat pesanan.");
      }

      placeOrderButton.disabled = false;
      placeOrderButton.innerText = "Buat Pesanan";
    });

    async function buatQRIS(amount, name) {
      const qrisBox = document.getElementById("qrisBox");
      qrisBox.innerHTML = "⏳ Memuat QRIS...";
      try {
        const res = await fetch("https://tokobuahkasir.cloudfunctions.net/buatQRIS", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            method: "QRIS",
            merchant_ref: "INV-" + Date.now(),
            amount,
            customer_name: name
          })
        });
        const data = await res.json();
        if (data.success) {
          qrisBox.innerHTML = `<p class="mb-2">✅ QRIS:</p><img src="${data.data.qr_url}" class="mx-auto w-52" /><p class="mt-2 font-semibold text-green-600">Kode: ${data.data.reference}</p>`;
        } else {
          qrisBox.innerHTML = `<p>❌ QRIS Gagal: ${data.message}</p>`;
        }
      } catch {
        qrisBox.innerHTML = `<p>⚠️ Gagal memuat QRIS.</p>`;
      }
    }
  </script>
</body>
</html>
