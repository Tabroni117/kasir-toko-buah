<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Beranda Utama Rujak Buah Indonesia (Penjual)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" />

    <!-- Firebase SDK WAJIB ditaruh di sini -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        /* (Gaya CSS Anda yang sama, tidak ada perubahan di sini) */
        body {
            font-family: sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f2f5;
        }

        .header {
            position: fixed;
            top: 0;
            left: 0;
            width: calc(100% - 40px);
            background: linear-gradient(135deg, #4CAF50, #2E8B57);
            color: white;
            padding: 20px 20px;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            z-index: 1000;
        }

        .header h1 {
            margin: 0;
            font-size: 17px;
            display: flex;
            align-items: center;
            margin-bottom: 2px;
        }

        .leaf-icon {
            margin-right: 5px;
            font-size: 20px;
        }

        .app-description {
            font-size: 14px;
            font-style: italic;
        }

        .container {
            width: 90%;
            max-width: 1200px;
            margin: 80px auto;
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            padding-bottom: 60px;
            animation: fadeIn 0.8s ease;
        }

        @keyframes fadeIn {
            from {opacity: 0; transform: translateY(10px);}
            to {opacity: 1; transform: translateY(0);}
        }

        .main-info {
            background-color: #E8F5E9;
            padding: 20px;
            margin: 20px;
            border-radius: 8px;
            display: flex;
            justify-content: space-around;
            gap: 20px;
        }

        .info-box {
            text-align: center;
            flex: 1;
            color: #388E3C;
        }

        .info-box .value {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .info-box .label {
            font-size: 14px;
            color: #66BB6A;
        }

        .outlet-score {
            background-color: #C8E6C9;
            padding: 15px;
            margin: 0 20px 20px 20px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #388E3C;
            font-weight: bold;
        }

        .menu-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            padding: 20px;
        }

        .menu-item {
            text-align: center;
            padding: 15px;
            border-radius: 8px;
            background-color: #F1F8E9;
            color: #388E3C;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            transition: background-color 0.3s;
        }

        .menu-item:hover {
            background-color: #D0F0C0;
            cursor: pointer;
        }

        .menu-item .icon {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .menu-item .label {
            font-size: 14px;
        }

        .special-feature {
            background-color: #A5D6A7;
            color: white;
            padding: 20px;
            margin: 20px;
            border-radius: 8px;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .special-feature:hover {
            background-color: #81C784;
        }

        .navbar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: #388E3C;
            color: white;
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
            padding: 4px 20px;
            z-index: 1000;
        }

        .nav-item {
            text-align: center;
            padding: 5px;
            transition: background-color 0.3s;
        }

        .nav-item:hover {
            background-color: #2E7D32;
            cursor: pointer;
        }

        .nav-item .icon {
            font-size: 22px;
            margin-bottom: 5px;
        }

        .nav-item .label {
            font-size: 10px;
        }

        .nav-link {
            text-decoration: none;
            color: inherit;
        }

        .header-flex {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            padding-right: 12px;
        }

        .logout-button {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            border: 1px solid white;
            padding: 6px 14px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            margin-left: 10px;
            margin-right: 10px;
            backdrop-filter: blur(3px);
        }
        .logout-button i {
            font-size: 14px
        }
        .spinner-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 80px;
        }
        .spinner {
            width: 36px;
            height: 36px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4CD964;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .berkedip-kuat {
            animation: kedipHebat 1s infinite;
            background-color: #00FF00 !important;
            color: white !important;
            font-weight: bold;
            border: 2px solid white !important;
            box-shadow: 0 0 10px #ff5252;
        }

        @keyframes kedipHebat {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.2; }
        }
        
        .fa-sync-alt.spin {
            animation: rotateRefresh 1s linear infinite;
        }
        @keyframes rotateRefresh {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .logout-button:hover {
            background: rgba(46, 125, 50, 0.9);
        }

        @media (max-width: 768px) {
            .menu-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>

<div id="loadingOverlay" style="
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0.95);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
    flex-direction: column;
    font-family: 'Poppins', sans-serif;
">
    <div class="spinner" style="
        width: 48px;
        height: 48px;
        border: 6px solid #e0e0e0;
        border-top: 6px solid #4CAF50;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 16px;
    "></div>
    <div style="font-size: 18px; color: #4CAF50; font-weight: bold;">Memuat Halaman...</div>
</div>

<div class="header" style="padding: 10px 20px;">
    <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
        <h1 style="margin: 0; font-size: 17px; display: flex; align-items: center;">
            <i class="fas fa-leaf leaf-icon"></i> RUJAK BUAH INDONESIA
        </h1>
        <button class="logout-button" onclick="logout()">
            <i class="fas fa-sign-out-alt"></i> Logout
        </button>
        <div id="logoutSpinner" class="spinner-container" style="display: none;">
            <div class="spinner"></div>
        </div>
    </div>
    <div class="app-description">Aplikasi Penjual</div>
</div>
    
<div class="container">
    <div class="main-info">
        <div class="info-box">
            <div class="value" id="totalPenjualan">Rp 0</div>
            <div class="label">Total Penjualan (Rp)</div>
        </div>
        <div class="info-box">
            <div class="value" id="totalTransaksi">0</div>
            <div class="label">Total Transaksi</div>
        </div>
    </div>

    <div class="outlet-score">
        <span>Skor Outlet</span>
        <span>74/100 &#10095;</span>
    </div>

    <div class="menu-grid">
        <a href="Qris.html" class="menu-item nav-link">
            <div class="icon">&#9776;</div>
            <div class="label">Menu</div>
        </a>
        <a href="dashboard_rujak.html" class="menu-item nav-link">
            <div class="icon">&#x1F4B0;</div>
            <div class="label">Keuangan</div>
        </a>
        <a href="iklan.html" class="menu-item nav-link">
            <div class="icon">&#128227;</div>
            <div class="label">Pasang Iklan</div>
        </a>
        <a href="pesanan-penjual.html" class="menu-item nav-link">
            <div class="icon">&#x1F4CA;</div>
            <div class="label">Id Order</div>
        </a>
        <a href="rating.html" class="menu-item nav-link">
            <div class="icon">&#9733;</div>
            <div class="label">Rating</div>
        </a>
        <a href="penalti.html" class="menu-item nav-link">
            <div class="icon">&#x1F6A8;</div>
            <div class="label">Penalti</div>
        </a>
        <a href="PRODUK.html" class="menu-item nav-link">
            <div class="icon">&#127891;</div>
            <div class="label">Pusat Edukasi</div>
        </a>
        <a href="bantuan.html" class="menu-item nav-link">
            <div class="icon">&#x2753;</div>
            <div class="label">Pusat Bantuan</div>
        </a>
    </div>

    <div id="btnCekPesanan" class="special-feature" onclick="window.location.href='pesanan.html'" style="position: relative;">
        Lihat / Cek Pesanan Masuk
        <span id="notifLonceng" style="display: none; position: absolute; top: -6px; right: -6px;">ðŸ””</span>
    </div>
</div>
    
<div class="navbar">
    <a href="#" onclick="manualReload()" class="nav-item nav-link">
        <div class="icon"><i class="fas fa-sync-alt"></i></div>
        <div class="label">Refresh</div>
    </a>
    <a href="notifikasi.html" class="nav-item nav-link">
        <div class="icon">&#128276;</div>
        <div class="label">Notifikasi</div>
    </a>
    <a href="blankbelumdibuat.html" class="nav-item nav-link">
        <div class="icon">&#128172;</div>
        <div class="label">chat</div>
    </a>
    <a href="marketing.html" class="nav-item nav-link">
        <div class="icon">&#128200;</div>
        <div class="label">Marketing</div>
    </a>
</div>

<audio id="notifSound" src="https://raw.githubusercontent.com/Tabroni117/kasir-toko-buah/main/notifikasi.mp3" preload="auto" loop></audio>

<script>
    // --- Konfigurasi Firebase ---
    const firebaseConfig = {
        apiKey: "AIzaSyCeqHW_m9kru2vmEDVSoelZ3UWFD4k4Xqc",
        authDomain: "tokobuahkasir.firebaseapp.com",
        projectId: "tokobuahkasir",
        storageBucket: "tokobuahkasir.firebasestorage.app",
        messagingSenderId: "731011133713",
        appId: "1:731011133713:web:4247ae627401a01b8c1cb0",
        measurementId: "G-7CPE2DB2BV"
    };

    // Inisialisasi Firebase
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    const auth = firebase.auth();
    const db = firebase.firestore();
    const ordersCollection = db.collection('orders'); // Menggunakan 'orders' sesuai kesepakatan
    const usersCollection = db.collection('users'); // Untuk cek peran pengguna

    // --- Elemen DOM ---
    const loadingOverlay = document.getElementById('loadingOverlay');
    const totalPenjualanElement = document.getElementById('totalPenjualan');
    const totalTransaksiElement = document.getElementById('totalTransaksi');
    const notifLonceng = document.getElementById("notifLonceng");
    const btnCekPesanan = document.getElementById("btnCekPesanan");
    const notifSound = document.getElementById("notifSound");
    const logoutSpinner = document.getElementById('logoutSpinner');

    // --- Fungsi untuk Logout ---
    async function logout() {
        try {
            logoutSpinner.style.display = 'flex';
            localStorage.setItem('isLoggingOut', 'true'); // Flag untuk mencegah alert akses ditolak

            await auth.signOut();

            // Bersihkan semua data sesi lokal
            localStorage.removeItem('isLoggedIn');
            localStorage.removeItem('userRole');
            localStorage.removeItem('userEmail');
            localStorage.removeItem('userUid');
            localStorage.removeItem('manualReload');
            localStorage.removeItem('autoReloadCount');
            localStorage.removeItem('pesananSudahDibuka');
            // Hapus juga flag pesanan baru jika ada
            Object.keys(localStorage).forEach(key => {
                if (key.startsWith('sudahBuka_') || key.startsWith('sudahReloadUntuk_') || key.startsWith('pesananBaruPendingSound') || key.startsWith('acknowledgedOrder_')) {
                    localStorage.removeItem(key);
                }
            });

            setTimeout(() => {
                logoutSpinner.style.display = 'none';
                window.location.href = 'index.html'; // Arahkan ke halaman login
            }, 1000); // Beri waktu spinner tampil sebentar
        } catch (error) {
            console.error("Error saat logout:", error);
            alert('Gagal logout. Coba lagi.');
            localStorage.removeItem('isLoggingOut');
            logoutSpinner.style.display = 'none';
        }
    }

    // --- Reload Manual (Disederhanakan) ---
    function manualReload() {
        const icon = document.querySelector('.fa-sync-alt');
        if (icon) icon.classList.add('spin');
        loadingOverlay.style.display = "flex";
        setTimeout(() => {
            location.reload();
        }, 500);
    }

    // --- Fungsi untuk Menghitung Statistik Harian ---
    async function hitungStatistikHarian() {
        console.log("hitungStatistikHarian: Memulai perhitungan statistik.");
        const now = new Date();
        const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0);
        const endOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59);

        try {
            const snapshot = await ordersCollection
                .where("orderDate", ">=", startOfDay)
                .where("orderDate", "<=", endOfDay)
                .get();

            let totalTransaksi = 0;
            let totalPendapatan = 0;

            snapshot.forEach(doc => {
                const data = doc.data();
                // Pastikan status pesanan adalah 'Completed' atau 'Delivered' untuk dihitung sebagai penjualan
                if (data.totalAmount && (data.status === 'Completed' || data.status === 'Delivered')) {
                    totalTransaksi++;
                    totalPendapatan += parseFloat(data.totalAmount);
                }
            });

            totalPenjualanElement.innerText = "Rp " + totalPendapatan.toLocaleString('id-ID');
            totalTransaksiElement.innerText = totalTransaksi.toLocaleString('id-ID');
            console.log(`hitungStatistikHarian: Total Penjualan Hari Ini: ${totalPendapatan}, Total Transaksi Hari Ini: ${totalTransaksi}`);

        } catch (error) {
            console.error("âŒ Gagal mengambil data statistik harian:", error);
            totalPenjualanElement.innerText = "Rp Error";
            totalTransaksiElement.innerText = "Error";
        }
    }

    // --- Fungsi untuk Mendengarkan Pesanan Baru (Real-time) ---
    function listenForNewOrders() {
        console.log("listenForNewOrders: Memulai listener pesanan baru.");
        ordersCollection
            .where('status', '==', 'Pending') // Hanya dengarkan pesanan dengan status 'Pending'
            .orderBy("orderDate", "desc") // Urutkan berdasarkan tanggal pesanan terbaru
            .onSnapshot(snapshot => { // Gunakan onSnapshot tanpa limit untuk melihat semua pending orders
                console.log("listenForNewOrders: Snapshot diterima.");
                let newOrdersDetected = false;
                snapshot.forEach(doc => {
                    const latestOrderData = doc.data();
                    const latestOrderId = doc.id;
                    console.log(`listenForNewOrders: Memeriksa pesanan ID: ${latestOrderId}, Status: ${latestOrderData.status}`);

                    // --- DEBUGGING: NONAKTIFKAN SEMENTARA acknowledgedOrder_ ---
                    // const isOrderAcknowledged = localStorage.getItem("acknowledgedOrder_" + latestOrderId);
                    // if (!isOrderAcknowledged) {
                    //     newOrdersDetected = true;
                    //     localStorage.setItem("acknowledgedOrder_" + latestOrderId, "true");
                    //     console.log(`listenForNewOrders: Pesanan baru terdeteksi dan diakui: ${latestOrderId}`);
                    // }
                    // --- AKTIFKAN NOTIFIKASI UNTUK SEMUA PENDING ORDER UNTUK DEBUGGING ---
                    newOrdersDetected = true;
                    console.log(`listenForNewOrders: DEBUG MODE - Notifikasi aktif untuk semua pending order.`);
                    // -------------------------------------------------------------------
                });

                if (newOrdersDetected) {
                    console.log("listenForNewOrders: Mengaktifkan notifikasi UI dan suara.");
                    notifLonceng.style.display = "inline";
                    btnCekPesanan.classList.add("berkedip-kuat");

                    if (notifSound) {
                        try {
                            notifSound.currentTime = 0; // Reset audio to start
                            notifSound.play();
                            if (navigator.vibrate) {
                                navigator.vibrate([500, 200, 500, 200, 500]);
                            }
                            console.log("listenForNewOrders: Suara notifikasi diputar.");
                        } catch (e) {
                            console.warn("listenForNewOrders: Gagal memainkan suara notifikasi otomatis:", e);
                        }
                    }
                } else {
                    console.log("listenForNewOrders: Tidak ada pesanan pending yang belum diakui, menonaktifkan notifikasi UI.");
                    notifLonceng.style.display = "none";
                    btnCekPesanan.classList.remove("berkedip-kuat");
                    if (notifSound) {
                        notifSound.pause();
                        notifSound.currentTime = 0;
                    }
                }
            }, error => {
                console.error("âŒ Error mendengarkan pesanan baru:", error);
            });
    }

    // --- Event Listener untuk Tombol Cek Pesanan ---
    btnCekPesanan.addEventListener("click", async () => {
        console.log("btnCekPesanan: Tombol 'Lihat Pesanan Masuk' diklik.");
        if (notifSound) {
            notifSound.pause();
            notifSound.currentTime = 0;
        }
        notifLonceng.style.display = "none";
        btnCekPesanan.classList.remove("berkedip-kuat");

        // --- DEBUGGING: AKTIFKAN KEMBALI LOGIKA ACKNOWLEDGED JIKA SUDAH SELESAI DEBUGGING ---
        // try {
        //     const snapshot = await ordersCollection.where('status', '==', 'Pending').get();
        //     snapshot.forEach(doc => {
        //         localStorage.setItem("acknowledgedOrder_" + doc.id, "true");
        //     });
        //     console.log("btnCekPesanan: Semua pesanan pending ditandai sebagai diakui.");
        // } catch (error) {
        //     console.error("âŒ Error menandai pesanan sebagai diakui:", error);
        // }
        // ------------------------------------------------------------------------------------

        window.location.href = 'pesanan.html';
    });

    // --- Main Logic on DOMContentLoaded ---
    document.addEventListener("DOMContentLoaded", () => {
        console.log("DOMContentLoaded: Halaman penjual dimuat.");
        loadingOverlay.style.display = "none"; // Sembunyikan overlay loading setelah DOM siap

        auth.onAuthStateChanged(user => {
            console.log("onAuthStateChanged: Status autentikasi berubah.");
            const isLoggingOut = localStorage.getItem('isLoggingOut');

            if (isLoggingOut) {
                localStorage.removeItem('isLoggingOut');
                console.log("onAuthStateChanged: Flag isLoggingOut dihapus.");
            }

            if (!user) {
                console.log("onAuthStateChanged: Pengguna tidak login, mengarahkan ke index.html.");
                alert('Anda harus login untuk mengakses halaman ini.');
                window.location.href = 'index.html';
                return;
            }

            // Ambil peran pengguna dari Firestore
            db.collection('users').doc(user.uid).get().then(doc => {
                const userData = doc.data();
                if (!userData || userData.role !== 'penjual') {
                    console.log("onAuthStateChanged: Peran pengguna bukan penjual, mengarahkan ke index.html.");
                    alert('Akses Ditolak: Anda harus login sebagai Penjual untuk mengakses halaman ini.');
                    window.location.href = 'index.html';
                    return;
                }
                // Jika peran adalah penjual, muat data
                console.log('onAuthStateChanged: User Penjual Login:', user.uid);
                hitungStatistikHarian();
                listenForNewOrders(); // Mulai mendengarkan pesanan baru secara real-time
                setInterval(hitungStatistikHarian, 60000); // Perbarui statistik setiap 1 menit
            }).catch(error => {
                console.error("âŒ Error fetching user role:", error);
                alert("Gagal memuat peran pengguna. Silakan coba lagi.");
                window.location.href = 'index.html';
            });
        });
    });

    // Ini untuk memastikan suara bisa diputar setelah interaksi pengguna pertama
    document.addEventListener("click", () => {
        const notifSound = document.getElementById("notifSound");
        if (notifSound) {
            notifSound.play().then(() => {
                notifSound.pause();
                notifSound.currentTime = 0;
                console.log("Autoplay workaround: Suara berhasil diputar dan dihentikan.");
            }).catch((e) => {
                console.warn("Autoplay workaround: Gagal memutar suara awal:", e);
            });
        }
    }, { once: true });
</script>
</body>
</html>
