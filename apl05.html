<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Food Delivery App</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-storage.js"></script>
</head>
<body>
    <div class="container">
        <header class="app-header">
            <div class="location-input">
                <input type="text" id="deliveryAddress" placeholder="Kirim ke alamat pemesan..." readonly>
                <i class="fas fa-location-dot gps-icon" id="gpsIcon"></i>
            </div>
            <div class="user-profile">
                <img src="profile-placeholder.jpg" alt="User Profile" class="profile-pic" id="profilePic">
            </div>
        </header>

        <section class="promo-banner">
            <img src="banner-promo.jpg" alt="Promo Banner">
        </section>

        <section class="categories">
            <div class="category-item">
                <i class="fas fa-burger"></i>
                <span>Makanan</span>
            </div>
            <div class="category-item">
                <i class="fas fa-mug-hot"></i>
                <span>Minuman</span>
            </div>
            <div class="category-item">
                <i class="fas fa-cookie-bite"></i>
                <span>Cemilan</span>
            </div>
            <div class="category-item">
                <i class="fas fa-store"></i>
                <span>Minimarket</span>
            </div>
            <div class="category-item">
                <i class="fas fa-hand-holding-dollar"></i>
                <span>Promo</span>
            </div>
            <div class="category-item">
                <i class="fas fa-gift"></i>
                <span>Rewards</span>
            </div>
            <div class="category-item">
                <i class="fas fa-clipboard-list"></i>
                <span>Lainnya</span>
            </div>
            <div class="category-item">
                <a href="javascript:void(0);" onclick="bukaPopup('menulengkap.html')">
                    <i class="fas fa-ellipsis-h"></i>
                    <span>Lihat Semua</span>
                </a>
            </div>
        </section>

        <section class="menu-section">
            <h2>Rekomendasi</h2>
            <div class="menu-list" id="menuList">
                </div>
        </section>

        <div class="floating-cart-bar" id="floatingCartBar" style="display: none;">
            <div class="cart-info">
                <span id="barItemCountText">0 item</span>
                <span id="barTotalPrice">Total: Rp0</span>
            </div>
            <button class="checkout-button" onclick="bukaPopup('cart.html')">Lanjut</button>
        </div>

        <nav class="bottom-nav">
            <a href="#" class="nav-item active">
                <i class="fas fa-house-chimney"></i>
                <span>Beranda</span>
            </a>
            <a href="#" class="nav-item">
                <i class="fas fa-box-archive"></i>
                <span>Pesanan</span>
            </a>
            <a href="#" class="nav-item">
                <i class="fas fa-bell"></i>
                <span>Notifikasi</span>
            </a>
            <a href="#" class="nav-item">
                <i class="fas fa-user"></i>
                <span>Akun</span>
            </a>
        </nav>

        <div class="popup-panel" id="popupPanel">
            <div class="popup-frame-wrapper">
                <iframe id="popupFrame" src="" frameborder="0"></iframe>
                <button class="popup-close-button" id="popupCloseButton"><i class="fas fa-times"></i></button>
                <div class="popup-checkout-bar" id="popupCheckoutBar" style="display: none;">
                    <div class="cart-info">
                        <span id="bridgeItemCount">0 item</span>
                        <span id="bridgeTotal">Total: Rp0</span>
                    </div>
                    <button class="checkout-button" id="bridgeCheckoutButton">Checkout</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Your Firebase config
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const productsCollection = db.collection('products');
        const cartsCollection = db.collection('carts'); // Koleksi untuk keranjang pengguna

        let currentUserId = null;
        let currentCartData = { items: {} }; // Menyimpan data keranjang saat ini

        // --- DOM Elements ---
        const deliveryAddressInput = document.getElementById('deliveryAddress');
        const gpsIcon = document.getElementById('gpsIcon');
        const profilePic = document.getElementById('profilePic');
        const menuList = document.getElementById('menuList');
        const popupPanel = document.getElementById('popupPanel');
        const popupFrame = document.getElementById('popupFrame');
        const popupCloseButton = document.getElementById('popupCloseButton');
        const floatingCartBar = document.getElementById('floatingCartBar');
        const barItemCountText = document.getElementById('barItemCountText');
        const barTotalPrice = document.getElementById('barTotalPrice');
        const cartBadge = document.getElementById('cartBadge'); // Anda mungkin perlu menambahkan elemen ini di HTML jika belum
        const popupCheckoutBar = document.getElementById('popupCheckoutBar');
        const bridgeItemCount = document.getElementById('bridgeItemCount');
        const bridgeTotal = document.getElementById('bridgeTotal');
        const bridgeCheckoutButton = document.getElementById('bridgeCheckoutButton');

        // --- Helper Functions ---
        function formatRupiah(amount) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(amount);
        }

        function bukaPopup(url) {
            popupFrame.src = url;
            popupPanel.classList.add('show');
            document.body.style.overflow = 'hidden'; // Mencegah scrolling di belakang pop-up

            if (url === 'cart.html' || url === 'menulengkap.html' || url === 'product-detail.html') {
                popupCheckoutBar.style.display = 'flex';
                popupFrame.onload = () => {
                    updateCartUI(); // Panggil ini untuk mengirim data keranjang ke iframe setelah dimuat
                };
            } else {
                popupCheckoutBar.style.display = 'none';
            }
        }

        function tutupPopup() {
            popupPanel.classList.remove('show');
            popupFrame.src = ''; // Bersihkan src iframe
            document.body.style.overflow = ''; // Aktifkan kembali scrolling
            popupCheckoutBar.style.display = 'none'; // Sembunyikan bar saat menutup
        }

        // --- Cart Management Functions (Updated for Firebase Firestore) ---

        // Fungsi untuk menambahkan atau memperbarui item di keranjang
        async function updateCartItem(productId, productName, productPrice, imageUrl, change) {
            if (!currentUserId) {
                alert('Anda harus login untuk menambahkan item ke keranjang.');
                // Optionally redirect to login page
                // window.location.href = 'login.html';
                return;
            }

            const cartRef = cartsCollection.doc(currentUserId);

            try {
                await db.runTransaction(async (transaction) => {
                    const cartDoc = await transaction.get(cartRef);
                    let currentQty = 0;
                    if (cartDoc.exists && cartDoc.data().items && cartDoc.data().items[productId]) {
                        currentQty = cartDoc.data().items[productId].quantity || 0;
                    }

                    const newQty = currentQty + change;

                    if (newQty > 0) {
                        transaction.set(cartRef, {
                            items: {
                                [productId]: {
                                    id: productId,
                                    name: productName,
                                    price: productPrice,
                                    imageUrl: imageUrl,
                                    quantity: newQty
                                }
                            }
                        }, { merge: true }); // Merge agar tidak menimpa item lain
                    } else {
                        // Jika kuantitas 0 atau kurang, hapus item dari keranjang
                        transaction.update(cartRef, {
                            [`items.${productId}`]: firebase.firestore.FieldValue.delete()
                        });
                    }
                });
            } catch (error) {
                console.error("Error updating cart:", error);
                alert("Gagal memperbarui keranjang. Silakan coba lagi.");
            }
        }

        // Fungsi untuk mengatur listener real-time untuk keranjang
        function setupCartListener() {
            if (!currentUserId) return;

            cartsCollection.doc(currentUserId).onSnapshot(docSnapshot => {
                if (docSnapshot.exists) {
                    currentCartData = docSnapshot.data();
                    updateCartUI(); // Perbarui UI saat ada perubahan keranjang
                    updateMenuCardQuantities(); // Perbarui kuantitas di kartu menu utama
                } else {
                    currentCartData = { items: {} }; // Keranjang kosong
                    updateCartUI();
                    updateMenuCardQuantities();
                }
            }, error => {
                console.error("Error listening to cart:", error);
                currentCartData = { items: {} }; // Fallback to empty cart on error
                updateCartUI();
                updateMenuCardQuantities();
            });
        }

        // Fungsi untuk memperbarui tampilan UI keranjang (badge, floating bar, dan popup bar)
        function updateCartUI() {
            let totalItems = 0;
            let totalPrice = 0;

            if (currentCartData && currentCartData.items) {
                Object.values(currentCartData.items).forEach(item => {
                    totalItems += item.quantity;
                    totalPrice += item.quantity * item.price;
                });
            }

            // Update cart badge (jika Anda memiliki elemen ini di header/navbar)
            if (cartBadge) { // Pastikan elemen cartBadge ada di HTML Anda
                if (totalItems > 0) {
                    cartBadge.textContent = totalItems;
                    cartBadge.style.display = 'block';
                } else {
                    cartBadge.style.display = 'none';
                }
            }


            // Update floating cart bar
            if (totalItems > 0) {
                barItemCountText.textContent = `${totalItems} item`;
                barTotalPrice.textContent = `Total: ${formatRupiah(totalPrice)}`;
                floatingCartBar.style.display = 'flex';
            } else {
                floatingCartBar.style.display = 'none';
            }

            // Update popup checkout bar if it's visible and iframe content is loaded
            if (popupPanel.classList.contains('show') && popupFrame.contentWindow) {
                // Kirim data keranjang ke iframe
                popupFrame.contentWindow.postMessage({
                    type: 'UPDATE_CART_DATA',
                    cart: currentCartData,
                    totalItems: totalItems,
                    totalPrice: totalPrice
                }, '*'); // !!! Dalam produksi, ganti '*' dengan origin spesifik iframe Anda untuk keamanan
            }
        }

        // Fungsi untuk memperbarui kuantitas pada kartu menu di halaman utama
        function updateMenuCardQuantities() {
            document.querySelectorAll('.restaurant-card').forEach(card => {
                const productId = card.dataset.productId;
                const addButton = card.querySelector('.add-button');
                const quantityDisplayOnly = card.querySelector('.quantity-display-only');

                if (currentCartData && currentCartData.items && currentCartData.items[productId]) {
                    const quantity = currentCartData.items[productId].quantity;
                    quantityDisplayOnly.textContent = quantity;
                    quantityDisplayOnly.style.display = 'flex';
                    addButton.style.display = 'none';
                } else {
                    quantityDisplayOnly.style.display = 'none';
                    addButton.style.display = 'flex';
                }
            });
        }

        // --- Render Menu Items ---
        async function renderMenuItems() {
            try {
                const snapshot = await productsCollection.get();
                menuList.innerHTML = ''; // Clear existing items

                snapshot.forEach(doc => {
                    const productFromFirebase = doc.data();
                    const productForDetail = {
                        id: doc.id, // Ambil ID dokumen Firebase
                        name: productFromFirebase.nama,
                        description: productFromFirebase.deskripsi,
                        price: productFromFirebase.harga,
                        image: productFromFirebase.imageUrl,
                        rating: productFromFirebase.rating,
                        deliveryTime: productFromFirebase.deliveryTime,
                    };

                    const card = document.createElement('div');
                    card.classList.add('restaurant-card', 'fade-in');
                    card.dataset.productId = productForDetail.id; // Simpan ID produk di dataset

                    card.innerHTML = `
                        <img src="${productForDetail.image || 'https://placehold.co/120x120/cccccc/333333?text=No+Image'}" alt="${productForDetail.name}" class="restaurant-image">
                        <div class="restaurant-info">
                            <div class="restaurant-name">${productForDetail.name}</div>
                            <div class="restaurant-meta">
                                <span class="rating"><i class="fas fa-star"></i> ${productForDetail.rating ? productForDetail.rating.toFixed(1) : 'N/A'}</span>
                                <span class="delivery-time">${productForDetail.deliveryTime || 'Estimasi waktu tidak tersedia'}</span>
                            </div>
                        </div>
                        <div class="add-to-cart-control">
                            <button class="add-button"
                                data-product-id="${productForDetail.id}"
                                data-product-name="${productForDetail.name}"
                                data-product-price="${productForDetail.price}"
                                data-product-image="${productForDetail.image}">+</button>
                            <div class="quantity-display-only" style="display: none;" data-product-id="${productForDetail.id}">0</div>
                        </div>
                    `;

                    // Event listener untuk klik pada kartu (selain tombol +)
                    card.addEventListener('click', (event) => {
                        // Jika klik BUKAN pada area add-to-cart-control, buka detail produk
                        if (!event.target.closest('.add-to-cart-control')) {
                            sessionStorage.setItem('selectedProduct', JSON.stringify(productForDetail));
                            bukaPopup('product-detail.html');
                        }
                    });

                    menuList.appendChild(card);

                    // Event listener untuk tombol 'add-button'
                    const addButton = card.querySelector('.add-button');
                    addButton.addEventListener('click', (event) => {
                        event.stopPropagation(); // Mencegah event klik card ikut terpanggil
                        const prodId = addButton.dataset.productId;
                        const prodName = addButton.dataset.productName;
                        const prodPrice = parseFloat(addButton.dataset.productPrice);
                        const prodImage = addButton.dataset.productImage;
                        updateCartItem(prodId, prodName, prodPrice, prodImage, 1); // Tambah 1 item
                    });
                });
                updateMenuCardQuantities(); // Panggil ini setelah semua kartu dirender
            } catch (error) {
                console.error("Error fetching menu items:", error);
            }
        }

        // --- Event Listeners ---
        popupCloseButton.addEventListener('click', tutupPopup);
        bridgeCheckoutButton.addEventListener('click', () => {
            alert('Lanjut ke halaman Checkout!');
            // Tambahkan logika navigasi ke halaman checkout Anda di sini
            // window.location.href = 'checkout.html';
            tutupPopup();
        });

        // GPS Icon click event
        gpsIcon.addEventListener('click', function() {
            this.classList.add('loading'); // Add a loading class for visual feedback
            deliveryAddressInput.value = 'Mencari lokasi...';

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        const {latitude, longitude} = position.coords;
                        // Example: Using OpenStreetMap Nominatim for reverse geocoding
                        const nominatimUrl = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${latitude}&lon=${longitude}`;
                        try {
                            const response = await fetch(nominatimUrl);
                            const data = await response.json();
                            const address = data.display_name || `Lat: ${latitude}, Lon: ${longitude}`;
                            deliveryAddressInput.value = address;
                            deliveryAddressInput.placeholder = "Kirim ke alamat pemesan...";
                        } catch (geoError) {
                            console.error("Error during reverse geocoding:", geoError);
                            deliveryAddressInput.value = `Lat: ${latitude}, Lon: ${longitude}`;
                            deliveryAddressInput.placeholder = "Gagal mendapatkan nama lokasi";
                        } finally {
                            this.classList.remove('loading');
                        }
                    },
                    (error) => {
                        console.error("Geolocation error:", error);
                        deliveryAddressInput.placeholder = "Gagal mendeteksi lokasi";
                        this.classList.remove('loading');
                        alert(`Error getting location: ${error.message}`);
                    }
                );
            } else {
                deliveryAddressInput.placeholder = "Geolocation tidak didukung browser ini.";
                this.classList.remove('loading');
                alert("Geolocation is not supported by this browser.");
            }
        });

        // --- Firebase Auth State Listener ---
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUserId = user.uid;
                profilePic.src = user.photoURL || 'profile-placeholder.jpg'; // Tampilkan foto profil pengguna
                // Render menu items dan setup cart listener setelah user terautentikasi
                renderMenuItems();
                setupCartListener(); // Mulai mendengarkan perubahan keranjang
            } else {
                // User signed out. Redirect to login or home if not already there.
                currentUserId = null;
                profilePic.src = 'profile-placeholder.jpg'; // Kembali ke placeholder
                menuList.innerHTML = '<p>Silakan login untuk melihat menu.</p>'; // Pesan jika tidak login
                floatingCartBar.style.display = 'none'; // Sembunyikan floating bar
                if (localStorage.getItem('isLoggingOut') !== 'true') {
                    // Redirect to login page if not intentionally logging out
                    // window.location.href = 'login.html'; // Uncomment this to redirect
                }
                localStorage.removeItem('isLoggingOut');
            }
        });

        // --- Message Listener from Iframe ---
        window.addEventListener('message', event => {
            // Penting: Dalam produksi, periksa event.origin untuk keamanan!
            // if (event.origin !== "http://localhost:8080") return; // Ganti dengan origin Anda

            if (event.data.type === 'UPDATE_CART_FROM_IFRAME') {
                const { productId, productName, productPrice, imageUrl, change } = event.data;
                updateCartItem(productId, productName, productPrice, imageUrl, change);
            } else if (event.data.type === 'REQUEST_CART_DATA') {
                // Jika iframe meminta data keranjang (misal saat pertama dimuat)
                updateCartUI(); // Ini akan memicu pengiriman data ke iframe
            } else if (event.data.type === 'CLOSE_POPUP') {
                tutupPopup();
            }
        });

        // Initial render (if user is already logged in, auth.onAuthStateChanged will handle it)
        // renderMenuItems(); // Jangan panggil di sini, biarkan onAuthStateChanged yang memicu
    </script>
</body>
</html>
