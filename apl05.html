<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RUJAK BUAH INDONESIA - Aplikasi Pelanggan</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/countup.js/2.0.7/countUp.min.js"></script>
</head>
<body>
    <div class="app-container">
        <header class="header">
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-leaf leaf-icon"></i>
                    <div class="app-info">
                        <h1>RUJAK BUAH INDONESIA</h1>
                        <p>Aplikasi Pelanggan</p>
                    </div>
                </div>
                <button id="logoutBtn" class="logout-btn">
                    <i class="fas fa-sign-out-alt mr-1"></i> Logout
                </button>
            </div>
            <div class="delivery-bar">
                <i class="fas fa-map-marker-alt gps-icon"></i>
                <input type="text" id="deliveryAddressInput" placeholder="Masukkan alamat pengiriman">
                <button id="detectLocationBtn" class="location-btn">
                    <i class="fas fa-location-arrow"></i> </button>
            </div>
        </header>

        <main class="main-content">
            <section class="promo-section">
                <div class="promo-banner" id="promo-banner">
                    <img src="https://firebasestorage.googleapis.com/v0/b/tokobuahkasir.appspot.com/o/images%2Fpromo1.png?alt=media&token=8d3e9112-a1ce-4277-96a8-f7b76722d56a" alt="Promo 1" class="promo-image active">
                    <img src="https://firebasestorage.googleapis.com/v0/b/tokobuahkasir.appspot.com/o/images%2Fpromo2.png?alt=media&token=9825b426-b8c8-477f-a65c-6b3a04297129" alt="Promo 2" class="promo-image">
                    <img src="https://firebasestorage.googleapis.com/v0/b/tokobuahkasir.appspot.com/o/images%2Fpromo3.png?alt=media&token=0ed3b836-e0e6-42d7-84df-f24b0f9486c9" alt="Promo 3" class="promo-image">
                </div>
            </section>

            <section class="categories-section">
                <h2>Kategori</h2>
                <div class="categories" id="categories">
                    <div class="category-item">
                        <img src="https://firebasestorage.googleapis.com/v0/b/tokobuahkasir.appspot.com/o/images%2Ffastfood.png?alt=media&token=3ce45d9e-10b2-4d2d-94e8-89c02cf896b0" alt="Fast Food">
                        <span>Cepat Saji</span>
                    </div>
                    <div class="category-item">
                        <img src="https://firebasestorage.googleapis.com/v0/b/tokobuahkasir.appspot.com/o/images%2Fdrink.png?alt=media&token=4886676f-0043-4f27-a068-154a106e2365" alt="Drink">
                        <span>Minuman</span>
                    </div>
                    <div class="category-item">
                        <img src="https://firebasestorage.googleapis.com/v0/b/tokobuahkasir.appspot.com/o/images%2Fcake.png?alt=media&token=b687f8f4-6a05-4c07-8898-095a5f6067f9" alt="Cake">
                        <span>Kue & Roti</span>
                    </div>
                    <div class="category-item">
                        <img src="https://firebasestorage.googleapis.com/v0/b/tokobuahkasir.appspot.com/o/images%2Fseafood.png?alt=media&token=f0d2c6c3-1813-41c3-84f9-2b7e1ce8e11a" alt="Seafood">
                        <span>Seafood</span>
                    </div>
                    <div class="category-item">
                        <img src="https://firebasestorage.googleapis.com/v0/b/tokobuahkasir.appspot.com/o/images%2Fspicy.png?alt=media&token=38a2e1d0-b210-449e-b83c-1d4a04d5500e" alt="Spicy">
                        <span>Pedas</span>
                    </div>
                    <div class="category-item">
                        <img src="https://firebasestorage.googleapis.com/v0/b/tokobuahkasir.appspot.com/o/images%2Fvegie.png?alt=media&token=32e01b7a-a63e-462f-87e2-45e0a02f3928" alt="Vegetarian">
                        <span>Vegetarian</span>
                    </div>
                </div>
            </section>

            <section class="menu-section">
                <div class="section-title">
                    <h2>Menu Terlaris</h2>
                    <span class="see-all" onclick="bukaPopup('menulengkap.html')">Lihat Semua</span>
                </div>
                <div class="menu-list" id="menuList">
                    <p class="menu-loading-message" id="loadingText">Memuat menu...</p>
                </div>
            </section>
        </main>

        <div class="floating-cart-bar" id="floatingCartBar" style="display: none;">
            <div class="cart-info">
                <div class="cart-button" onclick="bukaPopup('cart.html')">
                    <i class="fas fa-shopping-cart"></i>
                </div>
                <span id="barItemCountText" class="cart-text">0 item</span>
                <span id="barTotalPrice" class="cart-text">Total: Rp 0</span>
            </div>
            <button class="checkout-button" id="checkoutBtn" onclick="bukaPopup('cart.html')">Checkout</button>
        </div>

        <nav class="bottom-nav">
            <a href="apl05.html" class="nav-item active">
                <i class="fas fa-home nav-icon"></i>
                <div>Beranda</div>
            </a>
            <a href="#" class="nav-item"> <i class="fas fa-search nav-icon"></i>
                <div>Cari</div>
            </a>
            <a href="javascript:void(0);" class="nav-item" id="navCart" style="position: relative;">
                <i class="fas fa-shopping-bag nav-icon"></i>
                <div>Pesanan</div>
                <span id="cartBadge" class="cart-badge" style="display: none;">0</span>
            </a>
            <a href="profile.html" class="nav-item">
                <i class="fas fa-user nav-icon"></i>
                <div>Profile</div>
            </a>
        </nav>

        <div class="popup-panel" id="popupPanel">
            <div class="popup-header">
                <div class="swipe-bar" id="swipeBarClose"></div>
                <button class="close-popup-btn" id="closePopupBtn">&times;</button>
            </div>
            <iframe id="popupFrame" src="" frameborder="0"></iframe>

            </div>

    </div>

    <script>
        // --- Firebase Configuration ---
        // Anda bisa menghapus typeof __app_id dan __firebase_config jika Anda yakin ini hanya akan dijalankan di browser biasa
        // Jika ini bagian dari sistem Canvas atau semacamnya yang menyuntikkan variabel, biarkan saja.
        const firebaseConfig = {
            apiKey: "AIzaSyCeqHW_m9kru2vmEDVSoelZ3UWFD4k4Xqc",
            authDomain: "tokobuahkasir.firebaseapp.com",
            projectId: "tokobuahkasir",
            storageBucket: "tokobuahkasir.firebasestorage.app",
            messagingSenderId: "731011133713",
            appId: "1:731011133713:web:4247ae627401a01b8c1cb0",
            measurementId: "G-7CPE2DB2BV"
        };
        
        // Initialize Firebase (pastikan hanya inisialisasi sekali)
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        
        const auth = firebase.auth();
        const db = firebase.firestore();
        const buahCollection = db.collection('buah'); // Tetap pakai buahCollection
        const cartsCollection = db.collection('carts');

        // DOM Elements
        const logoutBtn = document.getElementById('logoutBtn');
        const deliveryAddressInput = document.getElementById('deliveryAddressInput');
        const detectLocationBtn = document.getElementById('detectLocationBtn');
        const promoBanner = document.getElementById('promo-banner'); // Menggunakan ID promo-banner
        const menuList = document.getElementById('menuList');
        const loadingText = document.getElementById('loadingText');
        const popupPanel = document.getElementById('popupPanel');
        const popupFrame = document.getElementById('popupFrame');
        const closePopupBtn = document.getElementById('closePopupBtn');
        const swipeBarClose = document.getElementById('swipeBarClose');
        const floatingCartBar = document.getElementById('floatingCartBar');
        const cartBadge = document.getElementById('cartBadge');
        const barItemCountText = document.getElementById('barItemCountText');
        const barTotalPrice = document.getElementById('barTotalPrice');
        const navCart = document.getElementById('navCart');
        const checkoutBtn = document.getElementById('checkoutBtn'); // Ini adalah tombol checkout di floatingCartBar

        let currentUserId = null;
        let promoIndex = 0;

        // --- Utility Functions ---
        function formatRupiah(number) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(number);
        }

        // --- Functions for Popup Management ---
        function bukaPopup(url) {
            popupFrame.src = url;
            popupPanel.classList.add('show');
            // Sembunyikan floatingCartBar saat popup terbuka
            floatingCartBar.style.display = 'none'; 
        }

        function tutupPopup() {
            popupPanel.classList.remove('show');
            setTimeout(() => {
                popupFrame.src = ''; // Clear iframe src for memory management
                updateCartUI(); // Update cart UI after popup closes
            }, 300); // Match CSS transition duration for smooth closing
        }

        // --- Cart Management Functions ---
        async function updateCartUI() {
            if (!currentUserId) {
                cartBadge.style.display = 'none';
                floatingCartBar.style.display = 'none';
                return;
            }

            try {
                const itemsCollectionRef = cartsCollection.doc(currentUserId).collection('items');
                const snapshot = await itemsCollectionRef.get();
                let totalItems = 0;
                let totalPrice = 0;

                snapshot.forEach(d => {
                    const data = d.data();
                    totalItems += data.quantity || 0;
                    totalPrice += (data.quantity || 0) * (data.price || 0);
                });

                if (totalItems > 0) {
                    cartBadge.textContent = totalItems;
                    cartBadge.style.display = 'block';

                    barItemCountText.textContent = `${totalItems} item`;
                    barTotalPrice.textContent = `Total: ${formatRupiah(totalPrice)}`;

                    const isCartPopup = popupPanel.classList.contains('show') && popupFrame.src.includes('cart.html');

                    if (totalItems > 0 && !isCartPopup) {
                        floatingCartBar.style.display = 'flex';
                    } else {
                        floatingCartBar.style.display = 'none';
                    }

                } else {
                    cartBadge.style.display = 'none';
                    floatingCartBar.style.display = 'none'; // Sembunyikan jika keranjang kosong
                }
            } catch (error) {
                console.error("Error updating cart UI:", error);
                cartBadge.style.display = 'none';
                floatingCartBar.style.display = 'none';
            }
        }

        // --- Location and Address Functions ---
        async function getAddressFromCoordinates(latitude, longitude) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${latitude}&lon=${longitude}`);
                const data = await response.json();
                if (data && data.display_name) {
                    deliveryAddressInput.value = data.display_name;
                } else {
                    alert('Tidak dapat menemukan alamat untuk lokasi ini.');
                }
            } catch (error) {
                console.error('Error fetching address:', error);
                alert('Gagal mengambil alamat. Periksa koneksi internet Anda atau coba lagi.');
            }
        }

        function detectLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const { latitude, longitude } = position.coords;
                        getAddressFromCoordinates(latitude, longitude);
                    },
                    (error) => {
                        console.error('Error getting location:', error);
                        let errorMessage = 'Gagal mendapatkan lokasi Anda.';
                        switch (error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage += ' Izin lokasi ditolak.';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage += ' Informasi lokasi tidak tersedia.';
                                break;
                            case error.TIMEOUT:
                                errorMessage += ' Waktu permintaan lokasi habis.';
                                break;
                            case error.UNKNOWN_ERROR:
                                errorMessage += ' Terjadi kesalahan tidak dikenal.';
                                break;
                        }
                        alert(errorMessage + ' Pastikan GPS Anda aktif dan berikan izin lokasi.');
                    }
                );
            } else {
                alert('Geolocation tidak didukung oleh browser ini.');
            }
        }

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            // Firebase Auth State Listener
            auth.onAuthStateChanged(async user => {
                if (user) {
                    currentUserId = user.uid;
                    await updateCartUI();
                } else {
                    // Sign in anonymously if no user is authenticated
                    try {
                        const anonUserCredential = await auth.signInAnonymously();
                        currentUserId = anonUserCredential.user.uid;
                        await updateCartUI();
                    } catch (anonError) {
                        console.error("apl05: Error signing in anonymously:", anonError);
                        alert("Gagal login. Beberapa fitur mungkin tidak berfungsi.");
                    }
                }
            });

            // Logout Button Event Listener
            // Pastikan Anda memiliki elemen dengan ID 'logoutBtn' di HTML
            if (logoutBtn) {
                logoutBtn.addEventListener('click', async () => {
                    try {
                        await auth.signOut();
                        localStorage.removeItem('userToken'); // Clear any local token
                        localStorage.removeItem('userId'); // Clear userId if stored
                        window.location.href = 'index.html'; // Redirect to login page
                    } catch (error) {
                        console.error("Error logging out:", error);
                        alert("Gagal logout. Silakan coba lagi.");
                    }
                });
            }

            // Detect Location Button Event Listener
            // Pastikan Anda memiliki elemen dengan ID 'detectLocationBtn' di HTML
            if (detectLocationBtn) {
                detectLocationBtn.addEventListener('click', detectLocation);
            }
            
            // Close Popup Button Event Listener
            // Pastikan Anda memiliki elemen dengan ID 'closePopupBtn' di HTML
            if (closePopupBtn) {
                closePopupBtn.addEventListener('click', tutupPopup);
            }
            
            // Swipe Bar Close Button Event Listener
            // Pastikan Anda memiliki elemen dengan ID 'swipeBarClose' di HTML
            if (swipeBarClose) {
                swipeBarClose.addEventListener('click', tutupPopup);
            }

            // Nav Cart Button Event Listener
            // Pastikan Anda memiliki elemen dengan ID 'navCart' di HTML
            if (navCart) {
                navCart.addEventListener('click', (e) => {
                    e.preventDefault();
                    bukaPopup('cart.html');
                });
            }
            
            // Checkout Button Event Listener (di floatingCartBar)
            // Pastikan Anda memiliki elemen dengan ID 'checkoutBtn' di HTML
            if (checkoutBtn) {
                checkoutBtn.addEventListener('click', () => {
                    bukaPopup('cart.html');
                });
            }

            // Handle messages from iframes (product-detail.html, cart.html)
            window.addEventListener('message', async (event) => {
                // Untuk produksi, ganti '*' dengan origin spesifik dari iframe Anda
                // if (event.origin !== window.location.origin) return; 

                if (event.data && event.data.type) {
                    if (event.data.type === 'cartUpdatedFromProductDetail' || event.data.type === 'cartUpdatedFromCartPage') {
                        await updateCartUI(); 
                        if (popupPanel.classList.contains('show') && popupFrame.src.includes('product-detail.html')) {
                            floatingCartBar.style.display = 'flex';
                        }
                    } else if (event.data.type === 'closeProductDetailPopup' || event.data.type === 'closeCartPopup') {
                        tutupPopup(); 
                    }
                }
            });

            // --- Load Menu Terlaris ---
            async function loadMenu() {
                try {
                    const snapshot = await buahCollection.where('isAvailable', '==', true).orderBy('nama').get();
                    menuList.innerHTML = ''; // Clear loading text

                    if (snapshot.empty) {
                        menuList.innerHTML = '<p class="menu-loading-message">Tidak ada menu yang tersedia saat ini.</p>';
                        return;
                    }

                    snapshot.forEach(doc => {
                        const product = { 
                            id: doc.id, 
                            name: doc.data().nama, 
                            description: doc.data().deskripsi, 
                            price: doc.data().harga, 
                            image: doc.data().imageUrl, 
                            rating: doc.data().rating,
                            deliveryTime: doc.data().deliveryTime || 'Estimasi waktu tidak tersedia',
                        };

                        const productCard = document.createElement('div');
                        productCard.classList.add('restaurant-card', 'fade-in'); 
                        productCard.innerHTML = `
                            <img src="${product.image || 'https://placehold.co/120x120/cccccc/333333?text=No+Image'}" alt="${product.name}" class="restaurant-image">
                            <div class="restaurant-info">
                                <h3 class="restaurant-name">${product.name}</h3>
                                <div class="rating">
                                    <span>⭐ ${product.rating ? product.rating.toFixed(1) : 'N/A'}</span>
                                    <span>${product.deliveryTime}</span>
                                </div>
                                <p class="restaurant-price">${formatRupiah(product.price)}</p>
                            </div>
                            <button class="add-button" data-product-id="${product.id}">+</button>
                        `;
                        menuList.appendChild(productCard);

                        // Event listener for opening product detail
                        productCard.querySelector('.restaurant-info').addEventListener('click', () => {
                            sessionStorage.setItem('selectedProduct', JSON.stringify(product));
                            bukaPopup('product-detail.html');
                        });
                        productCard.querySelector('.restaurant-image').addEventListener('click', () => {
                            sessionStorage.setItem('selectedProduct', JSON.stringify(product));
                            bukaPopup('product-detail.html');
                        });
                        
                        productCard.querySelector('.add-button').addEventListener('click', (e) => {
                            e.stopPropagation(); 
                            sessionStorage.setItem('selectedProduct', JSON.stringify(product));
                            bukaPopup('product-detail.html'); 
                        });
                    });
                } catch (error) {
                    console.error("Error loading menu:", error);
                    menuList.innerHTML = '<p class="menu-loading-message">Gagal memuat menu. Silakan coba lagi nanti.</p>';
                }
            }

            // Initial load of menu
            loadMenu();

            // Promo Banner Automatic Slider
            // Menggunakan ID promo-banner dan mencari class promo-image di dalamnya
            if (promoBanner) {
                setInterval(() => {
                    const promoImages = promoBanner.querySelectorAll('.promo-image');
                    if (promoImages.length > 0) {
                        promoImages[promoIndex].classList.remove('active');
                        promoIndex = (promoIndex + 1) % promoImages.length;
                        promoImages[promoIndex].classList.add('active');
                    }
                }, 5000); // Change image every 5 seconds
            }
        });
    </script>
</body>
</html>
