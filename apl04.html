<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Riwayat Semua Pesanan - Rujak Buah Indonesia</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
  <!-- Firebase SDK v9 Compatibility - PENTING: Gunakan versi compat ini -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      background-color: #f5f7fa;
      color: #333;
      line-height: 1.6;
    }

    .app-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 15px;
    }

    header {
      background: linear-gradient(135deg, #00C853 0%, #007E33 100%);
      color: white;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 15px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      display: flex;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .back-button {
      font-size: 24px;
      margin-right: 15px;
      cursor: pointer;
    }

    .header-title {
      font-size: 1.3rem;
      font-weight: bold;
    }

    .filter-search-section {
      background: white;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      margin-bottom: 15px;
    }

    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 15px;
      justify-content: center;
    }

    .filter-btn {
      padding: 8px 12px;
      background-color: #f0f2f5;
      border: 1px solid #ddd;
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 500;
      font-size: 0.9rem;
    }

    .filter-btn.active {
      background: linear-gradient(135deg, #00C853 0%, #007E33 100%);
      color: white;
      border-color: #007E33;
      box-shadow: 0 2px 5px rgba(0,200,83,0.3);
    }

    .search-box {
      display: flex;
      gap: 8px;
      margin-bottom: 15px;
    }

    .search-box input {
      flex: 1;
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 0.9rem;
    }

    .search-box button {
      padding: 10px 15px;
      background: linear-gradient(135deg, #00C853 0%, #007E33 100%);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
      font-size: 0.9rem;
      box-shadow: 0 2px 5px rgba(0,200,83,0.3);
    }

    .date-filter {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 15px;
    }

    .date-filter label {
      font-weight: 500;
      font-size: 0.9rem;
    }

    .date-filter input {
      flex: 1;
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 0.9rem;
    }

    .reset-filters-btn {
      padding: 10px 15px;
      background-color: #6c757d;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
      font-size: 0.9rem;
    }

    .order-history-content {
      display: grid;
      grid-template-columns: 1fr;
      gap: 15px;
    }

    .order-card {
      background: white;
      border-radius: 10px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
      padding: 15px;
      border-left: 4px solid #00C853;
      transition: transform 0.3s, box-shadow 0.3s;
      cursor: pointer;
    }

    .order-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12);
    }

    .order-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
    }

    .order-id {
      font-weight: bold;
      color: #00C853;
      font-size: 1.1rem;
    }

    .order-status {
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 500;
    }

    .status-Pending {
      background-color: #fff3cd;
      color: #856404;
    }

    .status-Diproses {
      background: linear-gradient(135deg, #00C853 0%, #007E33 100%);
      color: white;
    }

    .status-SiapDiambil {
      background: linear-gradient(135deg, #00C853 0%, #007E33 100%);
      color: white;
    }

    .status-OnDelivery {
      background: linear-gradient(135deg, #00C853 0%, #007E33 100%);
      color: white;
    }

    .status-Selesai {
      background-color: #d4edda;
      color: #155724;
    }

    .status-Dibatalkan {
      background-color: #f8d7da;
      color: #721c24;
    }

    .order-customer {
      font-weight: 500;
      margin-bottom: 8px;
      font-size: 1rem;
    }

    .order-time {
      color: #6c757d;
      font-size: 0.85rem;
      margin-bottom: 12px;
    }

    .order-items {
      margin-bottom: 12px;
    }

    .order-item {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
      gap: 10px;
    }

    .order-item-image {
      width: 45px;
      height: 45px;
      object-fit: cover;
      border-radius: 5px;
      background-color: #eee;
    }

    .order-item-details {
      flex-grow: 1;
    }

    .order-item-name {
      font-weight: 500;
      margin-bottom: 2px;
      font-size: 0.95rem;
    }

    .order-item-variants-display {
      display: block;
      font-size: 0.8rem;
      color: #6c757d;
      margin-top: 2px;
    }

    .order-item-quantity-price {
      font-size: 0.85rem;
      color: #6c757d;
    }

    .order-item-total {
      font-weight: bold;
      white-space: nowrap;
      margin-left: auto;
      font-size: 0.95rem;
    }

    .order-summary-footer {
      display: flex;
      justify-content: space-between;
      padding-top: 10px;
      border-top: 1px solid #eee;
      margin-top: 10px;
    }

    .order-total-amount {
      font-weight: bold;
      font-size: 1.1rem;
      color: #00C853;
    }

    .order-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 15px;
    }

    .action-btn {
      padding: 8px 12px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 500;
      transition: background-color 0.2s;
      flex: 1;
      min-width: 100px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
    }

    .action-btn.terima, .action-btn.siap-diambil, .action-btn.pick-up {
      background: linear-gradient(135deg, #00C853 0%, #007E33 100%);
      color: white;
      box-shadow: 0 2px 5px rgba(0,200,83,0.3);
    }

    .action-btn.tolak {
      background-color: #6c757d;
      color: white;
    }

    .action-btn.selesai {
      background: linear-gradient(135deg, #00C853 0%, #007E33 100%);
      color: white;
      box-shadow: 0 2px 5px rgba(0,200,83,0.3);
    }

    .empty-state {
      grid-column: 1 / -1;
      text-align: center;
      padding: 40px 20px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
    }

    .empty-state i {
      font-size: 3rem;
      color: #ccc;
      margin-bottom: 20px;
    }

    .empty-state p {
      font-size: 1.2rem;
      color: #6c757d;
    }

    /* Loading Spinner */
    #loadingSpinner {
      display: none;
      justify-content: center;
      align-items: center;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1000;
    }

    .spinner {
      border: 5px solid #f3f3f3;
      border-top: 5px solid #00C853;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Popup Detail */
    .popup-detail {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .popup-content {
      background: white;
      border-radius: 10px;
      width: 95%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
      padding: 20px;
      position: relative;
    }

    .close-popup {
      position: absolute;
      top: 15px;
      right: 20px;
      font-size: 1.5rem;
      cursor: pointer;
      color: #6c757d;
    }

    .popup-header {
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid #eee;
    }

    .popup-title {
      font-size: 1.3rem;
      color: #00C853;
    }

    .popup-section {
      margin-bottom: 20px;
    }

    .popup-section-title {
      font-weight: 600;
      margin-bottom: 10px;
      color: #495057;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 1.1rem;
    }

    .popup-section-title i {
      color: #00C853;
    }

    .order-info-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 8px;
    }

    .info-label {
      font-weight: 500;
      color: #6c757d;
      font-size: 0.9rem;
    }

    .info-value {
      color: #212529;
      font-size: 0.95rem;
    }

    .order-status-popup {
      display: inline-block;
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 0.9rem;
      font-weight: 500;
    }

    .driver-info-section {
      background-color: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      margin-top: 15px;
    }

    .driver-info-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }

    .driver-info-grid .info-label {
      font-weight: 500;
    }

    .status-updater {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 15px;
    }

    .status-updater select {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      width: 100%;
    }

    .status-updater button {
      padding: 10px 15px;
      background: linear-gradient(135deg, #00C853 0%, #007E33 100%);
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: 500;
      box-shadow: 0 2px 5px rgba(0,200,83,0.3);
    }

    .driver-form {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-top: 15px;
    }

    .driver-form input, .driver-form select {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      width: 100%;
    }

    .driver-form button {
      padding: 12px;
      background: linear-gradient(135deg, #00C853 0%, #007E33 100%);
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: 500;
      box-shadow: 0 2px 5px rgba(0,200,83,0.3);
    }

    /* Custom Modals */
    #customConfirmModal, #customAlertDialog, #modalVerifikasi {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      z-index: 9998;
      justify-content: center;
      align-items: center;
    }

    #customConfirmModal > div, #customAlertDialog > div, #modalVerifikasi > div {
      background-color: white;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      text-align: center;
      max-width: 300px;
      width: 90%;
    }

    #customConfirmModal p, #customAlertDialog p, #modalVerifikasi p {
      margin-bottom: 20px;
      font-size: 16px;
      color: #333;
    }

    #customConfirmModal button, #customAlertDialog button, #modalVerifikasi button {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      transition: background-color 0.2s;
      margin: 0 5px;
    }

    #customConfirmYes, #customAlertOk, #saveDriverDetailsBtn {
      background-color: #00C853;
      color: white;
    }

    #customConfirmNo, #customAlertOk, #modalVerifikasi button {
      background-color: #6c757d;
      color: white;
    }

    #customConfirmYes:hover, #customAlertOk:hover, #saveDriverDetailsBtn:hover {
      background-color: #388E3C;
    }

    #customConfirmNo:hover {
      background-color: #5a6268;
    }

    #inputPassword {
      width: 100%;
      padding: 8px;
      margin-top: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      box-sizing: border-box;
    }

    @media (min-width: 768px) {
      .app-container {
        padding: 20px;
      }
      
      .order-history-content {
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      }
      
      .driver-form {
        display: grid;
        grid-template-columns: 1fr 1fr;
      }
      
      .driver-form button {
        grid-column: span 2;
      }
      
      .status-updater {
        flex-direction: row;
        align-items: center;
      }
      
      .status-updater select {
        flex: 1;
      }
      
      .order-info-grid {
        grid-template-columns: 1fr 2fr;
      }
      
      .driver-info-grid {
        grid-template-columns: auto 1fr;
      }
      
      .search-box, .date-filter {
        margin-bottom: 0;
      }
    }
  </style>
</head>
<body>
    <div class="container">
        <header class="header-detail">
            <i class="fas fa-arrow-left back-button" onclick="history.back()"></i>
            <div class="header-title">Riwayat Semua Pesanan</div>
        </header>

        <div class="filter-search-section">
            <div class="form-group">
                <label for="searchQuery">Cari ID Pesanan / Nama Pelanggan:</label>
                <input type="text" id="searchQuery" class="form-group-input" placeholder="Cari pesanan...">
            </div>
            <div class="form-group">
                <label for="filterDate">Filter Tanggal:</label>
                <input type="date" id="filterDate" class="form-group-input">
            </div>
            <div class="filter-buttons">
                <button class="filter-btn active" data-status="Pending">Baru</button>
                <button class="filter-btn" data-status="Diproses">Diproses</button>
                <button class="filter-btn" data-status="SiapDiambil">Siap Ambil</button>
                <button class="filter-btn" data-status="OnDelivery">On Delivery</button>
                <button class="filter-btn" data-status="Selesai">Selesai</button>
                <!-- Tombol "Dibatalkan" dihapus -->
            </div>
            <button id="resetFiltersBtn" class="btn-reset"><i class="fas fa-redo"></i> Reset Filter</button>
        </div>

        <div id="loadingSpinner" style="display: none;">
            <div class="spinner"></div>
        </div>

        <div class="order-history-content" id="orderHistoryContent">
            <div class="empty-state" id="emptyOrderState" style="display: none;">
                <i class="fas fa-box-open"></i>
                <p>Belum ada pesanan dari pelanggan.</p>
            </div>
        </div>

        <!-- Tombol hapus semua pesanan (untuk admin) -->
        <button onclick="hapusSemuaPesananPenjual()" style="background-color: #f44336; color: white; border: none; padding: 10px 20px; border-radius: 25px; cursor: pointer; margin: 20px auto; display: block;">Hapus Semua Pesanan</button>
    </div>

    <!-- Popup Detail Pesanan -->
    <div id="popupDetail">
        <div>
            <button onclick="tutupDetail()" class="close-button">&times;</button>
            <h3 id="popupNama">Nama Pelanggan</h3>

            <p><strong>ID Pesanan:</strong> <span id="popupOrderId">#-</span></p>
            <p><strong>Nomor HP:</strong> <span id="popupNomor">-</span></p>
            <p><strong>Alamat:</strong> <span id="popupAlamat">-</span></p>
            <p><strong>Total Pembayaran:</strong> <span id="popupTotal">-</span></p>
            <p><strong>Metode Pembayaran:</strong> <span id="popupMetodeBayar">-</span></p>
            <p><strong>Catatan:</strong> <span id="popupCatatan">-</p>

            <p style="margin-bottom: 10px;">
                <strong>Status Pesanan:</strong> <span id="popupStatus" class="order-status"></span>
                <select id="statusUpdater" class="status-dropdown">
                    <option value="Pending">Pending</option>
                    <option value="Diproses">Diproses</option>
                    <option value="SiapDiambil">Siap Diambil</option>
                    <option value="OnDelivery">On Delivery</option>
                    <option value="Selesai">Selesai</option>
                    <option value="Dibatalkan">Dibatalkan</option>
                </select>
            </p>

            <!-- NEW: Driver Info Section -->
            <div id="driverInfoSection" class="driver-info-section">
                <h4>Detail Driver:</h4>
                <label for="driverNameInput">Nama Driver:</label>
                <input type="text" id="driverNameInput" placeholder="Nama Driver">

                <label for="driverPhoneInput">Nomor HP Driver:</label>
                <input type="text" id="driverPhoneInput" placeholder="Nomor HP Driver">

                <label for="driverAppSelect">Aplikasi Ojek:</label>
                <select id="driverAppSelect">
                    <option value="">Pilih Aplikasi</option>
                    <option value="Gojek">Gojek</option>
                    <option value="Grab">Grab</option>
                    <option value="Maxim">Maxim</option>
                    <option value="In-house">In-house</option>
                    <option value="Lainnya">Lainnya</option>
                </select>
                <!-- NEW: Tombol Simpan Detail Driver -->
                <button id="saveDriverDetailsBtn" class="action-btn siap-diambil" style="width: 100%; margin-top: 15px;">
                    <i class="fas fa-save"></i> Simpan Detail Driver
                </button>
            </div>
            <!-- END NEW: Driver Info Section -->

            <p><strong>Waktu Pesanan:</strong> <span id="popupWaktu">-</span></p>
            <p><strong>Dibuka oleh:</strong> <span id="popupDibukaOleh">-</span></p>
            <p><strong>Waktu Dibuka:</strong> <span id="popupWaktuDibuka">-</p>
            <p><strong>Diubah oleh:</strong> <span id="popupDiubahOleh">-</p>
            <p><strong>Waktu Ubah:</strong> <span id="popupWaktuDiubah">-</p>

            <h4>Detail Item:</h4>
            <div id="popupItems"></div>

            <button onclick="tutupDetail()" class="popup-close-btn">Tutup</button>
        </div>
    </div>

    <!-- Custom Confirmation Modal -->
    <div id="customConfirmModal">
        <div>
            <p id="customConfirmMessage"></p>
            <button id="customConfirmYes">Ya</button>
            <button id="customConfirmNo">Tidak</button>
        </div>
    </div>

    <!-- Custom Alert Modal -->
    <div id="customAlertDialog">
        <div>
            <p id="customAlertMessage"></p>
            <button id="customAlertOk">OK</button>
        </div>
    </div>

    <!-- Modal Verifikasi Password -->
    <div id="modalVerifikasi" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background-color:rgba(0,0,0,0.5); z-index:9999; align-items:center; justify-content:center;">
        <div style="background:white; padding:20px; border-radius:8px; width:300px; box-shadow:0 0 10px rgba(0 0 0 / 30%);">
            <h3>🔐 Verifikasi Hapus</h3>
            <p>Masukkan password untuk melanjutkan.</p>
            <input type="password" id="inputPassword" placeholder="Password" style="width:100%; padding:8px; margin-top:10px;">
            <div class="button-group-modal" style="display:flex; justify-content:flex-end; gap:10px; margin-top:15px;">
                <button onclick="tutupModalVerifikasi()" style="padding: 8px 15px; border: none; border-radius: 20px; cursor: pointer; font-weight: 600; font-size: 13px; background-color: #ccc; color: #333;">Batal</button>
                <button onclick="verifikasiPasswordDanHapus()" style="padding: 8px 15px; border: none; border-radius: 20px; cursor: pointer; font-weight: 600; font-size: 13px; background-color: #f44336; color: white;">Hapus</button>
            </div>
        </div>
    </div>

    <script>
        // --- Firebase Configuration ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyCeqHW_m9kru2vmEDVSoelZ3UWFD4k4Xqc",
            authDomain: "tokobuahkasir.firebaseapp.com",
            projectId: "tokobuahkasir",
            storageBucket: "tokobuahkasir.firebasestorage.app",
            messagingSenderId: "731011133713",
            appId: "1:731011133713:web:4247ae627401a01b8c1cb0",
            measurementId: "G-7CPE2DB2BV"
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // DOM Elements
        const orderHistoryContent = document.getElementById('orderHistoryContent');
        const emptyOrderState = document.getElementById('emptyOrderState');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const searchQueryInput = document.getElementById('searchQuery');
        const filterDateInput = document.getElementById('filterDate');
        const filterButtons = document.querySelectorAll('.filter-btn');
        const resetFiltersBtn = document.getElementById('resetFiltersBtn');

        // Popup Detail Elements
        const popupDetail = document.getElementById('popupDetail');
        const popupNama = document.getElementById('popupNama');
        const popupOrderId = document.getElementById('popupOrderId');
        const popupNomor = document.getElementById('popupNomor');
        const popupAlamat = document.getElementById('popupAlamat');
        const popupTotal = document.getElementById('popupTotal');
        const popupMetodeBayar = document.getElementById('popupMetodeBayar');
        const popupCatatan = document.getElementById('popupCatatan');
        const popupStatus = document.getElementById('popupStatus');
        const statusUpdater = document.getElementById('statusUpdater');
        const popupWaktu = document.getElementById('popupWaktu');
        const popupDibukaOleh = document.getElementById('popupDibukaOleh');
        const popupWaktuDibuka = document.getElementById('popupWaktuDibuka');
        const popupDiubahOleh = document.getElementById('popupDiubahOleh');
        const popupWaktuDiubah = document.getElementById('popupWaktuDiubah');
        const popupItems = document.getElementById('popupItems');

        // NEW: Driver Info Input Elements
        const driverInfoSection = document.getElementById('driverInfoSection');
        const driverNameInput = document.getElementById('driverNameInput');
        const driverPhoneInput = document.getElementById('driverPhoneInput');
        const driverAppSelect = document.getElementById('driverAppSelect');
        const saveDriverDetailsBtn = document.getElementById('saveDriverDetailsBtn');

        // Custom Modals
        const customConfirmModal = document.getElementById('customConfirmModal');
        const customConfirmMessage = document.getElementById('customConfirmMessage');
        const customConfirmYes = document.getElementById('customConfirmYes');
        const customConfirmNo = document.getElementById('customConfirmNo');
        const customAlertDialog = document.getElementById('customAlertDialog');
        const customAlertMessage = document.getElementById('customAlertMessage');
        const customAlertOk = document.getElementById('customAlertOk');
        const modalVerifikasi = document.getElementById('modalVerifikasi');
        const inputPassword = document.getElementById('inputPassword');


        let currentOrderIdForDetail = null;
        let activeFilterStatus = 'Pending'; // Default filter status is now 'Pending'
        let allOrdersData = [];
        let unsubscribeOrders = null;

        // --- Helper Functions ---
        function showLoading() { loadingSpinner.style.display = 'flex'; }
        function hideLoading() { loadingSpinner.style.display = 'none'; }

        function formatRupiah(amount) {
            if (isNaN(amount) || amount === null || typeof amount === 'undefined') {
                return "Rp0";
            }
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(amount);
        }

        function formatDate(date) {
            if (!date) return "-";
            const d = (date instanceof firebase.firestore.Timestamp) ? date.toDate() : new Date(date);
            if (isNaN(d.getTime())) return "-";
            return d.toLocaleString("id-ID", { day: "numeric", month: "long", year: "numeric", hour: "2-digit", minute: "2-digit" });
        }

        function getStatusClass(status) {
            switch (status?.toLowerCase()) {
                case 'pending': return 'pending';
                case 'diproses': return 'diproses';
                case 'selesai': return 'selesai';
                case 'dibatalkan': return 'dibatalkan';
                case 'siapdiambil': return 'siap-diambil';
                case 'ondelivery': return 'on-delivery';
                default: return '';
            }
        }

        function getDisplayStatus(status) {
            switch (status) {
                case 'Pending': return 'Baru';
                case 'Diproses': return 'Diproses';
                case 'SiapDiambil': return 'Siap Ambil';
                case 'OnDelivery': return 'On Delivery';
                case 'Selesai': return 'Selesai';
                case 'Dibatalkan': return 'Dibatalkan';
                default: return status;
            }
        }

        function getVariantDisplayString(customVariants) {
            if (!customVariants || Object.keys(customVariants).length === 0) {
                return 'Tidak ada varian';
            }
            const parts = [];
            const sortedVariantTypeIds = Object.keys(customVariants).sort();
            for (const variantTypeId of sortedVariantTypeIds) {
                const value = customVariants[variantTypeId];
                if (Array.isArray(value)) {
                    if (value.length > 0) {
                        parts.push(value.join(', '));
                    }
                } else if (value && value !== 'none') {
                    parts.push(value);
                }
            }
            return parts.length > 0 ? parts.join(', ') : 'Tidak ada varian';
        }

        // Custom Confirmation Modal
        function showCustomConfirm(message) {
            return new Promise((resolve) => {
                customConfirmMessage.textContent = message;
                customConfirmModal.style.display = 'flex';

                const handleYes = () => {
                    customConfirmModal.style.display = 'none';
                    customConfirmYes.removeEventListener('click', handleYes);
                    customConfirmNo.removeEventListener('click', handleNo);
                    resolve(true);
                };
                const handleNo = () => {
                    customConfirmModal.style.display = 'none';
                    customConfirmYes.removeEventListener('click', handleYes);
                    customConfirmNo.removeEventListener('click', handleNo);
                    resolve(false);
                };

                customConfirmYes.addEventListener('click', handleYes);
                customConfirmNo.addEventListener('click', handleNo);
            });
        }

        // Custom Alert Modal
        function showCustomAlert(message) {
            return new Promise((resolve) => {
                customAlertMessage.textContent = message;
                customAlertDialog.style.display = 'flex';

                const handleOk = () => {
                    customAlertDialog.style.display = 'none';
                    customAlertOk.removeEventListener('click', handleOk);
                    resolve();
                };

                customAlertOk.addEventListener('click', handleOk);
            });
        }

        // --- Render Order Items to DOM ---
        function renderOrders(ordersToRender) {
            orderHistoryContent.innerHTML = '';
            emptyOrderState.style.display = 'none';

            if (ordersToRender.length === 0) {
                emptyOrderState.style.display = 'block';
                return;
            }

            ordersToRender.forEach(order => {
                const displayOrderId = order.displayOrderId || ('#' + order.id.substring(0, 6).toUpperCase());
                let buyerName = order.customer?.fullName || 'Pelanggan Anonim';
                let currentStatus = order.status || 'Pending';

                // Determine which action buttons to show based on status
                let actionButtonsHtml = '';
                if (currentStatus === 'Pending') {
                    actionButtonsHtml = `
                        <button class="action-btn terima" data-order-id="${order.id}" data-action="Diproses">
                            <i class="fas fa-check"></i> Terima
                        </button>
                        <button class="action-btn tolak" data-order-id="${order.id}" data-action="Dibatalkan">
                            <i class="fas fa-times"></i> Tolak
                        </button>
                    `;
                } else if (currentStatus === 'Diproses') {
                    actionButtonsHtml = `
                        <button class="action-btn siap-diambil" data-order-id="${order.id}" data-action="SiapDiambil">
                            <i class="fas fa-check-double"></i> Siap Ambil
                        </button>
                    `;
                } else if (currentStatus === 'SiapDiambil') {
                    actionButtonsHtml = `
                        <button class="action-btn pick-up" data-order-id="${order.id}" data-action="OnDelivery">
                            <i class="fas fa-truck"></i> Pick Up
                        </button>
                    `;
                } else if (currentStatus === 'OnDelivery') {
                    actionButtonsHtml = `
                        <button class="action-btn selesai" data-order-id="${order.id}" data-action="Selesai">
                            <i class="fas fa-check-circle"></i> Selesai
                        </button>
                    `;
                }

                // Construct driver info for card if OnDelivery - REFINED DISPLAY
                let driverInfoCardHtml = '';
                if (currentStatus === 'OnDelivery' && (order.driverName || order.driverPhone || order.driverApp)) {
                    driverInfoCardHtml = `
                        <div class="order-driver-info-container">
                            <div class="driver-line">
                                <i class="fas fa-truck driver-icon"></i>
                                <span class="driver-label-text">Diantar</span>
                                <span class="driver-colon">:</span>
                                <span class="driver-value">Via <strong>${order.driverApp || '-'}</strong></span>
                            </div>
                            ${order.driverName ? `
                            <div class="driver-line">
                                <i class="fas fa-user driver-icon"></i>
                                <span class="driver-label-text">Driver</span>
                                <span class="driver-colon">:</span>
                                <span class="driver-value">${order.driverName}</span>
                            </div>` : ''}
                            ${order.driverPhone ? `
                            <div class="driver-line">
                                <i class="fas fa-phone driver-icon"></i>
                                <span class="driver-label-text">Telp.</span>
                                <span class="driver-colon">:</span>
                                <span class="driver-value">${order.driverPhone}</span>
                            </div>` : ''}
                        </div>
                    `;
                }

                const orderCard = document.createElement('div');
                orderCard.classList.add('order-card');
                orderCard.setAttribute('data-order-id', order.id);

                orderCard.innerHTML = `
                    <div class="order-header">
                        <span class="order-id">Pesanan: ${displayOrderId}</span>
                        <span class="order-date">${formatDate(order.waktu)}</span>
                    </div>
                    <div class="order-details">
                        <p><strong>Pembeli:</strong> ${buyerName}</p>
                        <p><strong>Status:</strong> <span class="order-status ${getStatusClass(currentStatus)}">${getDisplayStatus(currentStatus)}</span></p>
                        ${driverInfoCardHtml} <!-- Display driver info in a structured way -->
                        <p><strong>Metode Pembayaran:</strong> ${order.paymentMethod}</p>
                        <p><strong>Alamat:</strong> ${order.customer?.address || order.alamat || 'Alamat tidak tersedia'}</p>
                        <ul class="order-item-list">
                            ${(order.items || []).map(item => `
                                <li class="order-item">
                                    <img src="${item.image || 'https://placehold.co/50x50/cccccc/333333?text=No+Image'}" alt="${item.name}" class="order-item-image">
                                    <div class="order-item-details">
                                        <span class="order-item-name">${item.name}</span>
                                        <span class="order-item-variants-display">${getVariantDisplayString(item.custom)}</span>
                                        <span class="order-item-quantity-price">${item.quantity} x ${formatRupiah(item.price)}</span>
                                    </div>
                                    <span class="order-item-total">${formatRupiah(item.price * item.quantity)}</span>
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                    <div class="order-summary-footer">
                        <span>Total Pembayaran:</span>
                        <span class="order-total-amount">${formatRupiah(order.totalAmount)}</span>
                    </div>
                    <div class="order-card-actions">
                        ${actionButtonsHtml}
                    </div>
                `;
                orderHistoryContent.appendChild(orderCard);
            });

            // Re-attach event listeners for dynamically added buttons and cards
            attachOrderButtonListeners();
        }

        // Function to attach event listeners to dynamically created elements
        function attachOrderButtonListeners() {
            // Remove existing listeners to prevent duplicates
            document.querySelectorAll('.order-card-actions .action-btn').forEach(button => {
                button.removeEventListener('click', handleOrderActionButtonClick);
            });
            document.querySelectorAll('.order-card').forEach(card => {
                card.removeEventListener('click', handleOrderCardClick);
            });

            // Add new listeners
            document.querySelectorAll('.order-card-actions .action-btn').forEach(button => {
                button.addEventListener('click', handleOrderActionButtonClick);
            });
            document.querySelectorAll('.order-card').forEach(card => {
                card.addEventListener('click', handleOrderCardClick);
            });
        }

        // Handle click on the order card to open detail popup
        function handleOrderCardClick(event) {
            // Prevent opening detail if an action button inside the card was clicked
            if (event.target.closest('.action-btn')) {
                return;
            }
            const orderId = this.dataset.orderId;
            tampilkanDetail(orderId);
        }

        // Handle click on action buttons within order cards
        async function handleOrderActionButtonClick(event) {
            event.stopPropagation(); // Prevent the parent order-card click event from firing
            const orderId = event.currentTarget.dataset.orderId;
            const action = event.currentTarget.dataset.action;

            let newStatus = action; // The data-action directly provides the new status

            const confirmChange = await showCustomConfirm(`Ubah status pesanan ${orderId} menjadi "${getDisplayStatus(newStatus)}"?`);
            if (confirmChange) {
                // For direct action buttons, no driver details are passed
                await updateOrderStatusInFirestore(orderId, newStatus, {});
            }
        }

        async function updateOrderStatusInFirestore(orderId, newStatus, driverDetails = {}) {
            showLoading();
            const docRef = db.collection("pesanan").doc(orderId);
            const user = auth.currentUser;
            const userName = user?.email || "Admin Anonim";
            const uid = user?.uid || "Anonim";

            const updateData = {
                status: newStatus,
                diubahOlehNama: userName,
                diubahOlehUid: uid,
                waktuDiubah: firebase.firestore.FieldValue.serverTimestamp()
            };

            // Add driver details if provided and status is OnDelivery
            if (newStatus === 'OnDelivery') {
                updateData.driverName = driverDetails.driverName || null;
                updateData.driverPhone = driverDetails.driverPhone || null;
                updateData.driverApp = driverDetails.driverApp || null;
            } else {
                // If changing from OnDelivery to another status, remove driver info
                updateData.driverName = firebase.firestore.FieldValue.delete();
                updateData.driverPhone = firebase.firestore.FieldValue.delete();
                updateData.driverApp = firebase.firestore.FieldValue.delete();
            }

            try {
                await docRef.update(updateData);

                // Also update status in riwayat_customer if userId exists in the order document
                const orderDoc = await docRef.get();
                const orderData = orderDoc.data();
                const customerUserId = orderData.userId;

                if (customerUserId) {
                    const customerUpdateData = { status: newStatus };
                    if (newStatus === 'OnDelivery') {
                        customerUpdateData.driverName = driverDetails.driverName || null;
                        customerUpdateData.driverPhone = driverDetails.driverPhone || null;
                        customerUpdateData.driverApp = driverDetails.driverApp || null;
                    } else {
                        customerUpdateData.driverName = firebase.firestore.FieldValue.delete();
                        customerUpdateData.driverPhone = firebase.firestore.FieldValue.delete();
                        customerUpdateData.driverApp = firebase.firestore.FieldValue.delete();
                    }
                    await db.doc(`riwayat_customer/${customerUserId}/pesanan/${orderId}`).set(customerUpdateData, { merge: true });
                } else {
                    console.warn(`Customer User ID not found for order ${orderId}, skipping riwayat_customer update.`);
                }

                await showCustomAlert(`Status pesanan ${orderId} berhasil diperbarui menjadi "${getDisplayStatus(newStatus)}".`);
                // No need to call loadAllOrders() explicitly here, onSnapshot will handle it.
                // If popup is open, it will be closed by tutupDetail()
            } catch (error) {
                console.error("Error updating order status:", error);
                await showCustomAlert("Gagal memperbarui status pesanan: " + error.message);
            } finally {
                hideLoading();
            }
        }

        // --- Load All Order History (with real-time updates and filters) ---
        function loadAllOrders() {
            showLoading();
            // Unsubscribe from previous listener if exists
            if (unsubscribeOrders) {
                unsubscribeOrders();
            }

            // Set up real-time listener
            unsubscribeOrders = db.collection('pesanan').orderBy('waktu', 'desc')
                .onSnapshot(snapshot => {
                    allOrdersData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    applyFiltersAndSearch(); // Apply filters and render whenever data changes
                    hideLoading();
                }, error => {
                    console.error('Gagal memuat semua pesanan secara real-time:', error);
                    orderHistoryContent.innerHTML = '<p style="color: red; text-align: center;">Gagal memuat data secara real-time.</p>';
                    hideLoading();
                });
        }

        // --- Apply Filters and Search to Cached Data ---
        function applyFiltersAndSearch() {
            let docsToRender = [...allOrdersData]; // Start with all fetched data

            const searchTxt = searchQueryInput.value.trim().toUpperCase();
            const filterDateVal = filterDateInput.value;

            // Apply search filter (client-side)
            if (searchTxt) {
                docsToRender = docsToRender.filter(order => {
                    return (order.customer?.fullName || '').toUpperCase().includes(searchTxt) ||
                           (order.displayOrderId || '').toUpperCase().includes(searchTxt);
                });
            }

            // Apply date filter (client-side)
            if (filterDateVal) {
                const selectedDate = new Date(filterDateVal);
                const startOfDay = new Date(selectedDate.setHours(0, 0, 0, 0)).getTime();
                const endOfDay = new Date(selectedDate.setHours(23, 59, 59, 999)).getTime();
                docsToRender = docsToRender.filter(order => {
                    const waktuTimestamp = order.waktu?.toDate()?.getTime();
                    return waktuTimestamp >= startOfDay && waktuTimestamp <= endOfDay;
                });
            }

            // Apply status filter (client-side)
            if (activeFilterStatus !== 'All') { // 'All' is no longer a button, but keep logic for safety
                docsToRender = docsToRender.filter(order => order.status === activeFilterStatus);
            }

            renderOrders(docsToRender); // Render the filtered list
        }

        // --- Show Order Detail Popup ---
        async function tampilkanDetail(docId) {
            currentOrderIdForDetail = docId;
            const docRef = db.collection("pesanan").doc(docId);
            const user = auth.currentUser;
            const uid = user?.uid || "Unknown";
            const nama = user?.email || "Tanpa Nama";

            try {
                await db.runTransaction(async (transaction) => {
                    const snapshot = await transaction.get(docRef);
                    if (!snapshot.exists) throw new Error("Pesanan tidak ditemukan.");
                    const d = snapshot.data();
                    if (!d.dibukaOlehUid) {
                        transaction.update(docRef, {
                            dibukaOlehUid: uid,
                            dibukaOlehNama: nama,
                            waktuDibuka: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                });

                const doc = await docRef.get();
                if (!doc.exists) {
                    await showCustomAlert('Pesanan tidak ditemukan.');
                    return;
                }

                const data = doc.data();
                const orderId = data.displayOrderId || '#' + doc.id.slice(0, 6).toUpperCase();
                const customer = data.customer || {};
                const waktu = data.waktu?.toDate?.() || new Date(0);
                const items = data.items || [];

                popupNama.textContent = customer.fullName || "Pelanggan";
                popupOrderId.textContent = orderId;
                const phoneNumber = customer.phoneNumber || "-";
                let formattedPhoneNumber = phoneNumber.replace(/\D/g, '');
                if (formattedPhoneNumber.startsWith('08')) {
                    formattedPhoneNumber = '62' + formattedPhoneNumber.substring(1);
                } else if (!formattedPhoneNumber.startsWith('62') && formattedPhoneNumber.length > 5) {
                    formattedPhoneNumber = '62' + formattedPhoneNumber;
                }

                if (phoneNumber !== "-") {
                    popupNomor.innerHTML = `
                        <div class="phone-link-group">
                            <span>${phoneNumber}</span>
                            <a href="tel:${formattedPhoneNumber}" class="icon-link" title="Telepon">
                                <i class="fas fa-phone"></i>
                            </a>
                            <a href="https://wa.me/${formattedPhoneNumber}" target="_blank" class="icon-link" title="WhatsApp">
                                <i class="fab fa-whatsapp"></i>
                            </a>
                        </div>
                    `;
                } else {
                    popupNomor.textContent = phoneNumber;
                }

                popupAlamat.textContent = customer.address || "-";
                popupTotal.textContent = formatRupiah(data.totalAmount || 0);
                popupMetodeBayar.textContent = data.paymentMethod || "-";
                popupCatatan.textContent = customer.notes || "Tidak ada catatan";

                const currentStatus = data.status || "Pending";
                popupStatus.textContent = getDisplayStatus(currentStatus);
                popupStatus.className = `order-status ${getStatusClass(currentStatus)}`;

                statusUpdater.value = currentStatus;

                // NEW: Populate driver info fields and show/hide section
                if (currentStatus === 'OnDelivery') {
                    driverInfoSection.style.display = 'block';
                    driverNameInput.value = data.driverName || '';
                    driverPhoneInput.value = data.driverPhone || '';
                    driverAppSelect.value = data.driverApp || '';
                } else {
                    driverInfoSection.style.display = 'none';
                    driverNameInput.value = ''; // Clear fields when not OnDelivery
                    driverPhoneInput.value = '';
                    driverAppSelect.value = '';
                }

                popupWaktu.textContent = formatDate(waktu);

                const dibukaOleh = data.dibukaOlehNama || "-";
                const waktuDibuka = data.waktuDibuka?.toDate?.();
                popupDibukaOleh.textContent = dibukaOleh;
                popupWaktuDibuka.textContent = waktuDibuka ? formatDate(waktuDibuka) : "-";

                const diubahOleh = data.diubahOlehNama || "-";
                const waktuDiubah = data.waktuDiubah?.toDate?.();
                popupDiubahOleh.textContent = diubahOleh;
                popupWaktuDiubah.textContent = waktuDiubah ? formatDate(waktuDiubah) : "-";

                popupItems.innerHTML = (items || []).map(item => {
                    const variantDisplay = getVariantDisplayString(item.custom);
                    return `
                        <div style="margin-bottom:5px;">
                            <img src="${item.image || 'https://placehold.co/50x50/cccccc/333333?text=No+Image'}" alt="${item.name}" style="width:50px; height:50px; object-fit:cover; border-radius:5px; vertical-align:middle; margin-right:10px;">
                            ${item.name || 'Produk Tidak Dikenal'} (${item.quantity || 0}x) = ${formatRupiah((item.price || 0) * (item.quantity || 0))}
                            <br><small style="color:#777; margin-left:60px;">Varian: ${variantDisplay}</small>
                        </div>
                    `;
                }).join('') || '<p class="text-gray-500">Tidak ada produk.</p>';

                popupDetail.style.display = "flex";

            } catch (err) {
                await showCustomAlert('Gagal menampilkan detail pesanan: ' + err.message);
                console.error("Error showing order detail:", err);
            }
        }

        // --- Close Order Detail Popup ---
        function tutupDetail() {
            popupDetail.style.display = "none";
            currentOrderIdForDetail = null;
            // No need to call loadAllOrders() explicitly here, onSnapshot will handle it.
        }

        // --- Event Listener for Status Updater Dropdown in Popup ---
        statusUpdater.addEventListener("change", async function () {
            const newStatus = this.value;
            const confirmChange = await showCustomConfirm(`Ubah status pesanan ini menjadi "${getDisplayStatus(newStatus)}"?`);
            if (currentOrderIdForDetail && confirmChange) {
                const driverDetails = {};
                if (newStatus === 'OnDelivery') {
                    driverDetails.driverName = driverNameInput.value;
                    driverDetails.driverPhone = driverPhoneInput.value;
                    driverDetails.driverApp = driverAppSelect.value;
                }
                await updateOrderStatusInFirestore(currentOrderIdForDetail, newStatus, driverDetails);
                tutupDetail();
            }
        });

        // NEW: Event listener for statusUpdater to show/hide driver info section
        statusUpdater.addEventListener('change', function() {
            if (this.value === 'OnDelivery') {
                driverInfoSection.style.display = 'block';
            } else {
                driverInfoSection.style.display = 'none';
            }
        });

        // NEW: Event Listener for Save Driver Details Button
        if (saveDriverDetailsBtn) { // Pastikan tombol ada di DOM
            saveDriverDetailsBtn.addEventListener('click', async () => {
                if (!currentOrderIdForDetail) {
                    await showCustomAlert("Tidak ada pesanan yang dipilih.");
                    return;
                }

                // Ambil status saat ini dari dropdown, karena tombol ini hanya terlihat jika status adalah OnDelivery
                const currentStatus = statusUpdater.value;

                if (currentStatus !== 'OnDelivery') {
                    await showCustomAlert("Detail driver hanya dapat disimpan untuk pesanan 'On Delivery'.");
                    return;
                }

                const driverDetails = {
                    driverName: driverNameInput.value,
                    driverPhone: driverPhoneInput.value,
                    driverApp: driverAppSelect.value
                };

                const confirmSave = await showCustomConfirm("Simpan detail driver?");
                if (confirmSave) {
                    // Teruskan status saat ini dan detail driver ke fungsi pembaruan
                    await updateOrderStatusInFirestore(currentOrderIdForDetail, currentStatus, driverDetails);
                    // Tidak perlu menutup popup di sini, onSnapshot akan memperbarui konten secara real-time.
                }
            });
        }


        // --- Event Listeners for Filters and Search ---
        searchQueryInput.addEventListener('input', applyFiltersAndSearch);
        filterDateInput.addEventListener('change', applyFiltersAndSearch);

        filterButtons.forEach(button => {
            button.addEventListener('click', () => {
                activeFilterStatus = button.dataset.status;
                applyFiltersAndSearch(); // Apply filters to current data
                filterButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
            });
        });

        resetFiltersBtn.addEventListener('click', () => {
            searchQueryInput.value = '';
            filterDateInput.value = '';
            activeFilterStatus = 'Pending'; // Reset to 'Pending' as default
            filterButtons.forEach(btn => btn.classList.remove('active'));
            // Set 'Baru' (Pending) button as active
            document.querySelector('.filter-btn[data-status="Pending"]').classList.add('active');
            applyFiltersAndSearch(); // Apply reset filters
        });

        // --- Authentication and Initial Load ---
        auth.onAuthStateChanged(async user => {
            const storedRole = localStorage.getItem('userRole');
            const isLoggingOut = localStorage.getItem('isLoggingOut');
            if (isLoggingOut) localStorage.removeItem('isLoggingOut');

            if (!user || storedRole !== 'penjual') {
                if (!isLoggingOut) await showCustomAlert('Akses ditolak. Halaman ini hanya untuk PENJUAL.');
                window.location.href = 'index.html'; // Redirect to login
            } else {
                // Set default active filter button on initial load
                document.querySelector('.filter-btn[data-status="Pending"]').classList.add('active');
                loadAllOrders(); // Start real-time listener on successful authentication
            }
        });

        // --- Admin Actions ---
        window.hapusSemuaPesananPenjual = async function () {
            const konfirmasi = await showCustomConfirm("❗Yakin ingin menghapus SEMUA pesanan dari database penjual?");
            if (!konfirmasi) return;

            // Tampilkan modal verifikasi password
            const modal = document.getElementById('modalVerifikasi');
            if (modal) {
                modal.style.display = 'flex';
            } else {
                await showCustomAlert("❌ Modal verifikasi tidak ditemukan di halaman.");
            }
        };

        // Fungsi dipanggil saat tombol 'Hapus' di modal ditekan
        window.verifikasiPasswordDanHapus = async function () {
            const user = firebase.auth().currentUser;
            if (!user) {
                await showCustomAlert("⚠️ Anda belum login.");
                return;
            }

            const passwordInput = document.getElementById('inputPassword');
            if (!passwordInput || !passwordInput.value) {
                await showCustomAlert("⚠️ Masukkan password terlebih dahulu.");
                return;
            }

            const password = passwordInput.value;
            const credential = firebase.auth.EmailAuthProvider.credential(user.email, password);

            try {
                showLoading();
                await user.reauthenticateWithCredential(credential);

                const snapshot = await db.collection("pesanan").get();
                const batch = db.batch();

                snapshot.forEach(doc => {
                    batch.delete(doc.ref);
                });

                await batch.commit();

                await showCustomAlert("✅ Semua pesanan berhasil dihapus.");
                tutupModalVerifikasi();
                // loadAllOrders() will automatically update the list
            } catch (error) {
                console.error("❌ Gagal re-auth:", error);
                await showCustomAlert("❌ Password salah atau gagal autentikasi.");
            } finally {
                hideLoading();
            }
        };

        // Tutup modal jika klik "Batal"
        window.tutupModalVerifikasi = function () {
            const modal = document.getElementById('modalVerifikasi');
            if (modal) modal.style.display = 'none';
        };
    </script>
</body>
</html>
