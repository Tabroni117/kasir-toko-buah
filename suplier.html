<!DOCTYPE html>
<html lang="id">
firebasejsfirebasejs
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manajemen Stok Produk</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">

    <!-- Firebase SDK v9 Compatibility -->
    <script src="https://www.gstatic.com/firefirebasejsbasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        /* General Styling */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }

        body {
            background-color: #f9f9f9;
            color: #333;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            align-items: center;
            padding: 10px; /* Add padding around the container */
        }

        .container {
            max-width: 480px; /* Max width for larger screens */
            width: 100%; /* Full width on smaller screens */
            margin: 0 auto;
            background: white;
            min-height: calc(100vh - 20px); /* Adjust for body padding */
            padding-bottom: 20px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
        }

        /* Header */
        .header-detail {
            background: linear-gradient(135deg, #00C853, #64DD17);
            color: white;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
        }
        .back-button {
            font-size: 24px;
            margin-right: 15px;
            cursor: pointer;
        }
        .header-title {
            font-size: 18px;
            font-weight: bold;
        }

        /* Loading Spinner */
        #loadingSpinner {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            font-size: 24px;
            color: #00C853;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #00C853;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Form & Buttons */
        .form-section {
            padding: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            font-size: 13px;
            color: #555;
            margin-bottom: 5px;
            font-weight: 500;
        }

        input[type="text"],
        input[type="number"] {
            width: 100%; /* Changed from 53% */
            padding: 10px;
            margin: 5px 0;
            font-size: 16px;
            border-radius: 6px;
            border: 1px solid #ccc;
            box-sizing: border-box; /* Include padding and border in element's total width and height */
        }

        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px; /* Space between buttons */
            margin-top: 15px;
        }

        .button-group button {
            flex-grow: 1; /* Allow buttons to grow and fill space */
            padding: 10px 15px; /* Adjusted padding */
            border: none;
            border-radius: 6px;
            color: white;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.2s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        #whatsapp { background-color: #25d366; }
        #whatsapp:hover { background-color: #1DA851; transform: translateY(-1px); }
        #print, #clear { background-color: #6c757d; }
        #print:hover, #clear:hover { background-color: #5a6268; transform: translateY(-1px); }
        #Lihat, #Tambah { background-color: #007bff; }
        #Lihat:hover, #Tambah:hover { background-color: #0056b3; transform: translateY(-1px); }
        
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            box-shadow: none;
        }

        /* Table Styling */
        table {
            width: calc(100% - 40px); /* Adjusted for padding */
            margin: 20px auto 0; /* Centered with auto margins */
            border-collapse: collapse;
            font-size: 14px;
        }

        th, td {
            border: 1px solid #aaa;
            padding: 10px;
            text-align: center;
        }

        th {
            background-color: #f0f0f0;
            font-weight: bold;
            color: #555;
        }
        
        td button {
            padding: 5px 8px;
            font-size: 12px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        td button:hover {
            opacity: 0.8;
        }
        td button.edit-btn { background-color: #ffc107; color: #333; } /* Amber */
        td button.delete-btn { background-color: #dc3545; color: white; } /* Red */

        /* Autocomplete */
        .autocomplete {
            position: relative;
        }
        .autocomplete-items {
            position: absolute;
            border: 1px solid #d4d4d4;
            background-color: #fff;
            z-index: 99;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 150px; /* Limit height */
            overflow-y: auto; /* Scroll if too many items */
            border-radius: 6px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .autocomplete-item {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            font-size: 14px;
            color: #333;
        }
        .autocomplete-item:last-child {
            border-bottom: none;
        }
        .autocomplete-item:hover, .autocomplete-active {
            background-color: #e9e9e9;
        }

        /* Buah Belum Ditambahkan Section */
        .buah-container {
            margin-top: 20px;
            padding: 0 20px; /* Match form padding */
        }
        .buah-container h3 {
            font-size: 16px;
            color: #00C853;
            margin-bottom: 10px;
            border-bottom: 1px dashed #eee;
            padding-bottom: 5px;
        }
        .buah-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px; /* Reduced gap for better fit */
        }
        .buah-item {
            padding: 6px 12px; /* Adjusted padding */
            background-color: #dff0d8; /* Light green */
            border: 1px solid #a5d6a7;
            border-radius: 20px; /* More rounded */
            font-weight: 500; /* Slightly less bold */
            color: #2e7d32;
            cursor: pointer;
            font-size: 13px; /* Smaller font */
            transition: background-color 0.2s, transform 0.2s;
        }
        .buah-item:hover {
            background-color: #c8e6c9;
            transform: translateY(-1px);
        }
        .buah-container .empty-message {
            text-align: center;
            padding: 20px;
            color: #777;
            font-style: italic;
        }

        /* Custom Alert/Confirm Modals */
        #customAlertDialog, #customConfirmModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 9997;
            justify-content: center;
            align-items: center;
        }
        #customAlertDialog > div, #customConfirmModal > div {
            background-color: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            text-align: center;
            max-width: 300px;
        }
        #customAlertDialog p, #customConfirmModal p {
            margin-bottom: 20px;
            font-size: 16px;
            color: #333;
        }
        #customAlertDialog button, #customConfirmModal button {
            background-color: #00C853;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s;
        }
        #customAlertDialog button:hover {
            background-color: #388E3C;
        }
        #customConfirmModal button#customConfirmYes {
            background-color: #00C853;
        }
        #customConfirmModal button#customConfirmYes:hover {
            background-color: #388E3C;
        }
        #customConfirmModal button#customConfirmNo {
            background-color: #f44336;
            margin-left: 10px;
        }
        #customConfirmModal button#customConfirmNo:hover {
            background-color: #d32f2f;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header-detail">
            <i class="fas fa-arrow-left back-button" onclick="history.back()"></i>
            <div class="header-title">Manajemen Stok Produk</div>
        </header>

        <div id="loadingSpinner">
            <div class="spinner"></div>
        </div>

        <div class="form-section">
            <div class="form-group">
                <label for="nama">Nama Produk:</label>
                <div class="autocomplete">
                    <input type="text" id="nama" placeholder="Nama Produk" autocomplete="off" />
                </div>
            </div>
            <div class="form-group">
                <label for="jumlah">Jumlah Produk:</label>
                <div class="autocomplete">
                    <input type="text" id="jumlah" placeholder="Jumlah Produk (contoh: 1 KG, 5 PCs)" autocomplete="off" />
                </div>
            </div>
            <div class="button-group">
                <button id="Tambah" onclick="tambahProduk()">Tambah Produk</button>
                <button id="clear" onclick="hapusSemua()">Hapus Semua</button>
                <button id="whatsapp" onclick="kirimWhatsApp()">Kirim WhatsApp</button>
            </div>
        </div>

        <table>
            <thead>
                <tr>
                    <th>No</th>
                    <th>Produk</th>
                    <th>Jumlah</th>
                    <th>Edit</th>
                    <th>Hapus</th>
                </tr>
            </thead>
            <tbody id="produkTableBody">
                <!-- Data produk akan dimuat di sini -->
            </tbody>
        </table>

        <div id="bahanBelumDitambahkan" class="buah-container">
            <h3>🍎 Bahan Baku Belum Ditambahkan:</h3>
            <div class="buah-list">
                <!-- Bahan baku yang belum ditambahkan akan dimuat di sini -->
            </div>
            <p id="emptyBahanMessage" class="empty-message" style="display: none;">🎉 Semua bahan baku sudah ditambahkan!</p>
        </div>
    </div>

    <!-- Custom Alert Modal -->
    <div id="customAlertDialog">
        <div>
            <p id="customAlertMessage"></p>
            <button id="customAlertOk">OK</button>
        </div>
    </div>

    <!-- Custom Confirmation Modal -->
    <div id="customConfirmModal">
        <div>
            <p id="customConfirmMessage"></p>
            <button id="customConfirmYes">Ya</button>
            <button id="customConfirmNo">Tidak</button>
        </div>
    </div>

    <script>
        // --- Firebase Configuration ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyCeqHW_m9kru2vmEDVSoelZ3UWFD4k4Xqc",
            authDomain: "tokobuahkasir.firebaseapp.com",
            projectId: "tokobuahkasir",
            storageBucket: "tokobuahkasir.firebasestorage.app",
            messagingSenderId: "731011133713",
            appId: "1:731011133713:web:4247ae627401a01b8c1cb0",
            measurementId: "G-7CPE2DB2BV"
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Firestore Collections
        const bahanCollection = db.collection('bahan'); // Untuk autocomplete produk
        const stokBarangCollection = db.collection('stok_barang'); // Untuk menyimpan data stok

        // DOM Elements
        const loadingSpinner = document.getElementById('loadingSpinner');
        const namaInput = document.getElementById('nama');
        const jumlahInput = document.getElementById('jumlah');
        const tambahBtn = document.getElementById('Tambah');
        const clearBtn = document.getElementById('clear');
        const whatsappBtn = document.getElementById('whatsapp');
        const produkTableBody = document.getElementById('produkTableBody');
        const bahanBelumDitambahkanDiv = document.getElementById('bahanBelumDitambahkan');
        const bahanListDiv = bahanBelumDitambahkanDiv.querySelector('.buah-list');
        const emptyBahanMessage = document.getElementById('emptyBahanMessage');

        const customAlertDialog = document.getElementById('customAlertDialog');
        const customAlertMessage = document.getElementById('customAlertMessage');
        const customAlertOk = document.getElementById('customAlertOk');

        const customConfirmModal = document.getElementById('customConfirmModal');
        const customConfirmMessage = document.getElementById('customConfirmMessage');
        const customConfirmYes = document.getElementById('customConfirmYes');
        const customConfirmNo = document.getElementById('customConfirmNo');

        let currentUserId = null;
        let produkOtomatis = []; // Akan diisi dari koleksi 'bahan'
        const satuanOtomatis = ["KG", "PCs", "Liter", "Gram", "Unit", "Buah", "Bungkus", "Botol"]; // Satuan umum
        let stokProdukList = []; // Data stok yang dimuat dari Firestore
        let editDocId = null; // Untuk menyimpan ID dokumen yang sedang diedit

        // --- Helper Functions ---
        function showLoading() { loadingSpinner.style.display = 'flex'; }
        function hideLoading() { loadingSpinner.style.display = 'none'; }

        function showCustomAlert(message) {
            return new Promise((resolve) => {
                customAlertMessage.textContent = message;
                customAlertDialog.style.display = 'flex';
                const handleOk = () => {
                    customAlertDialog.style.display = 'none';
                    customAlertOk.removeEventListener('click', handleOk);
                    resolve();
                };
                customAlertOk.addEventListener('click', handleOk);
            });
        }

        function showCustomConfirm(message) {
            return new Promise((resolve) => {
                customConfirmMessage.textContent = message;
                customConfirmModal.style.display = 'flex';
                const handleYes = () => {
                    customConfirmModal.style.display = 'none';
                    customConfirmYes.removeEventListener('click', handleYes);
                    customConfirmNo.removeEventListener('click', handleNo);
                    resolve(true);
                };
                const handleNo = () => {
                    customConfirmModal.style.display = 'none';
                    customConfirmYes.removeEventListener('click', handleYes);
                    customConfirmNo.removeEventListener('click', handleNo);
                    resolve(false);
                };
                customConfirmYes.addEventListener('click', handleYes);
                customConfirmNo.addEventListener('click', handleNo);
            });
        }

        // --- Autocomplete Logic ---
        let currentFocusNama = -1, currentFocusJumlah = -1;

        function autocomplete(inp, arr, isJumlah = false) {
            inp.addEventListener("input", function () {
                let val = this.value;
                closeAllLists();
                if (!val) return false;

                const listDiv = document.createElement("DIV");
                listDiv.setAttribute("id", this.id + "autocomplete-list");
                listDiv.setAttribute("class", "autocomplete-items");
                this.parentNode.appendChild(listDiv);

                const filteredArr = arr.filter(item => item.toUpperCase().includes(val.toUpperCase()));

                filteredArr.forEach(item => {
                    const itemDiv = document.createElement("DIV");
                    itemDiv.innerHTML = item;
                    itemDiv.classList.add("autocomplete-item");
                    itemDiv.addEventListener("click", function () {
                        inp.value = isJumlah ? (inp.value.replace(/ *\b(KG|PCs|Liter|Gram|Unit|Buah|Bungkus|Botol)\b/i, '') + " " + item).trim() : item;
                        closeAllLists();
                    });
                    listDiv.appendChild(itemDiv);
                });
            });

            inp.addEventListener("keydown", function (e) {
                let list = document.getElementById(this.id + "autocomplete-list");
                if (list) list = list.getElementsByTagName("div");
                let currentFocus = isJumlah ? currentFocusJumlah : currentFocusNama;

                if (e.keyCode == 40) { // DOWN arrow
                    currentFocus++;
                    addActive(list, currentFocus);
                } else if (e.keyCode == 38) { // UP arrow
                    currentFocus--;
                    addActive(list, currentFocus);
                } else if (e.keyCode == 13) { // ENTER key
                    e.preventDefault();
                    if (currentFocus > -1 && list && list[currentFocus]) {
                        list[currentFocus].click();
                    } else if (this.value.trim() !== '') { // If no item selected, but input has value, proceed
                        if (isJumlah) {
                            tambahProduk();
                        } else {
                            jumlahInput.focus();
                        }
                    }
                }
                if (isJumlah) currentFocusJumlah = currentFocus;
                else currentFocusNama = currentFocus;
            });

            function addActive(x, currentFcs) {
                if (!x) return false;
                removeActive(x);
                if (currentFcs >= x.length) currentFcs = 0;
                if (currentFcs < 0) currentFcs = (x.length - 1);
                x[currentFcs].classList.add("autocomplete-active");
            }

            function removeActive(x) {
                for (let i = 0; i < x.length; i++) {
                    x[i].classList.remove("autocomplete-active");
                }
            }

            function closeAllLists(elmnt) {
                const items = document.getElementsByClassName("autocomplete-items");
                for (let item of items) {
                    if (elmnt != item && elmnt != inp) item.parentNode.removeChild(item);
                }
            }
            document.addEventListener("click", function (e) { closeAllLists(e.target); });
        }

        // --- Load Bahan Baku for Autocomplete ---
        async function loadBahanForAutocomplete() {
            console.log("DEBUG: Memuat bahan baku untuk autocomplete.");
            showLoading();
            try {
                const snapshot = await bahanCollection.where('isAvailable', '==', true).orderBy('nama').get();
                produkOtomatis = [];
                if (!snapshot.empty) {
                    snapshot.forEach(doc => {
                        const bahan = doc.data();
                        if (bahan.nama) {
                            produkOtomatis.push(bahan.nama);
                        }
                    });
                    console.log("DEBUG: Bahan baku dimuat:", produkOtomatis);
                } else {
                    console.log("DEBUG: Koleksi 'bahan' kosong atau tidak ada yang tersedia.");
                }
                autocomplete(namaInput, produkOtomatis);
                autocomplete(jumlahInput, satuanOtomatis, true);
            } catch (error) {
                console.error("DEBUG: Error memuat bahan baku untuk autocomplete:", error);
                showCustomAlert("Gagal memuat daftar bahan baku untuk autocomplete.");
            } finally {
                hideLoading();
            }
        }

        // --- Stok Barang Management (CRUD with Firebase) ---

        // Real-time listener for stok_barang
        function listenToStokBarang() {
            if (!currentUserId) {
                console.warn("DEBUG: User ID tidak tersedia, tidak dapat mendengarkan stok barang.");
                return;
            }

            // Aturan Firestore: /artifacts/{appId}/users/{userId}/stok_barang
            const userStokCollectionRef = stokBarangCollection; // Assuming stokBarangCollection is already scoped to user in rules

            stokBarangCollection.where('createdBy', '==', currentUserId)
                .orderBy('createdAt', 'desc')
                .onSnapshot(snapshot => {
                    stokProdukList = [];
                    snapshot.forEach(doc => {
                        stokProdukList.push({ id: doc.id, ...doc.data() });
                    });
                    renderTabel();
                    tampilkanSisaBahan();
                }, error => {
                    console.error("DEBUG: Error mendengarkan stok barang:", error);
                    showCustomAlert("Gagal memuat daftar stok secara real-time.");
                });
        }

        async function tambahProduk() {
            console.log("DEBUG: Fungsi tambahProduk dipanggil.");
            const nama = namaInput.value.trim();
            const jumlah = jumlahInput.value.trim();

            if (!nama || !jumlah) {
                await showCustomAlert("⚠️ Harap isi semua kolom.");
                return;
            }

            showLoading();
            try {
                const data = {
                    nama: nama,
                    jumlah: jumlah,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    createdBy: currentUserId,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedBy: currentUserId
                };

                if (editDocId) {
                    await stokBarangCollection.doc(editDocId).update(data);
                    await showCustomAlert("✅ Produk berhasil diperbarui!");
                    editDocId = null;
                    tambahBtn.textContent = "Tambah Produk";
                } else {
                    await stokBarangCollection.add(data);
                    await showCustomAlert("✅ Produk berhasil ditambahkan!");
                }

                namaInput.value = "";
                jumlahInput.value = "";
            } catch (error) {
                console.error("DEBUG: Error menambah/memperbarui produk:", error);
                await showCustomAlert("❌ Gagal menyimpan produk: " + error.message);
            } finally {
                hideLoading();
            }
        }

        async function editProduk(docId) {
            console.log("DEBUG: Fungsi editProduk dipanggil untuk ID:", docId);
            showLoading();
            try {
                const doc = await stokBarangCollection.doc(docId).get();
                if (doc.exists) {
                    const data = doc.data();
                    namaInput.value = data.nama;
                    jumlahInput.value = data.jumlah;
                    editDocId = docId;
                    tambahBtn.textContent = "Update Produk";
                    console.log("DEBUG: Data produk untuk diedit dimuat:", data);
                } else {
                    await showCustomAlert("Produk tidak ditemukan.");
                }
            } catch (error) {
                console.error("DEBUG: Error memuat produk untuk diedit:", error);
                await showCustomAlert("Gagal memuat data produk untuk diedit.");
            } finally {
                hideLoading();
            }
        }

        async function hapusProduk(docId, namaProduk) {
            console.log("DEBUG: Fungsi hapusProduk dipanggil untuk ID:", docId);
            const confirmDelete = await showCustomConfirm(`Yakin ingin menghapus produk "${namaProduk}"?`);
            if (!confirmDelete) return;

            showLoading();
            try {
                await stokBarangCollection.doc(docId).delete();
                await showCustomAlert("🗑️ Produk berhasil dihapus!");
            } catch (error) {
                console.error("DEBUG: Error menghapus produk:", error);
                await showCustomAlert("❌ Gagal menghapus produk: " + error.message);
            } finally {
                hideLoading();
            }
        }

        async function hapusSemua() {
            console.log("DEBUG: Fungsi hapusSemua dipanggil.");
            const confirmClear = await showCustomConfirm("Yakin ingin menghapus semua data stok? Tindakan ini tidak dapat dibatalkan.");
            if (!confirmClear) return;

            showLoading();
            try {
                const snapshot = await stokBarangCollection.where('createdBy', '==', currentUserId).get();
                if (snapshot.empty) {
                    await showCustomAlert("Tidak ada data untuk dihapus.");
                    hideLoading();
                    return;
                }

                const batch = db.batch();
                snapshot.forEach(doc => {
                    batch.delete(doc.ref);
                });
                await batch.commit();
                await showCustomAlert("🗑️ Semua data stok berhasil dihapus!");
                stokProdukList = []; // Clear local list immediately
                renderTabel(); // Re-render table
            } catch (error) {
                console.error("DEBUG: Error menghapus semua data:", error);
                await showCustomAlert("❌ Gagal menghapus semua data: " + error.message);
            } finally {
                hideLoading();
            }
        }

        function renderTabel() {
            console.log("DEBUG: Merender tabel stok produk.");
            produkTableBody.innerHTML = "";
            if (stokProdukList.length === 0) {
                produkTableBody.innerHTML = `<tr><td colspan="5">Tidak ada data stok.</td></tr>`;
                return;
            }
            stokProdukList.forEach((p, i) => {
                const row = produkTableBody.insertRow();
                row.innerHTML = `
                    <td>${i + 1}</td>
                    <td>${p.nama}</td>
                    <td>${p.jumlah}</td>
                    <td><button class="edit-btn" onclick="editProduk('${p.id}')">✏️ Edit</button></td>
                    <td><button class="delete-btn" onclick="hapusProduk('${p.id}', '${p.nama}')">🗑️ Hapus</button></td>
                `;
            });
        }

        // --- Bahan Baku Belum Ditambahkan Logic ---
        async function tampilkanSisaBahan() {
            console.log("DEBUG: Menampilkan sisa bahan baku yang belum ditambahkan.");
            bahanListDiv.innerHTML = '';
            emptyBahanMessage.style.display = 'none';

            if (produkOtomatis.length === 0) {
                bahanListDiv.innerHTML = '<p class="empty-message">Tidak ada bahan baku tersedia di Firestore.</p>';
                return;
            }

            const sudahAdaDiStok = stokProdukList.map(p => p.nama.toLowerCase());
            const belumAda = produkOtomatis.filter(bahan => !sudahAdaDiStok.includes(bahan.toLowerCase()));

            if (belumAda.length === 0) {
                emptyBahanMessage.style.display = 'block';
                return;
            }

            belumAda.forEach(bahan => {
                const itemDiv = document.createElement("div");
                itemDiv.classList.add("buah-item");
                itemDiv.textContent = bahan;
                itemDiv.addEventListener('click', () => tambahDariSisa(bahan));
                bahanListDiv.appendChild(itemDiv);
            });
        }

        async function tambahDariSisa(namaBahan) {
            console.log("DEBUG: Menambahkan bahan baku dari daftar sisa:", namaBahan);
            // Default jumlah bisa disesuaikan atau diminta input
            const jumlahDefault = "1 Unit"; 
            namaInput.value = namaBahan;
            jumlahInput.value = jumlahDefault;
            await tambahProduk(); // Langsung tambahkan ke stok
        }

        // --- WhatsApp Integration ---
        async function kirimWhatsApp() {
            console.log("DEBUG: Fungsi kirimWhatsApp dipanggil.");
            if (stokProdukList.length === 0) {
                await showCustomAlert("📭 Data stok masih kosong!");
                return;
            }

            const now = new Date();
            const tanggal = now.toLocaleDateString("id-ID");
            const jam = now.toLocaleTimeString("id-ID");
            let pesan = `📦 *Data Stok Produk Rujak Buah Indonesia*
🕒 ${tanggal} - ${jam}
`;
            stokProdukList.forEach((p, i) => {
                pesan += `${i + 1}. ${p.nama} - ${p.jumlah}
`;
            });
            const url = `https://wa.me/?text=${encodeURIComponent(pesan)}`;
            window.open(url, "_blank");
        }

        // --- Initial Load & Authentication ---
        document.addEventListener('DOMContentLoaded', () => {
            namaInput.addEventListener("keydown", e => { if (e.key === "Enter") jumlahInput.focus(); });
            jumlahInput.addEventListener("keydown", e => { if (e.key === "Enter") tambahProduk(); });

            auth.onAuthStateChanged(async user => {
                console.log("DEBUG: auth.onAuthStateChanged terpicu. User:", user ? user.uid : "null");
                const storedRole = localStorage.getItem('userRole');
                const isLoggingOut = localStorage.getItem('isLoggingOut');
                if (isLoggingOut) localStorage.removeItem('isLoggingOut');

                if (!user || storedRole !== 'penjual') {
                    console.log("DEBUG: Pengguna bukan penjual atau tidak login. Mengarahkan ke index.html.");
                    if (!isLoggingOut) await showCustomAlert('Akses ditolak. Halaman ini hanya untuk PENJUAL.');
                    window.location.replace('./index.html'); 
                } else {
                    currentUserId = user.uid;
                    console.log(`DEBUG: Pengguna terautentikasi sebagai penjual. UID: ${currentUserId}`);
                    loadBahanForAutocomplete(); // Muat bahan baku untuk autocomplete
                    listenToStokBarang(); // Mulai mendengarkan perubahan stok barang
                }
            });
        });
    </script>
</body>
</html>
