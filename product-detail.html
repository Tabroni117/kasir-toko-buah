<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detail Produk</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            margin: 0;
            background-color: #f8f8f8;
            color: #333;
            padding-bottom: 80px; /* Ruang untuk floating add to cart */
        }
        .header {
            background: linear-gradient(135deg, #00C853, #64DD17);
            color: white;
            padding: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .header h1 {
            font-size: 1.2em;
            margin: 0 auto; /* Tengah di antara tombol */
        }
        .back-button {
            color: white;
            font-size: 1.5em;
            cursor: pointer;
            z-index: 1; /* Agar bisa diklik meskipun ada h1 di tengah */
        }
        .product-image-container {
            width: 100%;
            height: 250px; /* Ukuran gambar yang lebih besar */
            background-color: #e0e0e0;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }
        #productImage {
            width: 100%;
            height: 100%;
            object-fit: cover; /* Memastikan gambar mengisi area tanpa terdistorsi */
            display: block;
        }
        .product-details {
            padding: 15px;
            background-color: white;
            border-bottom-left-radius: 10px;
            border-bottom-right-radius: 10px;
            margin-bottom: 10px;
        }
        #productName {
            font-size: 1.6em;
            font-weight: bold;
            margin-bottom: 8px;
            color: #22c55e; /* Warna hijau */
        }
        #productPrice {
            font-size: 1.4em;
            color: #f59e0b; /* Warna oranye */
            font-weight: bold;
            margin-bottom: 15px;
        }
        #productDescription {
            font-size: 1em;
            color: #555;
            line-height: 1.5;
            margin-bottom: 15px;
        }
        .quantity-control {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center; /* Tengah elemen */
        }
        .quantity-button {
            background-color: #22c55e;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 1.5em;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: background-color 0.2s, transform 0.2s;
        }
        .quantity-button:hover {
            background-color: #16a34a;
            transform: scale(1.05);
        }
        #productQuantity {
            font-size: 1.4em;
            font-weight: bold;
            width: 50px;
            text-align: center;
        }
        .add-to-cart-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: #22c55e;
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
            z-index: 100;
            border-top-left-radius: 15px;
            border-top-right-radius: 15px;
        }
        .add-to-cart-bar button {
            background-color: #fde047;
            color: #22c55e;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
        }
        .add-to-cart-bar button:hover {
            background-color: #facc15;
            transform: translateY(-2px);
        }
        .total-price-text {
            font-size: 1.2em;
            font-weight: bold;
        }
        .error-message {
            text-align: center;
            padding: 20px;
            color: #ef4444; /* red */
            font-weight: bold;
            display: none;
        }
    </style>
</head>
<body>
    <div class="header">
        <i class="fas fa-arrow-left back-button" onclick="goBack()"></i>
        <h1>Detail Produk</h1>
        <span></span> </div>

    <div class="product-image-container">
        <img id="productImage" src="https://placehold.co/400x250/cccccc/333333?text=Memuat+Gambar..." alt="Product Image">
    </div>

    <div class="product-details">
        <h2 id="productName">Memuat Nama Produk...</h2>
        <p id="productPrice">Rp 0</p>
        <p id="productDescription">Memuat deskripsi produk...</p>

        <div class="quantity-control">
            <button class="quantity-button" onclick="changeQuantity(-1)">-</button>
            <span id="productQuantity">1</span>
            <button class="quantity-button" onclick="changeQuantity(1)">+</button>
        </div>
    </div>

    <div class="add-to-cart-bar">
        <span class="total-price-text" id="totalProductPrice">Total: Rp 0</span>
        <button id="addToCartButton">Tambah ke Keranjang</button>
    </div>

    <div id="errorMessage" class="error-message"></div>

<script>
    // --- Firebase Configuration ---
    const firebaseConfig = {
        apiKey: "AIzaSyCeqHW_m9kru2vmEDVSoelZ3UWFD4k4Xqc",
        authDomain: "tokobuahkasir.firebaseapp.com",
        projectId: "tokobuahkasir",
        storageBucket: "tokobuahkasir.firebasestorage.app",
        messagingSenderId: "731011133713",
        appId: "1:731011133713:web:4247ae627401a01b8c1cb0",
        measurementId: "G-7CPE2DB2BV"
    };

    // Initialize Firebase
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.firestore();
    // Pastikan ini mengarah ke koleksi 'buah'
    const productsCollection = db.collection('buah'); 
    const cartsCollection = db.collection('carts'); // Koleksi keranjang

    // --- Elemen DOM ---
    const productImageElement = document.getElementById('productImage');
    const productNameElement = document.getElementById('productName');
    const productPriceElement = document.getElementById('productPrice');
    const productDescriptionElement = document.getElementById('productDescription');
    const productQuantityElement = document.getElementById('productQuantity');
    const totalProductPriceElement = document.getElementById('totalProductPrice');
    const addToCartButton = document.getElementById('addToCartButton');
    const errorMessageElement = document.getElementById('errorMessage');

    let selectedProduct = null;
    let currentQuantity = 1;
    let currentUserId = null; // Akan diisi saat menerima auth data

    // --- Fungsi Format Rupiah ---
    function formatRupiah(amount) {
        return new Intl.NumberFormat('id-ID', {
            style: 'currency',
            currency: 'IDR',
            minimumFractionDigits: 0
        }).format(amount);
    }

    // --- Fungsi untuk memperbarui tampilan harga total ---
    function updateTotalPrice() {
        if (selectedProduct) {
            const totalPrice = selectedProduct.price * currentQuantity;
            totalProductPriceElement.textContent = `Total: ${formatRupiah(totalPrice)}`;
        } else {
            totalProductPriceElement.textContent = `Total: ${formatRupiah(0)}`;
        }
    }

    // --- Fungsi untuk mengubah kuantitas ---
    function changeQuantity(change) {
        currentQuantity += change;
        if (currentQuantity < 1) {
            currentQuantity = 1;
        }
        productQuantityElement.textContent = currentQuantity;
        updateTotalPrice();
    }

    // --- Fungsi untuk memuat detail produk dari Firebase ---
    async function loadProductDetails(productId) {
        console.log("Memuat detail produk untuk ID:", productId);
        errorMessageElement.style.display = 'none'; // Sembunyikan pesan error sebelumnya

        try {
            const productDoc = await productsCollection.doc(productId).get();
            if (productDoc.exists) {
                selectedProduct = { id: productDoc.id, ...productDoc.data() };
                console.log("Data Produk Ditemukan:", selectedProduct);

                productNameElement.textContent = selectedProduct.nama || 'Nama Tidak Tersedia';
                productPriceElement.textContent = formatRupiah(selectedProduct.harga || 0);
                productDescriptionElement.textContent = selectedProduct.deskripsi || 'Tidak ada deskripsi untuk produk ini.';

                // --- BAGIAN PENTING UNTUK GAMBAR ---
                if (selectedProduct.imageUrl) { // PASTIKAN properti di Firestore adalah 'imageUrl'
                    productImageElement.src = selectedProduct.imageUrl;
                    console.log("Gambar dimuat dari URL:", selectedProduct.imageUrl);
                } else {
                    productImageElement.src = 'https://placehold.co/400x250/cccccc/333333?text=Gambar+Tidak+Tersedia';
                    console.warn("URL gambar tidak ditemukan untuk produk ini.");
                }

                currentQuantity = 1; // Reset kuantitas
                productQuantityElement.textContent = currentQuantity;
                updateTotalPrice(); // Perbarui total harga awal
                addToCartButton.disabled = false; // Aktifkan tombol tambah ke keranjang

            } else {
                console.error("Produk dengan ID", productId, "tidak ditemukan.");
                productNameElement.textContent = 'Produk Tidak Ditemukan';
                productPriceElement.textContent = 'Rp 0';
                productDescriptionElement.textContent = 'Maaf, detail produk tidak dapat dimuat.';
                productImageElement.src = 'https://placehold.co/400x250/cccccc/333333?text=Produk+Tidak+Ada';
                addToCartButton.disabled = true;
                errorMessageElement.textContent = 'Produk tidak ditemukan.';
                errorMessageElement.style.display = 'block';
            }
        } catch (error) {
            console.error("❌ Gagal memuat detail produk:", error);
            productNameElement.textContent = 'Error Memuat Produk';
            productPriceElement.textContent = 'Rp 0';
            productDescriptionElement.textContent = 'Terjadi kesalahan saat memuat detail produk. Silakan coba lagi.';
            productImageElement.src = 'https://placehold.co/400x250/cccccc/333333?text=Error';
            addToCartButton.disabled = true;
            errorMessageElement.textContent = 'Terjadi kesalahan saat memuat data.';
            errorMessageElement.style.display = 'block';
        }
    }

    // --- Fungsi untuk menambahkan produk ke keranjang ---
    async function addToCart() {
        if (!selectedProduct || !currentUserId) {
            console.error("Produk belum dipilih atau User ID tidak tersedia.");
            alert("Tidak bisa menambahkan ke keranjang. Data produk/user belum lengkap.");
            return;
        }

        try {
            const cartItemRef = cartsCollection.doc(currentUserId)
                                                .collection('items')
                                                .doc(selectedProduct.id); // Dokumen item keranjang per product ID

            const doc = await cartItemRef.get();

            if (doc.exists) {
                // Item sudah ada, update kuantitas
                const existingQuantity = doc.data().quantity;
                await cartItemRef.update({
                    quantity: existingQuantity + currentQuantity,
                    totalPrice: (existingQuantity + currentQuantity) * selectedProduct.harga
                });
                console.log("Kuantitas produk di keranjang diperbarui!");
            } else {
                // Item belum ada, tambahkan baru
                await cartItemRef.set({
                    productId: selectedProduct.id,
                    name: selectedProduct.nama,
                    price: selectedProduct.harga,
                    imageUrl: selectedProduct.imageUrl || '', // Simpan URL gambar juga
                    quantity: currentQuantity,
                    totalPrice: currentQuantity * selectedProduct.harga,
                    addedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                console.log("Produk berhasil ditambahkan ke keranjang!");
            }

            alert(`${currentQuantity} ${selectedProduct.nama} berhasil ditambahkan ke keranjang!`);
            
            // Beri tahu halaman parent (APL05) untuk memperbarui tampilan keranjang
            if (window.parent) {
                window.parent.postMessage({ type: 'cartUpdated' }, '*');
                console.log("Pesan 'cartUpdated' dikirim ke parent.");
            }

        } catch (error) {
            console.error("❌ Gagal menambahkan produk ke keranjang:", error);
            alert("Gagal menambahkan produk ke keranjang. Coba lagi.");
        }
    }

    // --- Listener untuk pesan dari halaman induk (APL05) ---
    window.addEventListener('message', async (event) => {
        // Hanya proses pesan dari origin yang diharapkan jika memungkinkan,
        // atau gunakan '*' jika origin dinamis/tidak diketahui
        // if (event.origin !== "http://localhost:8000") return; // Ganti dengan origin asli Anda

        console.log("Pesan diterima di detailproduk.html:", event.data);

        if (event.data.type === 'openProductDetail' && event.data.productId) {
            const productId = event.data.productId;
            await loadProductDetails(productId);
            // Beri tahu parent bahwa detail produk berhasil dimuat
            if (window.parent) {
                window.parent.postMessage({ type: 'productDetailLoaded' }, '*');
            }
        } else if (event.data.type === 'receiveAuthData' && event.data.uid) {
            currentUserId = event.data.uid;
            console.log("User ID diterima:", currentUserId);
        }
    });

    // --- Event Listener untuk tombol "Tambah ke Keranjang" ---
    addToCartButton.addEventListener('click', addToCart);

    // --- Fungsi untuk kembali ke halaman sebelumnya (APL05) ---
    function goBack() {
        // Mengirim pesan ke parent untuk menutup popup
        if (window.parent) {
            window.parent.postMessage({ type: 'closePopup' }, '*');
        }
    }

    // --- Inisialisasi: Minta data dari parent setelah DOMContentLoaded ---
    document.addEventListener('DOMContentLoaded', () => {
        // Minta data autentikasi (UID) dari parent
        if (window.parent) {
            window.parent.postMessage({ type: 'requestAuthData' }, '*');
            console.log("Meminta data autentikasi dari parent.");
        }
        // Jika detailproduk.html dibuka langsung (bukan dari iframe),
        // atau jika pesan 'openProductDetail' tidak terkirim tepat waktu,
        // Anda mungkin perlu logika fallback di sini (misal: ambil productId dari URL)
        // Untuk saat ini, kita mengandalkan postMessage.
    });

</script>
</body>
</html>
