<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
<script>
    // 1. Konfigurasi Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCeqHW_m9kru2vmEDVSoelZ3UWFD4k4Xqc",
      authDomain: "tokobuahkasir.firebaseapp.com",
      projectId: "tokobuahkasir",
      storageBucket: "tokobuahkasir.appspot.com",
      messagingSenderId: "731011133713",
      appId: "1:731011133713:web:4247ae627401a01b8c1cb0"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // 2. Utilitas format uang
    function formatCurrency(amount) {
      return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR' }).format(amount);
    }

    // 3. Fungsi tampilkan data buah
    function loadFruits() {
      db.collection("buah").orderBy("nama").get().then(snapshot => {
        const fruitList = document.getElementById("fruitList");
        fruitList.innerHTML = '';
        if (snapshot.empty) {
          fruitList.innerHTML = '<tr><td colspan="4" style="text-align:center;">Belum ada data</td></tr>';
        } else {
          snapshot.forEach(doc => {
            const d = doc.data();
            fruitList.innerHTML += `
              <tr class="border-b border-gray-100">
                <td class="px-2 py-1 text-xs">${d.nama}</td>
                <td class="px-2 py-1 text-xs">${formatCurrency(d.harga)}</td>
                <td class="px-2 py-1 text-xs">${d.stok} kg</td>
                <td class="px-2 py-1 text-xs">
                  <button onclick="editFruit('${doc.id}')" class="btn btn-secondary mb-1 text-[10px] py-0.5 px-1">Edit</button>
                  <button onclick="deleteFruit('${doc.id}')" class="btn btn-primary text-[10px] py-0.5 px-1">Hapus</button>
                </td>
              </tr>`;
          });
        }
      });
    }

    // 4. Fungsi edit data buah
    function editFruit(id) {
      db.collection("buah").doc(id).get().then(doc => {
        const d = doc.data();
        fruitName.value = d.nama;
        fruitPrice.value = d.harga;
        fruitStock.value = d.stok;
        fruitForm.dataset.editId = id;
      });
    }

    // 5. Fungsi hapus buah
    function deleteFruit(id) {
      if (confirm("Hapus buah ini?")) {
        db.collection("buah").doc(id).delete().then(loadFruits);
      }
    }

    // 6. Simpan form tambah/edit buah
    document.getElementById("fruitForm").addEventListener("submit", e => {
      e.preventDefault();
      const nama = fruitName.value;
      const harga = parseInt(fruitPrice.value);
      const stok = parseInt(fruitStock.value);
      const docId = fruitForm.dataset.editId;
      const ref = docId ? db.collection("buah").doc(docId) : db.collection("buah");
      const data = { nama, harga, stok };
      (docId ? ref.update(data) : ref.add(data)).then(() => {
        fruitForm.reset();
        delete fruitForm.dataset.editId;
        loadFruits();
      });
    });

    // 7. === NOTIFIKASI PESANAN ===
    const sound = document.getElementById("notifSound");
    let terakhirDitampilkan = ""; 

    // âœ… Aktifkan suara setelah klik pertama (agar tidak diblokir browser)
    let audioSudahDiizinkan = false;
    document.addEventListener("click", () => {
      if (!audioSudahDiizinkan) {
        sound.play().catch(() => {});
        sound.pause();
        sound.currentTime = 0;
        audioSudahDiizinkan = true;
      }
    });

    // Function untuk menampilkan popup pesanan
    function tampilkanPopupPesanan(data) {
        const items = data.items || [];
        let isi = "";
        let total = 0;
        items.forEach(item => {
            const subtotal = item.harga * item.jumlah;
            total += subtotal;
            isi += `<div><strong>${item.nama}</strong> (${item.jumlah} x Rp ${item.harga.toLocaleString()})<br><small>${item.sambal}, ${item.ukuran}, ${item.bumbu}</small><br><strong>Subtotal: Rp ${subtotal.toLocaleString()}</strong></div><hr>`;
        });
        isi += `<strong>Total: Rp ${total.toLocaleString()}</strong>`;
        document.getElementById("popupIsiPesanan").innerHTML = isi;
        document.getElementById("popupPesanan").style.display = "flex"; 

        // Memutar suara notifikasi jika belum berbunyi
        if (sound.paused && audioSudahDiizinkan) { 
            sound.play().catch(error => console.log("Gagal memutar suara:", error));
        }
    }

    // Function untuk menutup popup
    function tutupPopup() {
        document.getElementById("popupPesanan").style.display = "none"; 
        sound.pause(); 
        sound.currentTime = 0; 
        document.getElementById("notifLonceng").classList.remove("berkedip-kuat");
        document.getElementById("navPesanan").classList.remove("berkedip-kuat");
    }

    // Function untuk menutup popup dan navigasi ke halaman pesanan
    function tutupDanKePesanan() {
        tutupPopup(); 
        window.location.href = "pesanan.html"; // Navigasi ke pesanan.html
    }
    
    // NEW: Menggunakan onSnapshot untuk real-time listener pada pesanan yang belum dilihat
    let unsubscribePesananBaruListener = null; // Untuk menyimpan fungsi unsubscribe

    function mulaiCekPesananBaruRealtime() {
        // Batalkan listener sebelumnya jika ada
        if (unsubscribePesananBaruListener) {
            unsubscribePesananBaruListener();
            console.log("Unsubscribed dari listener pesanan baru sebelumnya.");
        }

        // Dapatkan hanya pesanan yang "isViewed" adalah false
        unsubscribePesananBaruListener = db.collection("pesanan")
            .where('isViewed', '==', false) // Filter untuk pesanan yang belum dilihat
            .orderBy("waktu", "desc")
            .onSnapshot(snapshot => { // Menggunakan onSnapshot untuk real-time updates
                if (!snapshot.empty) {
                    const doc = snapshot.docs[0]; // Ambil pesanan terbaru yang belum dilihat
                    const data = doc.data();
                    
                    // Pastikan ini adalah pesanan yang benar-benar belum dilihat dan belum ditampilkan di popup
                    if (!data.isViewed && doc.id !== terakhirDitampilkan) {
                        terakhirDitampilkan = doc.id; // Tandai ID pesanan ini sebagai yang terakhir ditampilkan

                        // Tampilkan popup dan putar suara
                        tampilkanPopupPesanan(data);
                        document.getElementById("notifLonceng").classList.add("berkedip-kuat");
                        document.getElementById("navPesanan").classList.add("berkedip-kuat");
                    } else if (data.isViewed) {
                        // Jika pesanan yang dideteksi onSnapshot ternyata sudah ditandai dilihat (oleh halaman pesanan.html)
                        // Pastikan notifikasi mati
                        tutupPopup(); 
                    }
                } else {
                    // Tidak ada pesanan baru yang belum dilihat
                    tutupPopup(); // Pastikan popup dan suara mati
                }
            }, error => { // Error handler untuk onSnapshot
                console.error("Error listening for new orders:", error);
                tutupPopup(); // Matikan notifikasi jika ada error
            });
    }

    // 8. Jalankan saat halaman selesai dimuat
    window.addEventListener("DOMContentLoaded", () => {
        loadFruits();
        mulaiCekPesananBaruRealtime(); // Panggil fungsi baru ini

        // Event listener untuk tombol navigasi pesanan agar mematikan kedipan
        document.getElementById("navPesanan").addEventListener("click", function () {
            this.classList.remove("berkedip-kuat");
        });
    });
</script>
