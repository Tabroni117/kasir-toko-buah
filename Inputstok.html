<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Login - Rujak Buah Indonesia</title>

  <!-- Google Fonts: Inter -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />

  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Font Awesome CDN -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
  />

  <style>
    :root {
      --primary: #16a34a;
      --primary-light: #22c55e;
      --primary-dark: #15803d;
      --white: #ffffff;
    }
    * {
      font-family: 'Inter', sans-serif;
    }
    .btn {
      font-size: 14px;
      padding: 10px 16px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
    }
    .btn-primary {
      background: var(--primary);
      color: white;
    }
    .btn-secondary {
      background: white;
      color: var(--primary);
      border: 1px solid var(--primary);
    }
    .form-group {
      margin-bottom: 12px;
    }
    .form-input {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid rgba(16, 181, 129, 0.3);
      border-radius: 10px;
      background: #f8fafc;
      font-size: 16px;
      margin-top: 8px;
      -webkit-appearance: none;
      min-height: 48px;
    }
    body {
      padding-bottom: 60px;
      background: #f8fafc;
      color: #1e293b;
      padding: 0;
      overflow-x: hidden;
      width: 100%;
    }

    .container {
      width: 100%;
      margin: 0 auto;
      background: white;
      padding: 16px;
      border-radius: 16px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      margin-top: 120px;
      padding: 20px;
    }

    .custom-header {
      background: linear-gradient(135deg, #00C853, #64DD17);
    }


.app-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--white);
      display: flex;
      justify-content: space-around;
      padding: 0.5rem 0;
      box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
      z-index: 100;
    }
 .nav-btn {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  color: var(--primary);
  text-decoration: none;
  font-size: 0.75rem !important;
  padding: 0.5rem !important;
  border-radius: 0.5rem;
  width: 100%;
  font-weight: 500;
  background-color: transparent !important;
}

.nav-btn i {
  font-size: 1.25rem !important;
  margin-bottom: 0.15rem !important;
  line-height: 1 !important;
}

.nav-btn span {
  font-size: 0.7rem !important;
  line-height: 1 !important;

    }
    .nav-btn.active {
      font-weight: 600;
      background: transparent;
      box-shadow: none;
    }



.berkedip-kuat {
  animation: kedip 0.8s infinite alternate;
}
@keyframes kedip {
  from { opacity: 1; }
  to { opacity: 0.2; }
}

  </style>
</head>
<body class="bg-green-50 min-h-screen flex flex-col" style="padding-bottom: 60px;">

  <!-- Header -->
  <header class="text-white p-4 rounded-b-xl shadow-md fixed top-0 left-0 right-0 z-50 custom-header">
    <div class="px-4 mx-auto flex items-center justify-between w-full">
      <div class="flex items-center gap-3">
        <i class="fas fa-leaf text-2xl"></i>
        <div>
          <h1 class="font-bold text-lg">RUJAK BUAH INDONESIA</h1>
          <p class="text-sm">Aplikasi Kasir Premium</p>
        </div>
      </div>
      <button onclick="window.location.href='dashboard.html'" class="bg-white text-green-600 px-3 py-1 rounded-lg hover:bg-gray-100 text-sm">
        <i class="fas fa-arrow-left mr-1"></i> Kembali
      </button>
    </div>
  </header>

  <!-- Main Content -->
  <main class="flex-1 px-3">
    <div class="container mx-auto">
      <div class="header-top mt-8 mb-6 gap-6 flex items-center">
        <button onclick="window.location.href='dashboard.html'" class="btn btn-secondary mr-4"><i class="fas fa-arrow-left"></i> Dashboard</button>
        <button onclick="loadFruits()" class="btn btn-primary mr-4"><i class="fas fa-sync-alt"></i> Refresh</button>
        <i id="notifLonceng" class="fa-solid fa-bell ml-auto mr-2" style="font-size: 22px; color: #16a34a;"></i>
      </div>
      <div class="judul mt-6"><i class="fas fa-leaf"></i> RUJAK BUAH INDONESIA</div>

     <!-- Form Input Fixed -->
<div class="sticky top-[90px] z-40 bg-white shadow-md rounded-xl p-4 mb-4">
  <form id="fruitForm" class="grid grid-cols-1 md:grid-cols-3 gap-4">
    <div>
      <label class="block text-sm font-medium text-gray-700">Nama Buah</label>
      <input type="text" id="fruitName" class="form-input mt-1" required />
    </div>
    <div>
      <label class="block text-sm font-medium text-gray-700">Harga (Rp)</label>
      <input type="number" id="fruitPrice" class="form-input mt-1" required />
    </div>
    <div>
      <label class="block text-sm font-medium text-gray-700">Stok (kg)</label>
      <input type="number" id="fruitStock" class="form-input mt-1" required />
    </div>
    <div class="col-span-1 md:col-span-3 flex gap-2 pt-2">
      <button type="submit" class="btn btn-primary flex-1"><i class="fas fa-save mr-1"></i> Simpan</button>
      <button type="reset" class="btn btn-secondary flex-1"><i class="fas fa-redo mr-1"></i> Reset</button>
    </div>
  </form>
</div>

     <div class="overflow-x-auto mt-6 pt-4">
        <table class="w-full min-w-max">
          <thead>
            <tr class="text-left bg-green-100">
              <th class="px-1 py-1 text-[10px] font-medium text-green-800">Nama</th>
              <th class="px-1 py-1 text-[10px] font-medium text-green-800">Harga</th>
              <th class="px-1 py-1 text-[10px] font-medium text-green-800">Stok</th>
              <th class="px-1 py-1 text-[10px] font-medium text-green-800">Aksi</th>
            </tr>
          </thead>
        <tbody id="fruitList"></tbody>
      </table>
    </div>
  </main>

  <!-- Modal Login -->
  <div id="authModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
    <div class="bg-white rounded-2xl shadow-xl w-full max-w-md">
      <div class="bg-green-500 p-6 text-white flex justify-between items-center">
        <h2 class="text-xl font-semibold">
          <i class="fas fa-lock mr-2"></i><span id="authRoleTitle">Pembeli</span> Authentication
        </h2>
        <button onclick="closeAuthModal()" class="text-white hover:text-green-200">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="p-6">
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">
            <i class="fas fa-user mr-2 text-green-500"></i>Login User
          </label>
          <input type="text" id="authUsername" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-green-500 outline-none" placeholder="Masukkan Username">
        </div>
        <div class="mb-6">
          <label class="block text-sm font-medium text-gray-700 mb-2">
            <i class="fas fa-lock mr-2 text-green-500"></i>Password
          </label>
          <input type="password" id="authPassword" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-green-500 outline-none" placeholder="Masukkan Password">
        </div>
        <button id="authSubmitBtn" class="w-full py-3 rounded-lg bg-green-500 hover:bg-green-600 text-white font-medium flex items-center justify-center">
          <i class="fas fa-sign-in-alt mr-2"></i>Login
        </button>
      </div>
    </div>
  </div>

  <div id="popupPesanan" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4 shadow-xl">
      <h3 class="text-xl font-bold text-green-600 mb-4 flex items-center">
        <i class="fas fa-bell mr-2"></i> Pesanan Baru Masuk!
      </h3>
      <div id="popupIsiPesanan" class="max-h-60 overflow-y-auto mb-4"></div>
      <div class="flex gap-3">
        <button onclick="tutupDanKePesanan()" 
  class="flex-1 bg-green-600 hover:bg-green-700 text-white py-2 rounded-lg">
  Lihat Pesanan
</button>
        <button onclick="tutupPopup()" 
          class="flex-1 border border-gray-300 hover:bg-gray-100 py-2 rounded-lg">
          Tutup
        </button>
      </div>
    </div>
  </div>

  <audio id="notifSound" src="https://raw.githubusercontent.com/Tabroni117/kasir-toko-buah/main/notifikasi.mp3" preload="auto" loop></audio>



 <nav class="app-nav !p-2 !bg-white !shadow-md">
    <a href="apl05.html" class="nav-btn"><i class="fas fa-home"></i><span>Beranda</span></a>
    <a href="Inputstok" class="nav-btn"><i class="fas fa-boxes"></i><span>Inventori</span></a>
    <a href="pesanan.html" id="navPesanan" class="nav-btn active"><i class="fas fa-receipt"></i><span>Pesanan</span></a>
    <a href="akun.html" class="nav-btn"><i class="fas fa-user"></i><span>Profil</span></a>
  </nav>

  <!-- Script Inventory -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <script>
    // 1. Konfigurasi Firebase
   const firebaseConfig = {
            apiKey: "AIzaSyCeqHW_m9kru2vmEDVSoelZ3UWFD4k4Xqc",
            authDomain: "tokobuahkasir.firebaseapp.com",
            projectId: "tokobuahkasir",
            storageBucket: "tokobuahkasir.appspot.com",
            messagingSenderId: "731011133713",
            appId: "1:731011133713:web:4247ae627401a01b8c1cb0"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Elemen-elemen yang dibutuhkan
        const daftar = document.getElementById("daftarPesanan");
        const totalOrdersEl = document.getElementById("totalOrders");
        const todayIncomeEl = document.getElementById("todayIncome");
        const avgOrderEl = document.getElementById("avgOrder");
        const lastOrderEl = document.getElementById("lastOrder");
        const loadingSpinner = document.getElementById("loadingSpinner");
        const filterButtons = document.querySelectorAll('.filter-btn');

        let currentOrderIdForDetail = null; // Digunakan untuk popup detail
        let activeFilterStatus = 'All'; // Default filter

        // --- Fungsi Loading Spinner ---
        function showLoading() { loadingSpinner.style.display = 'flex'; }
        function hideLoading() { loadingSpinner.style.display = 'none'; }

        // --- Utilitas Format ---
        function formatCurrency(val) {
            if (isNaN(val) || val === null || typeof val === 'undefined') {
                return "Rp0";
            }
            return new Intl.NumberFormat("id-ID", { style: "currency", currency: "IDR" }).format(val);
        }
        function formatDate(date) {
            if (!date) return "-";
            const d = (date instanceof firebase.firestore.Timestamp) ? date.toDate() : new Date(date);
            if (isNaN(d.getTime())) return "-";
            return d.toLocaleString("id-ID", { day: "numeric", month: "short", hour: "2-digit", minute: "2-digit" });
        }
        function getStatusClass(status) {
            switch (status?.toLowerCase()) {
                case 'pending': return 'pending';
                case 'diproses': return 'diproses';
                case 'selesai': return 'selesai';
                case 'dibatalkan': return 'dibatalkan';
                default: return '';
            }
        }

        // --- Fungsi Utama: Muat Data Pesanan ---
        function loadData(statusFilter = activeFilterStatus) {
            showLoading();
            daftar.innerHTML = "<p style='text-align:center;'>Memuat data pesanan...</p>";
            
            // Update active filter button
            filterButtons.forEach(btn => {
                if (btn.dataset.status === statusFilter) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            activeFilterStatus = statusFilter; // Set active filter

            let query = db.collection("pesanan").orderBy("waktu", "desc");

            if (statusFilter !== 'All') {
                query = query.where('status', '==', statusFilter);
            }

            query.get()
                .then(snapshot => {
                    hideLoading();

                    let totalIncomeAllTime = 0;
                    let totalOrderCount = 0;
                    let todayIncome = 0;
                    const now = new Date(); 
                    now.setHours(0, 0, 0, 0); 

                    daftar.innerHTML = ""; 

                    let firstOrderTime = null; 

                    if (snapshot.empty) {
                        daftar.innerHTML = "<p style='text-align:center;'>Belum ada pesanan masuk dengan status ini.</p>";
                    } else {
                        snapshot.forEach(doc => {
                            const data = doc.data();
                            const orderId = doc.id; 
                            
                            const waktu = data.waktu && data.waktu.toDate ? data.waktu.toDate() : new Date(0);
                            
                            if (isNaN(waktu.getTime())) {
                                console.warn("Invalid timestamp found for order:", orderId, data.waktu);
                                return; 
                            }

                            if (!firstOrderTime) firstOrderTime = waktu; 

                            const isToday = waktu.toDateString() === now.toDateString();
                            const totalHarga = data.totalAmount || 0; 

                            if (isToday) todayIncome += totalHarga;
                            totalIncomeAllTime += totalHarga;
                            totalOrderCount++;

                            const customerName = data.customer?.fullName || "Pelanggan";
                            const customerPhone = data.customer?.phoneNumber || "-";
                            const currentStatus = data.status || "Pending";

                            const itemsHtml = (data.items || []).map(item => {
                                const itemTotalPrice = (item.price || 0) * (item.quantity || 0);
                                return `
                                    <div style="margin-bottom: 5px;">
                                        🍉 ${item.name || 'Produk Tidak Dikenal'} (${item.quantity || 0} x Rp${(item.price || 0).toLocaleString("id-ID")}) = Rp ${itemTotalPrice.toLocaleString("id-ID")}
                                    </div>
                                `;
                            }).join("");

                            daftar.innerHTML += `
                                <div class='order-item-upgrade animate-slidein' onclick='tampilkanDetail("${orderId}")'>
                                    <div class='order-row-top'>
                                        <div class='customer'>
                                            <div class='avatar'>${customerName[0]?.toUpperCase() || "P"}</div>
                                            <div class='info'>
                                                <div class='name'>${customerName}</div>
                                                <div class='phone'>${customerPhone}</div>
                                            </div>
                                        </div>
                                        <div class='meta'>
                                            <div class='total'>${formatCurrency(totalHarga)}</div>
                                            <div class='status ${getStatusClass(currentStatus)}'>${currentStatus}</div>
                                        </div>
                                    </div>
                                    <div class='order-row-bottom'>
                                        <div class='time'><i class='fas fa-clock'></i><span>${formatDate(waktu)}</span></div>
                                        <div class='items'>${itemsHtml}</div>
                                    </div>
                                </div>
                            `;
                        });
                    }

                    // Update statistik berdasarkan SEMUA pesanan yang diambil oleh query aktif
                    totalOrdersEl.textContent = totalOrderCount;
                    todayIncomeEl.textContent = formatCurrency(todayIncome);
                    avgOrderEl.textContent = formatCurrency(totalIncomeAllTime / Math.max(1, totalOrderCount)); 
                    lastOrderEl.textContent = firstOrderTime ? formatDate(firstOrderTime) : "-";

                })
                .catch(err => {
                    hideLoading();
                    daftar.innerHTML = `<p style='text-align:center; color:red;'>Gagal memuat data: ${err.message}. Pastikan Firebase Rules dan Indeks Firestore Anda sudah benar.</p>`;
                    console.error("Error loading orders from Firestore:", err); 
                });
        }

        // --- Fungsi Popup Detail Pesanan ---
        function tampilkanDetail(orderId) {
            currentOrderIdForDetail = orderId;
            db.collection("pesanan").doc(orderId).get()
                .then(doc => {
                    if (doc.exists) {
                        const data = doc.data();
                        const customer = data.customer || {};
                        const waktu = data.waktu?.toDate?.() || new Date(0); 
                        const items = data.items || [];
                        
                        document.getElementById("popupNama").textContent = customer.fullName || "Pelanggan";
                        document.getElementById("popupNomor").textContent = customer.phoneNumber || "-";
                        document.getElementById("popupAlamat").textContent = customer.address || "-";
                        document.getElementById("popupTotal").textContent = formatCurrency(data.totalAmount || 0);
                        document.getElementById("popupMetodeBayar").textContent = data.paymentMethod || "-";
                        document.getElementById("popupCatatan").textContent = customer.notes || "Tidak ada catatan";
                        
                        const popupStatusEl = document.getElementById("popupStatus");
                        const currentStatus = data.status || "Pending";
                        popupStatusEl.textContent = currentStatus;
                        popupStatusEl.className = `status ${getStatusClass(currentStatus)}`;
                        
                        const statusUpdater = document.getElementById("statusUpdater");
                        statusUpdater.value = currentStatus;
                        
                        document.getElementById("popupWaktu").textContent = formatDate(waktu);

                        const popupItemsHtml = items.map(item => {
                            const itemTotalPrice = (item.price || 0) * (item.quantity || 0);
                            return `
                                <div style="margin-bottom:5px;">
                                    - ${item.name || 'Produk Tidak Dikenal'} (${item.quantity || 0} x Rp${(item.price || 0).toLocaleString("id-ID")}) = Rp ${itemTotalPrice.toLocaleString("id-ID")}
                                </div>
                            `;
                        }).join("");
                        document.getElementById("popupItems").innerHTML = popupItemsHtml;

                        document.getElementById("popupDetail").style.display = "flex"; 
                    } else {
                        alert("Pesanan tidak ditemukan di database.");
                    }
                })
                .catch(error => {
                    console.error("Error getting order detail from Firestore:", error);
                    alert("Gagal memuat detail pesanan. Silakan periksa koneksi internet atau konsol browser.");
                });
        }

        function tutupDetail() {
            document.getElementById("popupDetail").style.display = "none";
            currentOrderIdForDetail = null; 
            loadData(); // Refresh data setelah menutup detail, untuk melihat status terbaru
        }

        // --- Fungsi Update Status Pesanan ---
        document.getElementById("statusUpdater").addEventListener("change", function() {
            const newStatus = this.value;
            if (currentOrderIdForDetail && confirm(`Ubah status pesanan ini menjadi "${newStatus}"?`)) {
                db.collection("pesanan").doc(currentOrderIdForDetail).update({
                    status: newStatus
                }).then(() => {
                    alert("Status pesanan berhasil diperbarui!");
                    tutupDetail(); // Tutup detail dan loadData akan dipanggil oleh tutupDetail
                }).catch(error => {
                    console.error("Error updating order status:", error);
                    alert("Gagal memperbarui status pesanan.");
                });
            }
        });

        // --- Event Listeners untuk Tombol Filter ---
        filterButtons.forEach(button => {
            button.addEventListener('click', () => {
                const status = button.dataset.status;
                loadData(status); // Call loadData with the selected filter status
            });
        });

        // --- LOGIKA NOTIFIKASI SUARA & POPUP BARU (Perbaikan) ---
        const sound = document.getElementById("notifSound");
        let terakhirDitampilkan = localStorage.getItem("terakhirNotifOrderId") || ""; // Persist ID notif terakhir
        let sedangBerbunyi = false; // Flag untuk mengontrol suara

        // Aktifkan suara setelah klik pertama (agar tidak diblokir browser)
        let audioSudahDiizinkan = false;
        document.addEventListener("click", () => {
            if (!audioSudahDiizinkan) {
                sound.play().catch(() => {}); // Play and catch error if not allowed
                sound.pause();
                sound.currentTime = 0;
                audioSudahDiizinkan = true;
                console.log("Audio diizinkan setelah interaksi pengguna.");
            }
        }, { once: true }); // Hanya perlu sekali

        function tampilkanPopupPesanan(data) {
            const items = data.items || [];
            let isi = "";
            let total = 0;
            items.forEach(item => {
                const subtotal = (item.harga || 0) * (item.jumlah || 0);
                total += subtotal;
                isi += `<div><strong>${item.name || 'Produk Tidak Dikenal'}</strong> (${item.quantity || 0} x Rp ${item.price?.toLocaleString() || '0'})<br><small>${item.sambal || ''}, ${item.ukuran || ''}, ${item.bumbu || ''}</small><br><strong>Subtotal: Rp ${subtotal.toLocaleString()}</strong></div><hr>`;
            });
            isi += `<strong>Total: Rp ${total.toLocaleString()}</strong>`;
            document.getElementById("popupIsiPesanan").innerHTML = isi;
            document.getElementById("popupPesanan").style.display = "flex";
            document.getElementById("popupPesanan").classList.remove("hidden"); // Pastikan kelas hidden dihapus
        }

        function tutupPopup() {
            document.getElementById("popupPesanan").classList.add("hidden");
            
            sound.pause();
            sound.currentTime = 0;
            sedangBerbunyi = false; // Reset flag sedang berbunyi

            // Simpan waktu terakhir popup ditutup/dibaca DAN ID pesanan terakhir yang dilihat
            localStorage.setItem("pesananSudahDibuka", new Date().toISOString());
            localStorage.setItem("terakhirNotifOrderId", terakhirDitampilkan); 

            document.getElementById("notifLonceng").classList.remove("berkedip-kuat");
            document.getElementById("navPesanan").classList.remove("berkedip-kuat"); 
        }

        function tutupDanKePesanan() {
            tutupPopup(); // Reuse the logic to close popup and stop sound/animation
            window.location.href = "pesanan.html"; // Pastikan ini mengarah ke halaman daftar pesanan
        }

        function cekPesananBaru() {
            db.collection("pesanan").orderBy("waktu", "desc").limit(1).get().then(snapshot => {
                if (!snapshot.empty) {
                    const doc = snapshot.docs[0];
                    const data = doc.data();
                    const waktuPesanan = data.waktu?.toDate?.() || new Date();
                    const waktuBukaTerakhir = new Date(localStorage.getItem("pesananSudahDibuka") || 0);

                    // Cek apakah ada pesanan baru yang benar-benar berbeda dari yang terakhir kita tampilkan
                    // DAN apakah waktu pesanan lebih baru dari terakhir kali kita "membuka" notifikasi
                    if (doc.id !== terakhirDitampilkan && waktuPesanan > waktuBukaTerakhir) {
                        terakhirDitampilkan = doc.id; // Update ID terakhir yang ditampilkan notifnya
                        localStorage.setItem("terakhirNotifOrderId", terakhirDitampilkan); // Simpan ke localStorage
                        
                        // Hanya putar suara jika belum berbunyi
                        if (!sedangBerbunyi) {
                            sound.play().catch(error => console.warn("Gagal memutar suara:", error));
                            sedangBerbunyi = true; // Set flag sedang berbunyi
                        }
                        
                        tampilkanPopupPesanan(data);

                        document.getElementById("notifLonceng").classList.add("berkedip-kuat");
                        document.getElementById("navPesanan").classList.add("berkedip-kuat");
                    } else {
                        // Jika pesanan yang dicek SAMA dengan yang terakhir ditampilkan DAN/ATAU sudah tidak lebih baru
                        // Pastikan semua indikator notifikasi mati jika popup tidak terlihat
                        if (document.getElementById("popupPesanan").classList.contains("hidden")) {
                            sound.pause();
                            sound.currentTime = 0;
                            sedangBerbunyi = false;
                            document.getElementById("notifLonceng").classList.remove("berkedip-kuat");
                            document.getElementById("navPesanan").classList.remove("berkedip-kuat");
                        }
                    }
                } else {
                    // Jika tidak ada pesanan sama sekali, pastikan notifikasi mati
                    sound.pause();
                    sound.currentTime = 0;
                    sedangBerbunyi = false;
                    document.getElementById("notifLonceng").classList.remove("berkedip-kuat");
                    document.getElementById("navPesanan").classList.remove("berkedip-kuat");
                }
            }).catch(error => {
                console.error("Error fetching latest order:", error);
                // Optional: Anda bisa juga mematikan suara dan kedip jika ada error Firebase
                sound.pause();
                sound.currentTime = 0;
                sedangBerbunyi = false;
                document.getElementById("notifLonceng").classList.remove("berkedip-kuat");
                document.getElementById("navPesanan").classList.remove("berkedip-kuat");
            });
        }

        // --- Jalankan saat halaman selesai dimuat ---
        window.addEventListener("DOMContentLoaded", () => {
            loadData('All'); // Memuat semua pesanan saat halaman dimuat
            cekPesananBaru(); // Cek pesanan baru pertama kali
            setInterval(cekPesananBaru, 2200); // Lakukan pengecekan setiap 2.2 detik

            // Event listener untuk tombol navigasi "Pesanan"
            document.getElementById("navPesanan").addEventListener("click", function () {
                // Ketika navigasi ke Pesanan diklik, anggap notifikasi sudah dilihat
                this.classList.remove("berkedip-kuat");
                document.getElementById("notifLonceng").classList.remove("berkedip-kuat");
                sound.pause();
                sound.currentTime = 0;
                sedangBerbunyi = false;
                // Penting: Update localStorage agar tidak berbunyi lagi untuk pesanan ini
                localStorage.setItem("pesananSudahDibuka", new Date().toISOString());
                localStorage.setItem("terakhirNotifOrderId", terakhirDitampilkan); 
            });

            // Event listener untuk tombol lonceng notifikasi (di header)
            document.getElementById("notifLonceng").addEventListener("click", function() {
                // Ketika lonceng diklik, cek dan tampilkan popup jika ada pesanan baru
                // Ini akan memicu cekPesananBaru lagi, yang akan menampilkan popup jika kondisi terpenuhi
                cekPesananBaru(); 
            });

            // Tambahkan listener untuk menutup popup dengan ESC
            document.addEventListener("keydown", function(event) {
                if (event.key === "Escape" && document.getElementById("popupPesanan").style.display === "flex") {
                    tutupPopup();
                }
            });

            // Fungsi dummy untuk closeAuthModal dan input fruit (dari halaman lain)
            // Ini agar tidak error jika tidak ada di halaman ini
            window.closeAuthModal = function() {
                document.getElementById('authModal').classList.add('hidden');
            };
            // Pastikan elemen-elemen ini ada jika fungsi ini dipanggil
            const fruitName = document.getElementById('fruitName'); 
            const fruitPrice = document.getElementById('fruitPrice');
            const fruitStock = document.getElementById('fruitStock');
            const fruitForm = document.getElementById('fruitForm');

            // Fungsi dummy untuk loadFruits, editFruit, deleteFruit jika tidak ada di halaman ini
            window.loadFruits = function() { console.log('loadFruits dummy called'); };
            window.editFruit = function(id) { console.log('editFruit dummy called for:', id); };
            window.deleteFruit = function(id) { console.log('deleteFruit dummy called for:', id); };
            
            // Event listener untuk form buah (jika ada di halaman ini)
            if (fruitForm) {
                fruitForm.addEventListener("submit", e => {
                    e.preventDefault();
                    const nama = fruitName.value;
                    const harga = parseInt(fruitPrice.value);
                    const stok = parseInt(fruitStock.value);
                    const docId = fruitForm.dataset.editId;
                    const ref = docId ? db.collection("buah").doc(docId) : db.collection("buah");
                    const data = { nama, harga, stok };
                    (docId ? ref.update(data) : ref.add(data)).then(() => {
                        fruitForm.reset();
                        delete fruitForm.dataset.editId;
                        loadFruits();
                    }).catch(error => console.error("Error saving fruit:", error));
                });
            }
        });
    </script>
</body>
</html>
